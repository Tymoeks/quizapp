<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizApp 2.5 - Twórz i rozwiązuj quizy oraz fiszki</title>
    
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2C3E50;
            --secondary: #7F8C8D;
            --accent: #3498DB;
            --success: #27AE60;
            --danger: #E74C3C;
            --warning: #F39C12;
            --background: #ECF0F1;
            --surface: #FFFFFF;
            --surface-alt: #F8F9FA;
            --border: #D5DBDB;
            --text: #2C3E50;
            --text-secondary: #7F8C8D;
            --shadow: rgba(0, 0, 0, 0.08);
            --gradient-light: linear-gradient(135deg, #F5F7FA 0%, #ECF0F1 100%);
            --gradient-dark: linear-gradient(135deg, #34495E 0%, #2C3E50 100%);
        }

        [data-theme="dark"] {
            --primary: #ECF0F1;
            --secondary: #BDC3C7;
            --accent: #3498DB;
            --success: #27AE60;
            --danger: #E74C3C;
            --warning: #F39C12;
            --background: #1a1a1a;
            --surface: #2C3E50;
            --surface-alt: #34495E;
            --border: #4A5568;
            --text: #ECF0F1;
            --text-secondary: #BDC3C7;
            --shadow: rgba(0, 0, 0, 0.3);
            --gradient-light: linear-gradient(135deg, #34495E 0%, #2C3E50 100%);
            --gradient-dark: linear-gradient(135deg, #ECF0F1 0%, #BDC3C7 100%);
        }

        html {
            overflow-x: hidden;
            width: 100%;
            height: 100%;
            position: fixed;
            -webkit-overflow-scrolling: touch;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--background);
            min-height: 100vh;
            height: 100%;
            color: var(--text);
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
            overflow-y: auto;
            transition: background 0.3s ease, color 0.3s ease;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
            -webkit-overflow-scrolling: touch;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(52, 152, 219, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(46, 204, 113, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(155, 89, 182, 0.03) 0%, transparent 50%);
            z-index: -2;
        }

        .bg-decoration {
            position: fixed;
            opacity: 0.03;
            z-index: -1;
            transition: opacity 0.3s ease;
        }

        .bg-square-1 {
            top: 10%;
            left: 5%;
            width: 300px;
            height: 300px;
            background: var(--primary);
            transform: rotate(45deg);
        }

        .bg-square-2 {
            bottom: 10%;
            right: 5%;
            width: 200px;
            height: 200px;
            background: var(--accent);
            transform: rotate(15deg);
        }

        .bg-square-3 {
            top: 50%;
            right: 10%;
            width: 150px;
            height: 150px;
            background: var(--secondary);
            transform: rotate(-20deg);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
            touch-action: pan-y;
        }

        .hidden {
            display: none !important;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: -1px;
            margin-bottom: 8px;
            color: var(--text);
        }

        h2 {
            font-size: 1.75rem;
            font-weight: 400;
            margin-bottom: 24px;
            color: var(--primary);
        }

        h3 {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--primary);
        }

        p {
            color: var(--text-secondary);
        }

        .header {
            text-align: center;
            margin-bottom: 60px;
            position: relative;
            padding: 40px 0;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(52, 152, 219, 0.05) 0%, transparent 70%);
            z-index: -1;
        }

        .header p {
            font-size: 1.125rem;
            margin-top: 8px;
        }

        .header-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 4px var(--shadow);
            transition: all 0.3s ease;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: var(--gradient-light);
            opacity: 0.5;
            transform: translate(30px, -30px) rotate(45deg);
        }

        .card-white {
            background: var(--surface);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--surface-alt);
            color: var(--text);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
            pointer-events: none;
        }

        .btn:active::before {
            width: 500px;
            height: 500px;
            transition: width 0s, height 0s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--gradient-dark);
            color: white;
            border: none;
        }

        .btn-accent {
            background: var(--accent);
            color: white;
            border: none;
        }

        .btn-success {
            background: var(--success);
            color: white;
            border: none;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }

        .search-bar {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--surface-alt);
            color: var(--text);
            transition: all 0.2s ease;
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--surface);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .filter-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface-alt);
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .filter-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .quiz-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .quiz-item {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 24px;
            padding-left: 56px;
            padding-bottom: 60px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .quiz-item.selected {
            border-color: var(--accent);
            background: var(--surface-alt);
        }

        .quiz-checkbox {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            z-index: 10;
            margin: 0;
            cursor: pointer;
        }

        .quiz-item::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--gradient-dark);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
            border-radius: 12px;
        }

        .quiz-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .quiz-item:hover::before {
            opacity: 0.1;
        }

        .quiz-item h3 {
            margin-bottom: 8px;
        }

        .quiz-item p {
            font-size: 14px;
        }

        .quiz-date {
            position: absolute;
            bottom: 16px;
            right: 16px;
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .quiz-actions {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .quiz-item:hover .quiz-actions {
            opacity: 1;
        }

        .quiz-item.selection-mode .quiz-actions {
            display: none;
        }

        .quiz-actions button {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--surface);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .quiz-actions button:hover {
            background: var(--surface-alt);
            border-color: var(--primary);
        }

        .quiz-stats-badge {
            position: absolute;
            bottom: 16px;
            left: 16px;
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--surface-alt);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .quiz-type-icon {
            position: absolute;
            top: 16px;
            left: 16px;
            font-size: 24px;
            opacity: 0.8;
        }

        .quiz-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .tag {
            font-size: 11px;
            padding: 3px 8px;
            background: var(--accent);
            color: white;
            border-radius: 12px;
            opacity: 0.8;
        }

        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--primary);
        }

        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--surface-alt);
            color: var(--text);
            transition: all 0.2s ease;
            font-family: inherit;
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        .form-group textarea {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            resize: vertical;
            min-height: 200px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--surface);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--surface-alt);
            min-height: 44px;
            align-items: center;
        }

        .tag-input-container input {
            border: none;
            background: transparent;
            flex: 1;
            min-width: 120px;
            padding: 4px;
            font-size: 14px;
            color: var(--text);
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        .tag-input-container input:focus {
            outline: none;
        }

        .tag-removable {
            background: var(--accent);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tag-removable button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            font-size: 14px;
            line-height: 1;
        }

        .ai-prompt {
            background: var(--gradient-light);
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .ai-prompt::after {
            content: '📝';
            position: absolute;
            bottom: -20px;
            right: -20px;
            font-size: 100px;
            opacity: 0.05;
            transform: rotate(-15deg);
        }

        .ai-prompt h3 {
            font-size: 16px;
            margin-bottom: 16px;
        }

        .ai-prompt pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            font-size: 13px;
            line-height: 1.5;
            color: var(--text-secondary);
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 40px;
            box-shadow: inset 0 1px 2px var(--shadow);
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-dark);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 32px;
            font-size: 14px;
            color: var(--text-secondary);
            background: var(--surface-alt);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .stats span {
            font-weight: 500;
        }

        .streak-indicator {
            position: fixed;
            top: 100px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
            animation: pulse 0.5s ease;
            z-index: 100;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .question-card {
            background: var(--surface);
            padding: 48px;
            border-radius: 16px;
            box-shadow: 0 8px 24px var(--shadow);
            margin-bottom: 32px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .question-card::before,
        .question-card::after {
            content: '';
            position: absolute;
            width: 200px;
            height: 200px;
            background: var(--gradient-light);
            opacity: 0.3;
        }

        .question-card::before {
            top: -100px;
            left: -100px;
            transform: rotate(45deg);
        }

        .question-card::after {
            bottom: -100px;
            right: -100px;
            transform: rotate(45deg);
        }

        .question-card h2 {
            font-weight: 400;
            font-size: 1.5rem;
            line-height: 1.4;
            margin-bottom: 40px;
            margin-top: 0;
            padding-top: 0;
            position: relative;
            z-index: 1;
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        .question-category {
            position: absolute;
            top: 16px;
            left: 16px;
            font-size: 12px;
            color: var(--text-secondary);
            background: var(--surface-alt);
            padding: 6px 12px;
            border-radius: 6px;
            z-index: 1;
        }

        .retry-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 13px;
            color: white;
            background: var(--warning);
            padding: 6px 12px;
            border-radius: 6px;
            z-index: 10;
            font-weight: 600;
        }

        .answers-grid {
            display: grid;
            gap: 12px;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .answers-grid.two-answers {
            grid-template-columns: repeat(2, 1fr);
        }

        .answers-grid.four-answers {
            grid-template-columns: repeat(2, 1fr);
        }

        .answer-btn {
            padding: 20px 24px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--surface-alt);
            color: var(--text);
            text-align: center;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        .answer-btn:hover:not(:disabled) {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
            background: var(--surface);
        }

        .answer-btn:disabled {
            cursor: not-allowed;
        }

        .answer-btn.correct {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .answer-btn.incorrect {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        .answer-letter {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 24px;
            height: 24px;
            background: var(--surface);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .type-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin: 32px 0;
        }

        .type-option {
            background: var(--surface-alt);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-family: inherit;
            display: block;
        }

        .type-option:hover {
            border-color: var(--accent);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .type-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .type-option h3 {
            margin-bottom: 8px;
            color: var(--primary);
        }

        .type-option p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .flashcard-container {
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 40px;
        }

        .flashcard-wrapper {
            perspective: 1000px;
            margin-bottom: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .flashcard {
            width: 100%;
            height: 350px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            cursor: pointer;
            touch-action: manipulation;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-side {
            width: 100%;
            height: 350px;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 16px;
            box-shadow: 0 8px 24px var(--shadow);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 0;
            text-align: center;
            background: var(--surface);
            border: 2px solid var(--border);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            position: relative;
        }

        .flashcard-front {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            transform: rotateY(0deg);
        }

        .flashcard-back {
            position: absolute;
            top: 0;
            left: 0;
            transform: rotateY(180deg);
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface-alt) 100%);
            border-color: var(--accent);
        }

        .flashcard-content {
            font-size: 1.5rem;
            font-weight: 400;
            color: var(--primary);
            word-wrap: break-word;
            overflow-wrap: break-word;
            width: 100%;
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
            -webkit-touch-callout: none;
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
            touch-action: pan-y;
        }

        .flashcard-side::-webkit-scrollbar {
            width: 8px;
        }

        .flashcard-side::-webkit-scrollbar-track {
            background: var(--surface-alt);
            border-radius: 4px;
        }

        .flashcard-side::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .flashcard-side::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        .flashcard-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
            flex-shrink: 0;
            width: 100%;
            max-width: 500px;
        }

        .flashcard-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: center;
            min-width: 0;
        }

        .flashcard-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .btn-hard {
            background: var(--danger);
            color: white;
        }

        .btn-medium {
            background: var(--warning);
            color: white;
        }

        .btn-easy {
            background: var(--success);
            color: white;
        }

        .results-screen {
            text-align: center;
            padding: 48px;
            position: relative;
        }

        .results-screen::before {
            content: '🏆';
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 60px;
            opacity: 0.1;
        }

        .score-display {
            font-size: 3.5rem;
            font-weight: 200;
            margin-bottom: 16px;
            letter-spacing: -2px;
            color: var(--text);
        }

        .points-display {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 40px;
        }

        .time-display {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: var(--surface-alt);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background: var(--border);
        }

        .history-info {
            flex: 1;
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        .history-score {
            font-weight: 600;
            color: var(--accent);
            font-size: 18px;
        }

        .quiz-settings {
            background: var(--surface-alt);
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 32px;
            border: 1px solid var(--border);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }

        .setting-row label {
            font-size: 15px;
            font-weight: 500;
            color: var(--primary);
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .3s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px var(--shadow);
        }

        input:checked + .slider {
            background: var(--accent);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            min-width: 120px;
            transition: all 0.2s ease;
        }

        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 32px;
            flex-wrap: wrap;
        }

        .button-group.center {
            justify-content: center;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--surface);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 3000;
            max-width: 300px;
            opacity: 0;
            transform: translateX(400px);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.info {
            border-left: 4px solid var(--accent);
        }

        .toast.toast-show {
            animation: slideInRight 0.3s ease forwards;
        }

        .toast.toast-hide {
            animation: slideOutRight 0.3s ease forwards;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }

        .animate-shake {
            animation: shake 0.4s ease;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .keyboard-hint {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            box-shadow: 0 2px 8px var(--shadow);
            z-index: 100;
        }

        .kbd {
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 11px;
        }

        .mobile-only {
            display: none;
        }

        .desktop-only {
            display: inline;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        @media (max-width: 768px) {
            .keyboard-hint {
                display: none;
            }

            .mobile-only {
                display: inline;
            }

            .desktop-only {
                display: none;
            }

            .container {
                padding: 20px 15px;
            }

            h1 {
                font-size: 1.75rem;
            }

            h2 {
                font-size: 1.5rem;
            }

            .header {
                margin-bottom: 40px;
                padding: 20px 0;
            }

            .header p {
                font-size: 1rem;
            }

            .header-actions {
                gap: 8px;
            }

            .question-card {
                padding: 24px 16px;
            }

            .question-card h2 {
                font-size: 1.25rem;
                padding-top: 30px;
                margin-top: 0;
            }

            .answers-grid {
                grid-template-columns: 1fr !important;
            }

            .answer-btn {
                min-height: 60px;
                padding: 16px 20px;
                font-size: 15px;
            }

            .quiz-list {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .quiz-item {
                padding: 20px;
                padding-left: 52px;
                padding-bottom: 55px;
            }

            .stats {
                flex-direction: column;
                gap: 8px;
                padding: 12px;
            }
            
            .results-screen .stats {
                flex-direction: row !important;
                flex-wrap: wrap;
            }
            
            .results-screen .stats > div {
                min-width: 30%;
            }

            .search-bar {
                flex-direction: column;
                padding: 16px;
            }

            .search-input {
                width: 100%;
            }

            .filter-group {
                width: 100%;
                justify-content: space-between;
            }

            .filter-btn {
                flex: 1;
            }

            .theme-toggle {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .modal-content {
                padding: 24px 16px;
                margin: 10px;
            }

            .card {
                padding: 24px 16px;
            }

            .btn {
                padding: 14px 20px;
                font-size: 16px;
                min-height: 48px;
                touch-action: manipulation;
            }

            .btn-small {
                padding: 10px 16px;
                min-height: 40px;
            }

            .flashcard {
                height: 300px;
            }

            .flashcard-side {
                height: 300px;
            }

            .flashcard-content {
                font-size: 1.25rem;
                padding: 30px 20px;
            }

            .flashcard-btn {
                font-size: 13px;
                padding: 14px 16px;
                min-height: 48px;
            }

            .score-display {
                font-size: 2.5rem;
            }

            .type-selection {
                grid-template-columns: 1fr;
            }

            .type-option {
                padding: 24px;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group.center {
                flex-direction: column;
            }

            .button-group .btn {
                width: 100%;
            }

            input[type="text"],
            textarea,
            select {
                font-size: 16px;
            }

            .toast {
                left: 10px;
                right: 10px;
                bottom: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle" onclick="toggleTheme()" title="Przełącz motyw" role="button" aria-label="Przełącz motyw ciemny/jasny" tabindex="0">
        <span id="themeIcon" aria-hidden="true">🌙</span>
    </div>

    <!-- Background Decorations -->
    <div class="bg-decoration bg-square-1"></div>
    <div class="bg-decoration bg-square-2"></div>
    <div class="bg-decoration bg-square-3"></div>

    <div class="container">
        <div class="header">
            <h1>QuizApp 2.5 🎉</h1>
            <p>Profesjonalna platforma do tworzenia i rozwiązywania quizów i fiszek</p>
            <div class="header-actions">
                <button class="btn btn-accent btn-small" onclick="showImportModal()">📥 Import</button>
                <button class="btn btn-small" onclick="showBackupModal()">💾 Backup</button>
            </div>
        </div>

        <!-- Home Screen -->
        <div id="homeScreen" class="screen animate-fadeIn">
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" placeholder="🔍 Szukaj quizów..." oninput="filterQuizzes()" aria-label="Wyszukaj quizy">
                <div class="filter-group">
                    <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">Wszystkie</button>
                    <button class="filter-btn" data-filter="quiz" onclick="setFilter('quiz')">📊 Quizy</button>
                    <button class="filter-btn" data-filter="flashcard" onclick="setFilter('flashcard')">🎴 Fiszki</button>
                </div>
            </div>
            <div id="batchActions" class="search-bar" style="display: none; background: var(--surface-alt);">
                <span id="selectedCount" style="font-weight: 500;">0 zaznaczonych</span>
                <div class="filter-group">
                    <button class="btn btn-small btn-danger" onclick="batchDelete()">🗑️ Usuń</button>
                    <button class="btn btn-small" onclick="batchExport()">📤 Eksportuj</button>
                    <button class="btn btn-small" onclick="clearSelection()">✕ Anuluj</button>
                </div>
            </div>
            <div class="quiz-list" id="quizList"></div>
            <div style="text-align: center; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="showChooseTypeScreen()">➕ Utwórz nowy</button>
                <button class="btn" onclick="toggleSelectionMode()" id="selectionModeBtn">☑️ Zaznacz wiele</button>
            </div>
        </div>

        <!-- Choose Type Screen -->
        <div id="chooseTypeScreen" class="screen hidden">
            <div class="card card-white animate-fadeIn">
                <h2>Co chcesz utworzyć?</h2>
                <div class="type-selection">
                    <button class="type-option" onclick="showCreateScreen('quiz')">
                        <div class="type-icon">📊</div>
                        <h3>Quiz</h3>
                        <p>Klasyczny test z pytaniami wielokrotnego wyboru</p>
                    </button>
                    <button class="type-option" onclick="showCreateScreen('flashcard')">
                        <div class="type-icon">🎴</div>
                        <h3>Fiszki</h3>
                        <p>Karty do nauki z pytaniem i odpowiedzią</p>
                    </button>
                </div>
                <div class="button-group center" style="margin-top: 24px;">
                    <button class="btn" onclick="showHomeScreen()">Anuluj</button>
                </div>
            </div>
        </div>

        <!-- Create Screen -->
        <div id="createScreen" class="screen hidden">
            <div class="card card-white animate-fadeIn">
                <h2 id="createTitle">Tworzenie nowego quizu</h2>
                
                <div class="ai-prompt">
                    <h3 id="aiPromptTitle">Prompt AI do generowania:</h3>
                    <pre id="aiPrompt"></pre>
                    <button class="btn" onclick="copyPrompt()" style="margin-top: 16px;">
                        📋 Kopiuj prompt
                    </button>
                </div>

                <div class="form-group">
                    <label for="quizTitle">Tytuł (opcjonalnie, jeśli już jest w JSON):</label>
                    <input type="text" id="quizTitle" placeholder="Np. Quiz o historii Polski">
                </div>

                <div class="form-group">
                    <label>Tagi (naciśnij Enter aby dodać, opcjonalnie):</label>
                    <div class="tag-input-container" id="tagContainer">
                        <input type="text" id="tagInput" placeholder="Dodaj tag..." onkeypress="handleTagInput(event)">
                    </div>
                </div>

                <div class="form-group">
                    <label for="quizJson" id="jsonLabel">Wklej JSON:</label>
                    <textarea id="quizJson" placeholder="Wklej tutaj wygenerowany JSON..."></textarea>
                </div>

                <div class="form-group" id="answerCountGroup">
                    <label>Liczba odpowiedzi w pytaniach:</label>
                    <select id="answerCount">
                        <option value="3">3 odpowiedzi</option>
                        <option value="4" selected>4 odpowiedzi</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveQuiz()">💾 Zapisz</button>
                    <button class="btn" onclick="showHomeScreen()">Anuluj</button>
                </div>
            </div>
        </div>

        <!-- Edit Screen -->
        <div id="editScreen" class="screen hidden">
            <div class="card card-white animate-fadeIn">
                <h2>Edycja</h2>
                
                <div class="form-group">
                    <label for="editQuizTitle">Tytuł:</label>
                    <input type="text" id="editQuizTitle">
                </div>

                <div class="form-group">
                    <label>Tagi:</label>
                    <div class="tag-input-container" id="editTagContainer">
                        <input type="text" id="editTagInput" placeholder="Dodaj tag..." onkeypress="handleEditTagInput(event)">
                    </div>
                </div>

                <div class="form-group">
                    <label for="editQuizJson">JSON:</label>
                    <textarea id="editQuizJson"></textarea>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="updateQuiz()">💾 Zapisz zmiany</button>
                    <button class="btn btn-accent" onclick="shareQuiz(currentEditingQuizId)">🔗 Udostępnij</button>
                    <button class="btn btn-danger" onclick="deleteCurrentQuiz()">🗑️ Usuń</button>
                    <button class="btn" onclick="showHomeScreen()">Anuluj</button>
                </div>
            </div>
        </div>

        <!-- Pre-Quiz Screen -->
        <div id="preQuizScreen" class="screen hidden">
            <div class="card card-white animate-fadeIn">
                <h2 id="preQuizTitle"></h2>
                <p id="preQuizDescription" style="margin-bottom: 32px;"></p>
                
                <div id="quizHistorySection" class="quiz-settings" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 16px;">📊 Historia wyników</h3>
                    <div id="quizHistory"></div>
                </div>

                <div class="quiz-settings">
                    <h3 style="margin-bottom: 16px;">⚙️ Ustawienia</h3>
                    <div class="setting-row">
                        <label>Losowa kolejność pytań</label>
                        <label class="toggle">
                            <input type="checkbox" id="randomOrder" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-row">
                        <label>Pokazuj litery odpowiedzi</label>
                        <label class="toggle">
                            <input type="checkbox" id="showLetters" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="button-group center">
                    <button class="btn btn-accent" onclick="startQuiz()">▶️ Rozpocznij quiz</button>
                    <button class="btn btn-small" onclick="shareQuiz(currentQuiz.id)">🔗 Udostępnij</button>
                    <button class="btn btn-small" onclick="exportQuiz(currentQuiz.id)">📤 Eksportuj</button>
                    <button class="btn" onclick="showHomeScreen()">Powrót</button>
                </div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="screen hidden">
            <div class="quiz-container">
                <div class="progress-bar" role="progressbar" aria-label="Postęp quizu">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                
                <div class="stats animate-slideIn">
                    <span id="questionNumber">Pytanie 1/10</span>
                    <span id="accuracy">Poprawność: 0%</span>
                    <span id="score">Punkty: 0</span>
                    <span id="streak">Seria: 0🔥</span>
                    <span id="quizTimer">00:00</span>
                </div>
                
                <div class="question-card animate-fadeIn">
                    <div class="question-category" id="questionCategory"></div>
                    <div class="retry-badge hidden" id="retryBadge">🔄 Powtórka</div>
                    <h2 id="questionText"></h2>
                    <div class="answers-grid" id="answersGrid"></div>
                </div>

                <div class="button-group center" style="margin-top: 24px;">
                    <button class="btn" onclick="endQuizEarly()">Zakończ quiz</button>
                </div>

                <div class="keyboard-hint">
                    <kbd class="kbd">1-4</kbd> Wybierz odpowiedź · 
                    <kbd class="kbd">Esc</kbd> Wyjdź
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="screen hidden">
            <div class="card card-white results-screen animate-fadeIn">
                <h2>Quiz zakończony!</h2>
                <div class="score-display" id="finalScore"></div>
                <div class="points-display" id="finalPoints"></div>
                <div class="time-display" id="finalTime"></div>

                <div class="button-group center">
                    <button class="btn btn-primary" onclick="retakeQuiz()">🔄 Powtórz quiz</button>
                    <button class="btn" onclick="showHomeScreen()">🏠 Ekran główny</button>
                </div>
            </div>
        </div>

        <!-- Pre-Flashcard Screen -->
        <div id="preFlashcardScreen" class="screen hidden">
            <div class="card card-white animate-fadeIn">
                <h2 id="preFlashcardTitle"></h2>
                <p id="preFlashcardDescription" style="margin-bottom: 32px;"></p>

                <div id="flashcardHistorySection" class="quiz-settings" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 16px;">📊 Historia nauki</h3>
                    <div id="flashcardHistory"></div>
                </div>

                <div class="quiz-settings">
                    <h3 style="margin-bottom: 16px;">⚙️ Ustawienia</h3>
                    <div class="setting-row">
                        <label>Losowa kolejność fiszek</label>
                        <label class="toggle">
                            <input type="checkbox" id="flashcardRandomOrder" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="button-group center">
                    <button class="btn btn-accent" onclick="startFlashcards()">▶️ Rozpocznij naukę</button>
                    <button class="btn btn-small" onclick="shareQuiz(currentFlashcards.id)">🔗 Udostępnij</button>
                    <button class="btn btn-small" onclick="exportQuiz(currentFlashcards.id)">📤 Eksportuj</button>
                    <button class="btn" onclick="showHomeScreen()">Powrót</button>
                </div>
            </div>
        </div>

        <!-- Flashcard Screen -->
        <div id="flashcardScreen" class="screen hidden">
            <div class="flashcard-container">
                <div class="progress-bar" style="margin-bottom: 32px;" role="progressbar" aria-label="Postęp fiszek">
                    <div class="progress-fill" id="flashcardProgress"></div>
                </div>
                
                <div class="stats animate-slideIn" style="margin-bottom: 24px;">
                    <span id="flashcardNumber">Fiszka 1/10</span>
                    <span id="flashcardStats">Poznane: 0 | Trudne: 0</span>
                    <span id="flashcardTimer">00:00</span>
                </div>

                <div class="flashcard-wrapper">
                    <div class="flashcard animate-fadeIn" id="flashcard" onclick="flipCard()">
                        <div class="flashcard-side flashcard-front">
                            <div class="retry-badge hidden" id="flashcardRetryBadgeFront">🔄 Powtórka</div>
                            <div class="flashcard-content" id="flashcardFront"></div>
                        </div>
                        <div class="flashcard-side flashcard-back">
                            <div class="retry-badge hidden" id="flashcardRetryBadgeBack">🔄 Powtórka</div>
                            <div class="flashcard-content" id="flashcardBack"></div>
                        </div>
                    </div>
                    
                    <p style="text-align: center; margin-top: 16px; color: var(--text-secondary); font-size: 14px;">
                        <span class="desktop-only">Kliknij kartę lub naciśnij <kbd class="kbd">Spacja</kbd> aby ją obrócić</span>
                        <span class="mobile-only">Naciśnij na kartę aby ją obrócić</span>
                    </p>

                    <div class="flashcard-actions" id="flashcardActions" style="display: none;">
                        <button class="flashcard-btn btn-hard" onclick="rateCard('hard')">
                            ❌ Nie znam
                        </button>
                        <button class="flashcard-btn btn-medium" onclick="rateCard('medium')">
                            🤔 Trudne
                        </button>
                        <button class="flashcard-btn btn-easy" onclick="rateCard('easy')">
                            ✅ Znam
                        </button>
                    </div>
                </div>
               <div class="button-group center" style="margin-top: 32px;">
                    <button class="btn" onclick="endFlashcardsEarly()">Zakończ naukę</button>
                </div>

                <div class="keyboard-hint">
                    <kbd class="kbd">1</kbd> Nie znam · 
                    <kbd class="kbd">2</kbd> Trudne · 
                    <kbd class="kbd">3</kbd> Znam · 
                    <kbd class="kbd">Spacja</kbd> Obróć
                </div>
            </div>
        </div>

        <!-- Flashcard Results Screen -->
        <div id="flashcardResultsScreen" class="screen hidden">
            <div class="card card-white results-screen animate-fadeIn">
                <h2>Sesja nauki zakończona!</h2>
                <div class="time-display" id="flashcardFinalTime"></div>
                <div class="stats" style="justify-content: center; margin: 32px 0; background: transparent; border: none;">
                    <div style="text-align: center; margin: 0 24px; min-width: 80px;">
                        <div style="font-size: 2.5rem; font-weight: 200; color: var(--success); line-height: 1; display: flex; justify-content: center; align-items: center; height: 60px;">
                            <span id="flashcardEasyCount">0</span>
                        </div>
                        <p>Znane</p>
                    </div>
                    <div style="text-align: center; margin: 0 24px; min-width: 80px;">
                        <div style="font-size: 2.5rem; font-weight: 200; color: var(--warning); line-height: 1; display: flex; justify-content: center; align-items: center; height: 60px;">
                            <span id="flashcardMediumCount">0</span>
                        </div>
                        <p>Trudne</p>
                    </div>
                    <div style="text-align: center; margin: 0 24px; min-width: 80px;">
                        <div style="font-size: 2.5rem; font-weight: 200; color: var(--danger); line-height: 1; display: flex; justify-content: center; align-items: center; height: 60px;">
                            <span id="flashcardHardCount">0</span>
                        </div>
                        <p>Nieznane</p>
                    </div>
                </div>
                
                <div class="button-group center">
                    <button class="btn" onclick="showHomeScreen()">🏠 Ekran główny</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal hidden" onclick="closeModal('importModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Importuj quiz</h2>
                <button class="modal-close" onclick="closeModal('importModal')">×</button>
            </div>
            <div class="form-group">
                <label>Wybierz plik JSON lub wklej dane:</label>
                <input type="file" id="importFile" accept=".json" onchange="handleFileImport(event)">
            </div>
            <div class="form-group">
                <textarea id="importJson" placeholder="Lub wklej JSON tutaj..." style="min-height: 200px;"></textarea>
            </div>
            <p style="margin-bottom: 16px; font-size: 14px; color: var(--text-secondary);">
                ℹ️ Istniejące quizy nie zostaną nadpisane - dodane zostaną tylko nowe.
            </p>
            <div class="button-group">
                <button class="btn btn-primary" onclick="importQuiz()">📥 Importuj</button>
                <button class="btn" onclick="closeModal('importModal')">Anuluj</button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal" class="modal hidden" onclick="closeModal('backupModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Zarządzanie danymi</h2>
                <button class="modal-close" onclick="closeModal('backupModal')">×</button>
            </div>
            <p style="margin-bottom: 24px; color: var(--text-secondary);">
                Wykonaj kopię zapasową wszystkich quizów i danych lub przywróć z pliku.
            </p>
            <div class="button-group">
                <button class="btn btn-primary" onclick="exportAllData()">💾 Eksportuj wszystko</button>
                <button class="btn btn-accent" onclick="document.getElementById('restoreFile').click()">📂 Przywróć z pliku</button>
                <input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="restoreData(event)">
            </div>
            <div style="margin-top: 24px; padding: 16px; background: var(--surface-alt); border-radius: 8px;">
                <p style="font-size: 14px; color: var(--text-secondary);">
                    <strong>Rozmiar danych:</strong> <span id="dataSize">0 KB</span><br>
                    <strong>Liczba quizów:</strong> <span id="quizCount">0</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal hidden" onclick="closeModal('shareModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>🔗 Udostępnij quiz</h2>
                <button class="modal-close" onclick="closeModal('shareModal')">×</button>
            </div>
            <div id="shareContent">
                <p style="margin-bottom: 16px; color: var(--text-secondary); font-size: 14px; text-align: center;">
                    <span style="font-size: 32px;">⏳</span><br>
                    Generowanie linku...
                </p>
            </div>
        </div>
    </div>

    <script>
        // ==================== STATE ====================
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let answeredQuestionsCount = 0;
        let score = 0;
        let totalPoints = 0;
        let correctAnswers = 0;
        let questions = [];
        let questionQueue = [];
        let startTime = null;
        let questionStartTime = null;
        let currentEditingQuizId = null;
        let currentQuizSettings = {
            randomOrder: true,
            answerCount: 4,
            showLetters: true
        };
        let timerInterval = null;
        let currentStreak = 0;
        let maxStreak = 0;
        let currentFilter = 'all';
        let currentTags = [];
        let editTags = [];

        let selectionMode = false;
        let selectedQuizzes = new Set();

        // Flashcard state
        let currentFlashcards = null;
        let currentCardIndex = 0;
        let answeredCardsCount = 0;
        let flashcardStats = { easy: 0, medium: 0, hard: 0 };
        let cards = [];
        let cardQueue = [];
        let isCardFlipped = false;
        let isTransitioning = false;
        let cardRatings = [];
        let completedCards = new Set();
        let retriedCards = new Set();

        // Toast queue system
        let activeToast = null;
        let queuedToast = null;
        let toastTimeout = null;

        // Debounce timer
        let searchDebounceTimer = null;

        // Track answered questions in first attempt
        let firstAttemptCorrect = new Set();
        let firstAttemptAnswered = 0;
        let retriedQuestions = new Set();

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            validateAndCleanData();
            checkSharedQuiz();
            setupKeyboardShortcuts();
        });

        // ==================== DATA VALIDATION ====================
        function validateQuizFormat(quiz) {
            try {
                if (!quiz.title || typeof quiz.title !== 'string') return false;
                if (!quiz.data || typeof quiz.data !== 'string') return false;
                
                const data = quiz.data;
                
                if (!data.startsWith('{0') && !data.startsWith('{1')) return false;
                if (!data.endsWith('}')) return false;
                if (data.length < 5) return false;
                
                return true;
            } catch (error) {
                return false;
            }
        }

        function validateAndCleanData() {
            try {
                const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                const validQuizzes = [];
                let removedCount = 0;

                quizzes.forEach(quiz => {
                    if (validateQuizFormat(quiz)) {
                        validQuizzes.push(quiz);
                    } else {
                        removedCount++;
                        console.warn('Usunięto nieprawidłowy quiz:', quiz.title || 'Bez tytułu');
                    }
                });

                if (removedCount > 0) {
                    localStorage.setItem('quizzes', JSON.stringify(validQuizzes));
                    showToast(`Usunięto ${removedCount} nieprawidłowych quizów`, 'info');
                }
            } catch (error) {
                console.error('Błąd walidacji danych:', error);
            }
        }

        // ==================== FORMAT CONVERSION ====================
        const DELIMITER = '\u001F'; // Unit Separator (ASCII 31)

        function escapeText(text) {
            return text.replace(/\|/g, DELIMITER);
        }

        function unescapeText(text) {
            return text.replace(/\u001F/g, '|');
        }

        function decodeFromNewFormat(data) {
            if (!data.data || typeof data.data !== 'string') {
                throw new Error('Brak pola data w nowym formacie');
            }
            
            const content = data.data;
            
            if (content.startsWith('{1')) {
                const cardsData = content.substring(2, content.length - 1);
                const parts = cardsData.split('|');
                const cards = [];
                
                for (let i = 0; i < parts.length; i += 3) {
                    if (parts[i]) {
                        const card = {
                            front: unescapeText(parts[i]),
                            back: unescapeText(parts[i + 2] || '')
                        };
                        if (parts[i + 1]) {
                            card.category = unescapeText(parts[i + 1]);
                        }
                        cards.push(card);
                    }
                }
                
                return {
                    title: data.title,
                    tags: data.tags || [],
                    type: 'flashcard',
                    data: content,
                    cards: cards
                };
            } else if (content.startsWith('{0')) {
                const questionsData = content.substring(2, content.length - 1);
                const questions = [];
                let i = 0;
                
                while (i < questionsData.length) {
                    const qType = questionsData[i];
                    i++;
                    
                    const parts = [];
                    let current = '';
                    
                    while (i < questionsData.length && questionsData[i] !== '0' && questionsData[i] !== '1') {
                        if (questionsData[i] === '|') {
                            parts.push(current);
                            current = '';
                        } else {
                            current += questionsData[i];
                        }
                        i++;
                    }
                    
                    if (parts.length > 0) {
                        const question = {
                            question: unescapeText(parts[0]),
                            group: parts[1] ? unescapeText(parts[1]) : undefined,
                            correct: unescapeText(parts[2])
                        };
                        
                        if (qType === '1') {
                            question.type = 'tf';
                            question.wrong = [unescapeText(parts[3])];
                        } else {
                            question.wrong = parts.slice(3).map(p => unescapeText(p));
                        }
                        
                        questions.push(question);
                    }
                }
                
                return {
                    title: data.title,
                    tags: data.tags || [],
                    type: 'quiz',
                    answerCount: data.answerCount || 4,
                    data: content,
                    questions: questions
                };
            }
            
            throw new Error('Nieznany format danych');
        }

        function encodeToNewFormat(quiz) {
            if (quiz.data && typeof quiz.data === 'string') {
                return {
                    title: quiz.title,
                    tags: quiz.tags || [],
                    answerCount: quiz.answerCount || 4,
                    type: quiz.type,
                    data: quiz.data
                };
            }
            
            let data = '';
            
            if (quiz.type === 'flashcard') {
                data = '{1';
                quiz.cards.forEach(card => {
                    data += escapeText(card.front) + '|';
                    data += escapeText(card.category || '') + '|';
                    data += escapeText(card.back) + '|';
                });
                data += '}';
            } else {
                data = '{0';
                quiz.questions.forEach(q => {
                    if (q.type === 'tf') {
                        data += '1' + escapeText(q.question) + '|';
                        data += escapeText(q.group || '') + '|';
                        data += escapeText(q.correct) + '|';
                        data += escapeText(q.wrong[0]) + '|';
                    } else {
                        data += '0' + escapeText(q.question) + '|';
                        data += escapeText(q.group || '') + '|';
                        data += escapeText(q.correct) + '|';
                        data += q.wrong.map(w => escapeText(w)).join('|') + '|';
                    }
                });
                data += '}';
            }
            
            return {
                title: quiz.title,
                tags: quiz.tags || [],
                answerCount: quiz.answerCount || 4,
                type: quiz.type,
                data: data
            };
        }

        // ==================== LOCAL STORAGE PROTECTION ====================
        function safeLocalStorageSet(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    showToast('Błąd: Brak miejsca w localStorage. Usuń stare quizy.', 'error');
                } else {
                    showToast('Błąd zapisu: ' + error.message, 'error');
                }
                return false;
            }
        }

        // ==================== THEME ====================
        function initTheme() {
            let savedTheme = localStorage.getItem('theme');
            
            if (!savedTheme) {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    savedTheme = 'dark';
                } else {
                    savedTheme = 'light';
                }
            }
            
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    if (!localStorage.getItem('theme')) {
                        const newTheme = e.matches ? 'dark' : 'light';
                        document.documentElement.setAttribute('data-theme', newTheme);
                        updateThemeIcon(newTheme);
                    }
                });
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            showToast('Zmieniono motyw na ' + (newTheme === 'dark' ? 'ciemny' : 'jasny'), 'success');
        }

        function updateThemeIcon(theme) {
            document.getElementById('themeIcon').textContent = theme === 'dark' ? '☀️' : '🌙';
        }

        // ==================== NAVIGATION ====================
        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
        }

        function showHomeScreen() {
            hideAllScreens();
            document.getElementById('homeScreen').classList.remove('hidden');
            loadQuizzes();
        }

        function showChooseTypeScreen() {
            hideAllScreens();
            document.getElementById('chooseTypeScreen').classList.remove('hidden');
        }

        function showCreateScreen(type) {
            hideAllScreens();
            document.getElementById('createScreen').classList.remove('hidden');
            document.getElementById('quizJson').value = '';
            document.getElementById('quizTitle').value = '';
            currentTags = [];
            renderTags();
            
            const prompts = {
                quiz: `Wygeneruj quiz w nowym formacie na temat [TWÓJ TEMAT].

Parametry opcjonalne:
- Liczba pytań: [np. 10]
- Liczba pytań prawda/fałsz: [np. 3]

Format:
{
  "title": "Tytuł quizu",
  "tags": ["tag1", "tag2", "tag3"],
  "answerCount": 4,
  "data": "{0pytanie ABCD|grupa|poprawna|błędna1|błędna2|błędna3|1pytanie PF|grupa|Prawda|Fałsz|}"
}

Struktura data:
- Zaczyna się od {0 (quiz)
- Każde pytanie ABCD: 0pytanie|grupa|poprawna|błędna1|błędna2|błędna3|
- Każde pytanie PF: 1pytanie|grupa|Prawda|Fałsz|
- Jeśli brak grupy: ||
- Kończy się }

Przykład:
{
  "title": "Quiz o Polsce",
  "tags": ["historia", "polska", "edukacja"],
  "answerCount": 4,
  "data": "{00Kto był pierwszym królem Polski?|osoba|Bolesław Chrobry|Mieszko I|Kazimierz Wielki|Władysław Jagiełło|1Warszawa jest stolicą Polski|geografia|Prawda|Fałsz|0Jaka rzeka płynie przez Warszawę?||Wisła|Odra|Warta|Bug|}"
}`,
                flashcard: `Wygeneruj fiszki w nowym formacie na temat [TWÓJ TEMAT].

Parametry opcjonalne:
- Liczba fiszek: [np. 20]

Format:
{
  "title": "Tytuł zestawu",
  "tags": ["tag1", "tag2", "tag3"],
  "type": "flashcard",
  "data": "{1przód1|kategoria1|tył1|przód2|kategoria2|tył2|}"
}

Struktura data:
- Zaczyna się od {1 (fiszki)
- Każda fiszka: przód|kategoria|tył|
- Jeśli brak kategorii: ||
- Kończy się }

Przykład:
{
  "title": "Angielski - Zwierzęta",
  "tags": ["angielski", "zwierzęta", "podstawy"],
  "type": "flashcard",
  "data": "{1dog|zwierzęta domowe|pies|cat|zwierzęta domowe|kot|bird|ptaki|ptak|fish||ryba|}"
}`
            };

            document.getElementById('createTitle').textContent = type === 'flashcard' ? 
                'Tworzenie nowych fiszek' : 'Tworzenie nowego quizu';
            document.getElementById('aiPromptTitle').textContent = type === 'flashcard' ? 
                'Prompt AI do generowania fiszek:' : 'Prompt AI do generowania quizu:';
            document.getElementById('jsonLabel').textContent = type === 'flashcard' ? 
                'Wklej JSON z fiszkami:' : 'Wklej JSON z quizem:';
            document.getElementById('aiPrompt').textContent = prompts[type];

            window.currentCreateType = type;
            document.getElementById('answerCountGroup').style.display = 
                type === 'flashcard' ? 'none' : 'block';
        }

        function showEditScreen(quizId) {
            hideAllScreens();
            document.getElementById('editScreen').classList.remove('hidden');
            currentEditingQuizId = quizId;
            
            const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            const quiz = quizzes.find(q => q.id === quizId);
            if (quiz) {
                document.getElementById('editQuizTitle').value = quiz.title || '';
                editTags = quiz.tags || [];
                renderEditTags();
                
                const jsonData = {
                    title: quiz.title,
                    tags: quiz.tags,
                    type: quiz.type,
                    answerCount: quiz.answerCount,
                    data: quiz.data
                };
                
                document.getElementById('editQuizJson').value = JSON.stringify(jsonData, null, 2);
            }
        }

        function showPreQuizScreen(quizId) {
            hideAllScreens();
            document.getElementById('preQuizScreen').classList.remove('hidden');
            
            const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            currentQuiz = quizzes.find(q => q.id === quizId);
            
            if (currentQuiz) {
                document.getElementById('preQuizTitle').textContent = currentQuiz.title;
                const tfQuestions = currentQuiz.questions.filter(q => q.type === 'tf').length;
                const mcQuestions = currentQuiz.questions.length - tfQuestions;
                document.getElementById('preQuizDescription').textContent = 
                    `${currentQuiz.questions.length} pytań (${mcQuestions} wielokrotnego wyboru, ${tfQuestions} prawda/fałsz)`;
                currentQuizSettings.answerCount = currentQuiz.answerCount || 4;
                
                displayQuizHistory(quizId);
            }
        }

        function showQuizScreen() {
            hideAllScreens();
            document.getElementById('quizScreen').classList.remove('hidden');
        }

        function showResultsScreen() {
            hideAllScreens();
            document.getElementById('resultsScreen').classList.remove('hidden');
        }

        function showFlashcardScreen(flashcardId) {
            hideAllScreens();
            document.getElementById('preFlashcardScreen').classList.remove('hidden');

            const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            currentFlashcards = quizzes.find(q => q.id === flashcardId);
            
            if (currentFlashcards) {
                document.getElementById('preFlashcardTitle').textContent = currentFlashcards.title;
                document.getElementById('preFlashcardDescription').textContent = 
                    `${currentFlashcards.cards.length} fiszek do nauki`;
                
                displayFlashcardHistory(flashcardId);
            }
        }

        // ==================== QUIZ MANAGEMENT ====================
        function loadQuizzes() {
            let quizzes = [];
            try {
                quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            } catch (error) {
                console.error('Error loading quizzes:', error);
                showToast('Błąd wczytywania quizów', 'error');
                quizzes = [];
            }
            const quizList = document.getElementById('quizList');
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = quizzes.filter(quiz => {
                const matchesSearch = quiz.title.toLowerCase().includes(searchQuery) ||
                    (quiz.tags && quiz.tags.some(tag => tag.toLowerCase().includes(searchQuery)));
                const matchesFilter = currentFilter === 'all' || 
                    (currentFilter === 'quiz' && quiz.type !== 'flashcard') ||
                    (currentFilter === 'flashcard' && quiz.type === 'flashcard');
                return matchesSearch && matchesFilter;
            });
            
            if (filtered.length === 0) {
                quizList.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state-icon">📭</div>
                        <h3>Brak wyników</h3>
                        <p>Nie znaleziono quizów spełniających kryteria</p>
                    </div>
                `;
                return;
            }
            
            quizList.innerHTML = filtered.map(quiz => {
                const isFlashcard = quiz.type === 'flashcard';
                const icon = isFlashcard ? '🎴' : '📊';
                const count = isFlashcard ? `${quiz.cards.length} fiszek` : `${quiz.questions.length} pytań`;
                const clickHandler = isFlashcard ? 'showFlashcardScreen' : 'showPreQuizScreen';
                
                const history = getQuizHistory(quiz.id);
                const attempts = history.length;
                
                let bestResult = null;
                if (attempts > 0) {
                    bestResult = history.reduce((best, current) => {
                        return current.points > best.points ? current : best;
                    }, history[0]);
                }
                
                const tagsHtml = quiz.tags && quiz.tags.length > 0 ? 
                    `<div class="quiz-tags">${quiz.tags.map(tag => 
                        `<span class="tag">${tag}</span>`
                    ).join('')}</div>` : '';

                const isSelected = selectedQuizzes.has(quiz.id);
                const selectionClass = selectionMode ? 'selection-mode' : '';
                const selectedClass = isSelected ? 'selected' : '';
                const checkboxHtml = selectionMode ? 
                    `<input type="checkbox" class="quiz-checkbox" ${isSelected ? 'checked' : ''} 
                     onclick="event.stopPropagation(); toggleQuizSelection('${quiz.id}')" 
                     data-quiz-id="${quiz.id}">` : '';
                
                return `
                    <div class="quiz-item animate-fadeIn ${selectionClass} ${selectedClass}" 
                         onclick="${selectionMode ? `toggleQuizSelection('${quiz.id}')` : `${clickHandler}('${quiz.id}')`}">
                        ${checkboxHtml}
                        <div class="quiz-type-icon">${icon}</div>
                        <div class="quiz-actions" ${selectionMode ? 'style="display: none;"' : ''}>
                            <button onclick="event.stopPropagation(); shareQuiz('${quiz.id}')" title="Udostępnij">🔗</button>
                            <button onclick="event.stopPropagation(); showEditScreen('${quiz.id}')" title="Edytuj">✏️</button>
                            <button onclick="event.stopPropagation(); confirmDelete('${quiz.id}')" title="Usuń">🗑️</button>
                        </div>
                        <h3>${quiz.title}</h3>
                        <p>${count}</p>
                        ${tagsHtml}
                        ${bestResult ? `<div class="quiz-stats-badge">
                            ${attempts} ${attempts === 1 ? 'podejście' : 'podejść'} · 
                            Najlepszy: ${bestResult.percentage}% (${bestResult.points} pkt)
                        </div>` : ''}
                        <div class="quiz-date">${formatDate(quiz.createdAt)}</div>
                    </div>
                `;
            }).join('');
        }

        function filterQuizzes() {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                loadQuizzes();
            }, 300);
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            loadQuizzes();
        }

        function saveQuiz() {
            const jsonText = document.getElementById('quizJson').value.trim();
            const titleInput = document.getElementById('quizTitle').value.trim();
            const answerCount = parseInt(document.getElementById('answerCount').value);
            
            if (!jsonText) {
                showToast('Błąd: Wklej JSON quizu', 'error');
                return;
            }
            
            try {
                const quizData = JSON.parse(jsonText);

                if (!validateQuizFormat(quizData)) {
                    throw new Error('Nieprawidłowy format JSON');
                }

                const decoded = decodeFromNewFormat(quizData);
                
                const finalTitle = titleInput || decoded.title;
                if (!finalTitle) {
                    throw new Error('Brak tytułu quizu');
                }
                
                const jsonTags = decoded.tags || [];
                const allTags = [...new Set([...currentTags, ...jsonTags])];
                
                const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                const exists = quizzes.find(q => q.data === decoded.data);
                
                if (exists) {
                    showToast('Ten quiz już istnieje w bibliotece!', 'info');
                    return;
                }
                
                const quiz = {
                    title: finalTitle,
                    tags: allTags,
                    type: decoded.type,
                    data: decoded.data,
                    answerCount: window.currentCreateType === 'flashcard' ? 4 : answerCount,
                    id: Date.now().toString(),
                    createdAt: new Date().toISOString()
                };

                if (decoded.type === 'flashcard') {
                    quiz.cards = decoded.cards;
                } else {
                    quiz.questions = decoded.questions;
                }
                
                quizzes.push(quiz);
                
                if (!safeLocalStorageSet('quizzes', JSON.stringify(quizzes))) {
                    return;
                }
                
                showToast('Quiz został zapisany!', 'success');
                showHomeScreen();
            } catch (error) {
                showToast('Błąd: ' + error.message, 'error');
            }
        }
        function toggleSelectionMode() {
            selectionMode = !selectionMode;
            selectedQuizzes.clear();
            
            const btn = document.getElementById('selectionModeBtn');
            const batchActions = document.getElementById('batchActions');
            
            if (selectionMode) {
                btn.textContent = '✕ Anuluj zaznaczanie';
                btn.classList.add('btn-danger');
                batchActions.style.display = 'flex';
            } else {
                btn.textContent = '☑️ Zaznacz wiele';
                btn.classList.remove('btn-danger');
                batchActions.style.display = 'none';
            }
            
            loadQuizzes();
        }

        function toggleQuizSelection(quizId) {
            if (selectedQuizzes.has(quizId)) {
                selectedQuizzes.delete(quizId);
            } else {
                selectedQuizzes.add(quizId);
            }
            
            document.getElementById('selectedCount').textContent = `${selectedQuizzes.size} zaznaczonych`;
            loadQuizzes();
        }

        function clearSelection() {
            toggleSelectionMode();
        }

        function batchDelete() {
            if (selectedQuizzes.size === 0) {
                showToast('Nie zaznaczono żadnych quizów', 'info');
                return;
            }
            
            if (confirm(`Czy na pewno chcesz usunąć ${selectedQuizzes.size} quizów? Tej operacji nie można cofnąć.`)) {
                const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                const filtered = quizzes.filter(q => !selectedQuizzes.has(q.id));
                localStorage.setItem('quizzes', JSON.stringify(filtered));
                
                const history = JSON.parse(localStorage.getItem('quizHistory') || '{}');
                selectedQuizzes.forEach(id => delete history[id]);
                localStorage.setItem('quizHistory', JSON.stringify(history));
                
                showToast(`Usunięto ${selectedQuizzes.size} quizów`, 'success');
                toggleSelectionMode();
            }
        }

        function batchExport() {
            if (selectedQuizzes.size === 0) {
                showToast('Nie zaznaczono żadnych quizów', 'info');
                return;
            }
            
            const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            const selected = quizzes.filter(q => selectedQuizzes.has(q.id)).map(q => {
                return encodeToNewFormat(q);
            });
            
            const blob = new Blob([JSON.stringify(selected, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quizapp_selected_${selectedQuizzes.size}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`Wyeksportowano ${selectedQuizzes.size} quizów`, 'success');
        }

        function updateQuiz() {
            const jsonText = document.getElementById('editQuizJson').value.trim();
            const title = document.getElementById('editQuizTitle').value.trim();
            
            if (!jsonText) {
                showToast('Błąd: JSON nie może być pusty', 'error');
                return;
            }
            
            try {
                const updatedData = JSON.parse(jsonText);

                if (!validateQuizFormat(updatedData)) {
                    throw new Error('Nieprawidłowy format JSON');
                }

                const decoded = decodeFromNewFormat(updatedData);
                
                if (!title) {
                    throw new Error('Brak tytułu');
                }
                
                const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                const index = quizzes.findIndex(q => q.id === currentEditingQuizId);
                
                if (index !== -1) {
                    const jsonTags = decoded.tags || [];
                    const allTags = [...new Set([...editTags, ...jsonTags])];
                    
                    quizzes[index] = {
                        title: title,
                        tags: allTags,
                        type: decoded.type,
                        data: decoded.data,
                        answerCount: quizzes[index].answerCount,
                        id: currentEditingQuizId,
                        createdAt: quizzes[index].createdAt,
                        updatedAt: new Date().toISOString()
                    };

                    if (decoded.type === 'flashcard') {
                        quizzes[index].cards = decoded.cards;
                    } else {
                        quizzes[index].questions = decoded.questions;
                    }
                    
                    if (!safeLocalStorageSet('quizzes', JSON.stringify(quizzes))) {
                        return;
                    }
                    
                    showToast('Quiz został zaktualizowany!', 'success');
                    showHomeScreen();
                }
            } catch (error) {
                showToast('Błąd: ' + error.message, 'error');
            }
        }

        function deleteCurrentQuiz() {
            if (confirm('Czy na pewno chcesz usunąć ten quiz?')) {
                deleteQuiz(currentEditingQuizId);
                showHomeScreen();
            }
        }

        function confirmDelete(quizId) {
            if (confirm('Czy na pewno chcesz usunąć ten quiz? Tej operacji nie można cofnąć.')) {
                deleteQuiz(quizId);
            }
        }

        function deleteQuiz(quizId) {
            const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            const filtered = quizzes.filter(q => q.id !== quizId);
            localStorage.setItem('quizzes', JSON.stringify(filtered));
            
            const history = JSON.parse(localStorage.getItem('quizHistory') || '{}');
            delete history[quizId];
            localStorage.setItem('quizHistory', JSON.stringify(history));
            
            showToast('Quiz został usunięty', 'success');
            loadQuizzes();
        }

        // ==================== TAGS ====================
        function handleTagInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('tagInput');
                const tag = input.value.trim();
                if (tag && !currentTags.includes(tag)) {
                    currentTags.push(tag);
                    renderTags();
                    input.value = '';
                }
            }
        }

        function handleEditTagInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('editTagInput');
                const tag = input.value.trim();
                if (tag && !editTags.includes(tag)) {
                    editTags.push(tag);
                    renderEditTags();
                    input.value = '';
                }
            }
        }

        function renderTags() {
            const container = document.getElementById('tagContainer');
            const input = document.getElementById('tagInput');
            
            const tagsHtml = currentTags.map((tag, index) => `
                <span class="tag-removable">
                    ${tag}
                    <button onclick="removeTag(${index})">×</button>
                </span>
            `).join('');
            
            container.innerHTML = tagsHtml;
            container.appendChild(input);
        }

        function renderEditTags() {
            const container = document.getElementById('editTagContainer');
            const input = document.getElementById('editTagInput');
            
            const tagsHtml = editTags.map((tag, index) => `
                <span class="tag-removable">
                    ${tag}
                    <button onclick="removeEditTag(${index})">×</button>
                </span>
            `).join('');
            
            container.innerHTML = tagsHtml;
            container.appendChild(input);
        }

        function removeTag(index) {
            currentTags.splice(index, 1);
            renderTags();
        }

        function removeEditTag(index) {
            editTags.splice(index, 1);
            renderEditTags();
        }

        // ==================== QUIZ GAMEPLAY ====================
        function startQuiz() {
            currentQuizSettings.randomOrder = document.getElementById('randomOrder').checked;
            currentQuizSettings.showLetters = document.getElementById('showLetters').checked;
            
            questions = [...currentQuiz.questions];
            
            if (currentQuizSettings.randomOrder) {
                questions = shuffleArray(questions);
            }
            
            questionQueue = questions.map((q, index) => ({
                question: q,
                originalIndex: index,
                isRetry: false
            }));
            
            currentQuestionIndex = 0;
            answeredQuestionsCount = 0;
            score = 0;
            totalPoints = 0;
            correctAnswers = 0;
            currentStreak = 0;
            maxStreak = 0;
            startTime = Date.now();
            
            firstAttemptCorrect = new Set();
            firstAttemptAnswered = 0;
            retriedQuestions = new Set();
            
            showQuizScreen();
            displayQuestion();
            startTimer('quizTimer');
        }

        function displayQuestion() {
            if (currentQuestionIndex >= questionQueue.length) {
                endQuiz();
                return;
            }
            
            const currentItem = questionQueue[currentQuestionIndex];
            const question = currentItem.question;
            const isRetry = currentItem.isRetry;
            
            document.getElementById('questionText').textContent = question.question;
            
            const retryBadge = document.getElementById('retryBadge');
            if (isRetry) {
                retryBadge.classList.remove('hidden');
            } else {
                retryBadge.classList.add('hidden');
            }
            
            const categoryEl = document.getElementById('questionCategory');
            if (question.group) {
                categoryEl.textContent = question.group;
                categoryEl.style.display = 'block';
            } else {
                categoryEl.style.display = 'none';
            }
            
            const isTrueFalse = question.type === 'tf';
            const answers = isTrueFalse ? 
                prepareAnswersForTrueFalse(question) : 
                prepareAnswers(question);
            
            const answersGrid = document.getElementById('answersGrid');
            answersGrid.className = `answers-grid ${isTrueFalse ? 'two-answers' : 'four-answers'}`;
            
            const letters = ['A', 'B', 'C', 'D'];
            answersGrid.innerHTML = answers.map((answer, index) => `
                <button class="answer-btn" onclick="selectAnswer('${escapeHtml(answer)}', '${escapeHtml(question.correct)}', ${currentItem.originalIndex}, ${isRetry})" data-answer="${escapeHtml(answer)}">
                    ${currentQuizSettings.showLetters ? `<span class="answer-letter">${letters[index]}</span>` : ''}
                    ${answer}
                </button>
            `).join('');
            
            updateProgress();
            updateStats();
            questionStartTime = Date.now();
        }

        function selectAnswer(selected, correct, originalIndex, isRetry) {
            selected = decodeHtml(selected);
            correct = decodeHtml(correct);
            
            const buttons = document.querySelectorAll('.answer-btn');  
            const timeElapsed = (Date.now() - questionStartTime) / 1000;
            const basePoints = buttons.length * 250;
            let earnedPoints = 0;
            
            buttons.forEach(btn => {
                btn.disabled = true;
                const btnAnswer = decodeHtml(btn.dataset.answer);
                if (btnAnswer === correct) {
                    btn.classList.add('correct');
                }
            });
            
            const selectedBtn = Array.from(buttons).find(btn => decodeHtml(btn.dataset.answer) === selected);
            
            if (selected === correct) {
                if (!isRetry) {
                    firstAttemptAnswered++;
                }

                if (!isRetry && !firstAttemptCorrect.has(originalIndex)) {
                    firstAttemptCorrect.add(originalIndex);
                    correctAnswers++;
                    score++;
                    answeredQuestionsCount++;
                    
                    earnedPoints = basePoints - Math.min(buttons.length * 125, Math.round(timeElapsed * 10));
                    totalPoints += earnedPoints;
                }
                
                currentStreak++;
                maxStreak = Math.max(maxStreak, currentStreak);

                if (currentStreak >= 3) {
                    showStreakIndicator();
                }
            } else {
                if (!isRetry) {
                    firstAttemptAnswered++;
                }
                
                currentStreak = 0;
                selectedBtn.classList.add('incorrect');
                selectedBtn.classList.add('animate-shake');
                
                const currentItem = questionQueue[currentQuestionIndex];
                if (!retriedQuestions.has(currentItem.originalIndex)) {
                    questionQueue.push({
                        question: currentItem.question,
                        originalIndex: currentItem.originalIndex,
                        isRetry: true
                    });
                    retriedQuestions.add(currentItem.originalIndex);
                }
            }
            
            updateStats();
            
            setTimeout(() => {
                currentQuestionIndex++;
                displayQuestion();
            }, 1500);
        }

        function showStreakIndicator() {
            const existing = document.querySelector('.streak-indicator');
            if (existing) existing.remove();
            
            const indicator = document.createElement('div');
            indicator.className = 'streak-indicator';
            indicator.textContent = `${currentStreak} 🔥`;
            document.body.appendChild(indicator);
            
            setTimeout(() => indicator.remove(), 2000);
        }

        function updateProgress() {
            const totalQuestions = questions.length;
            const progress = (currentQuestionIndex / questionQueue.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('questionNumber').textContent = 
                `Pytanie ${answeredQuestionsCount}/${totalQuestions} (${currentQuestionIndex + 1}/${questionQueue.length})`;
        }

        function updateStats() {
            const accuracy = firstAttemptAnswered > 0 ? 
                Math.round((firstAttemptCorrect.size / firstAttemptAnswered) * 100) : 0;
            document.getElementById('accuracy').textContent = `Poprawność: ${accuracy}%`;
            document.getElementById('score').textContent = `Punkty: ${totalPoints}`;
            document.getElementById('streak').textContent = `Seria: ${currentStreak}🔥`;
        }

        function endQuiz() {
            stopTimer();
            const totalTime = (Date.now() - startTime) / 1000;
            const percentage = Math.round((score / questions.length) * 100);
            
            document.getElementById('finalScore').textContent = `${score}/${questions.length} (${percentage}%)`;
            document.getElementById('finalPoints').textContent = `${totalPoints} punktów · Najdłuższa seria: ${maxStreak}🔥`;
            document.getElementById('finalTime').textContent = `Czas: ${formatTime(totalTime)}`;
            
            saveQuizResult(currentQuiz.id, {
                score: score,
                total: questions.length,
                percentage: percentage,
                points: totalPoints,
                time: totalTime,
                maxStreak: maxStreak,
                date: new Date().toISOString()
            });
            
            showResultsScreen();
        }

        function retakeQuiz() {
            showPreQuizScreen(currentQuiz.id);
        }

        function endQuizEarly() {
            if (currentQuestionIndex < questions.length && confirm('Czy na pewno chcesz zakończyć quiz? Postęp nie zostanie zapisany.')) {
                stopTimer();
                showHomeScreen();
            } else if (currentQuestionIndex >= questions.length && confirm('Czy na pewno chcesz zakończyć quiz? Postęp zostanie zapisany.')) {
                endQuiz()
            }
        }

        function prepareAnswersForTrueFalse(question) {
            return shuffleArray(['Prawda', 'Fałsz']);
        }

        function prepareAnswers(question) {
            let answers = [question.correct];
            let wrongAnswers = [...question.wrong];
            
            const neededWrongAnswers = currentQuizSettings.answerCount - 1;
            
            if (wrongAnswers.length < neededWrongAnswers) {
                const additionalAnswers = getAdditionalWrongAnswers(question, neededWrongAnswers - wrongAnswers.length);
                wrongAnswers = [...wrongAnswers, ...additionalAnswers];
            }
            
            wrongAnswers = shuffleArray(wrongAnswers).slice(0, neededWrongAnswers);
            answers = [...answers, ...wrongAnswers];
            
            return shuffleArray(answers);
        }

        function getAdditionalWrongAnswers(currentQuestion, needed) {
            const additional = [];
            
            const sameGroupQuestions = questions.filter(q => 
                q !== currentQuestion && 
                q.group === currentQuestion.group && 
                q.correct !== currentQuestion.correct &&
                q.type !== 'tf'
            );
            
            for (let i = 0; i < Math.min(needed, sameGroupQuestions.length); i++) {
                additional.push(sameGroupQuestions[i].correct);
            }
            
            if (additional.length < needed) {
                const otherQuestions = questions.filter(q => 
                    q !== currentQuestion && 
                    q.correct !== currentQuestion.correct &&
                    !additional.includes(q.correct) &&
                    q.type !== 'tf'
                );
                
                for (let i = 0; i < Math.min(needed - additional.length, otherQuestions.length); i++) {
                    additional.push(otherQuestions[i].correct);
                }
            }
            
            return additional;
        }

        // ==================== FLASHCARDS ====================
        function startFlashcards() {
            hideAllScreens();
            document.getElementById('flashcardScreen').classList.remove('hidden');
            
            const randomOrder = document.getElementById('flashcardRandomOrder').checked;
            
            cards = [...currentFlashcards.cards];
            if (randomOrder) {
                cards = shuffleArray(cards);
            }
            
            cardQueue = cards.map((c, index) => ({
                card: c,
                originalIndex: index,
                isRetry: false
            }));
            
            currentCardIndex = 0;
            answeredCardsCount = 0;
            flashcardStats = { easy: 0, medium: 0, hard: 0 };
            isCardFlipped = false;
            isTransitioning = false;
            cardRatings = [];
            completedCards = new Set();
            retriedCards = new Set();
            startTime = Date.now();
            
            displayFlashcard();
            startTimer('flashcardTimer');
        }

        function displayFlashcard() {
            if (currentCardIndex >= cardQueue.length) {
                endFlashcards();
                return;
            }

            const currentItem = cardQueue[currentCardIndex];
            const card = currentItem.card;
            const isRetry = currentItem.isRetry;
            const flashcardEl = document.getElementById('flashcard');

            flashcardEl.classList.remove('flipped');
            document.getElementById('flashcardActions').style.display = 'none';
            isCardFlipped = false;

            // FIX: Badge na OBIE strony (przyczepiony position: absolute)
            const retryBadgeFront = document.getElementById('flashcardRetryBadgeFront');
            const retryBadgeBack = document.getElementById('flashcardRetryBadgeBack');

            const frontSide = document.querySelector('.flashcard-front');
            const backSide = document.querySelector('.flashcard-back');
            if (frontSide) frontSide.scrollTop = 0;
            if (backSide) backSide.scrollTop = 0;

            if (isRetry) {
                setTimeout(() => {
                    document.getElementById('flashcardFront').textContent = card.front;        
                    retryBadgeFront.classList.remove('hidden');
                }, 0);
            
                setTimeout(() => {
                    document.getElementById('flashcardBack').textContent = card.back;
                    retryBadgeBack.classList.remove('hidden');
                }, 600);
            } else {
                setTimeout(() => {
                    document.getElementById('flashcardFront').textContent = card.front;
                    retryBadgeFront.classList.add('hidden');
                }, 0);
            
                setTimeout(() => {
                    document.getElementById('flashcardBack').textContent = card.back;
                    retryBadgeBack.classList.add('hidden');
                }, 600);
            }

            updateFlashcardProgress();
        }

        function flipCard() {
            if (!isTransitioning) {

                isTransitioning = true;

                const flashcardEl = document.getElementById('flashcard');
                if (!isCardFlipped) {
                    flashcardEl.classList.add('flipped');
                    isCardFlipped = true;
                    
                    setTimeout(() => {
                        document.getElementById('flashcardActions').style.display = 'flex';
                        const backSide = document.querySelector('.flashcard-back');
                        if (backSide) backSide.scrollTop = 0;
                        isTransitioning = false;
                    }, 600);
                } else {
                    flashcardEl.classList.remove('flipped');
                    isCardFlipped = false;
                    document.getElementById('flashcardActions').style.display = 'none';
                    
                    setTimeout(() => {
                        const frontSide = document.querySelector('.flashcard-front');
                        if (frontSide) frontSide.scrollTop = 0;
                        isTransitioning = false;
                    }, 600);
                }
            }
        }

        function rateCard(difficulty) {
            if (isTransitioning) return;

            isTransitioning = true;
            const currentItem = cardQueue[currentCardIndex];
            const isRetry = currentItem.isRetry;
            
            if (difficulty === 'easy') {
                if (!isRetry) {
                    flashcardStats.easy++;
                }
                completedCards.add(currentItem.originalIndex);
                answeredCardsCount++;
            } else if (difficulty === 'medium' || difficulty === 'hard') {
                if (!isRetry) {
                    flashcardStats[difficulty]++;
                }
                
                if (!retriedCards.has(currentItem.originalIndex)) {
                    cardQueue.push({
                        card: currentItem.card,
                        originalIndex: currentItem.originalIndex,
                        isRetry: true
                    });
                    retriedCards.add(currentItem.originalIndex);
                }
            }

            updateFlashcardStats();

            const flashcardEl = document.getElementById('flashcard');
            const actionsEl = document.getElementById('flashcardActions');
            actionsEl.style.display = 'none';

            currentCardIndex++;

            if (isCardFlipped) {
                flashcardEl.classList.remove('flipped');
                isCardFlipped = false;

                displayFlashcard();

                setTimeout(() => {
                    isTransitioning = false;
                }, 600);
            }
            else {
                flashcardEl.classList.add('flipped');
                
                setTimeout(() => {
                    flashcardEl.classList.remove('flipped');
                    
                    setTimeout(() => {
                        isTransitioning = false;
                        displayFlashcard();
                    }, 600);
                }, 50);
            }
        }

        function updateFlashcardProgress() {
            const totalCards = cards.length;
            const progress = (currentCardIndex / cardQueue.length) * 100;
            document.getElementById('flashcardProgress').style.width = `${progress}%`;
            document.getElementById('flashcardNumber').textContent = 
                `Fiszka ${answeredCardsCount}/${totalCards} (${currentCardIndex + 1}/${cardQueue.length})`;
        }

        function updateFlashcardStats() {
            document.getElementById('flashcardStats').textContent = 
                `Poznane: ${flashcardStats.easy} | Trudne: ${flashcardStats.medium + flashcardStats.hard}`;
        }

        function endFlashcardsEarly() {
            if (confirm('Czy na pewno chcesz zakończyć naukę? Postęp nie zostanie zapisany.')) {
                stopTimer();
                showHomeScreen();
            }
        }

        function endFlashcards() {
            stopTimer();
            const totalTime = (Date.now() - startTime) / 1000;
            const knownPercent = cards.length > 0 ? Math.round((flashcardStats.easy / cards.length) * 100) : 0;

            document.getElementById('flashcardEasyCount').textContent = flashcardStats.easy;
            document.getElementById('flashcardMediumCount').textContent = flashcardStats.medium;
            document.getElementById('flashcardHardCount').textContent = flashcardStats.hard;
            document.getElementById('flashcardFinalTime').textContent = `Czas: ${formatTime(totalTime)} · Znane: ${knownPercent}%`;
            
            saveFlashcardResult(currentFlashcards.id, {
                easy: flashcardStats.easy,
                medium: flashcardStats.medium,
                hard: flashcardStats.hard,
                total: cards.length,
                time: totalTime,
                date: new Date().toISOString()
            });
            
            hideAllScreens();
            document.getElementById('flashcardResultsScreen').classList.remove('hidden');
        }

        // ==================== HISTORY ====================
        function saveQuizResult(quizId, result) {
            const history = JSON.parse(localStorage.getItem('quizHistory') || '{}');
            if (!history[quizId]) {
                history[quizId] = [];
            }
            history[quizId].push(result);
            localStorage.setItem('quizHistory', JSON.stringify(history));
        }

        function saveFlashcardResult(flashcardId, result) {
            const history = JSON.parse(localStorage.getItem('flashcardHistory') || '{}');
            if (!history[flashcardId]) {
                history[flashcardId] = [];
            }
            history[flashcardId].push(result);
            localStorage.setItem('flashcardHistory', JSON.stringify(history));
        }

        function getQuizHistory(quizId) {
            const history = JSON.parse(localStorage.getItem('quizHistory') || '{}');
            return history[quizId] || [];
        }

        function getFlashcardHistory(flashcardId) {
            const history = JSON.parse(localStorage.getItem('flashcardHistory') || '{}');
            return history[flashcardId] || [];
        }

        function displayQuizHistory(quizId) {
            const history = getQuizHistory(quizId);
            const section = document.getElementById('quizHistorySection');
            const container = document.getElementById('quizHistory');
            
            if (history.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            const recent = history.slice(-5).reverse();
            
            container.innerHTML = `
                <div class="history-list">
                    ${recent.map(h => `
                        <div class="history-item">
                            <div class="history-info">
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    ${formatDate(h.date)}${h.incomplete ? ' (przerwany)' : ''}
                                </div>
                                <div style="font-size: 14px; margin-top: 4px;">
                                    ${h.points} pkt · Czas: ${formatTime(h.time)} · Seria: ${h.maxStreak}🔥
                                </div>
                            </div>
                            <div class="history-score">${h.percentage}%</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function displayFlashcardHistory(flashcardId) {
            const history = getFlashcardHistory(flashcardId);
            const section = document.getElementById('flashcardHistorySection');
            const container = document.getElementById('flashcardHistory');
            
            if (history.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            const recent = history.slice(-5).reverse();
            
            container.innerHTML = `
                <div class="history-list">
                    ${recent.map(h => {
                        const knownPercent = Math.round((h.easy / h.total) * 100);
                        return `
                            <div class="history-item">
                                <div class="history-info">
                                    <div style="font-size: 12px; color: var(--text-secondary);">
                                        ${formatDate(h.date)}
                                    </div>
                                    <div style="font-size: 14px; margin-top: 4px;">
                                        ✅${h.easy} 🤔${h.medium} ❌${h.hard} · Czas: ${formatTime(h.time)}
                                    </div>
                                </div>
                                <div class="history-score">${knownPercent}%</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // ==================== SHARING (FIX: STAŁY URL GitHub Pages) ====================
        function checkSharedQuiz() {
            const hash = window.location.hash;
            
            if (hash.startsWith('#q=')) {
                const compressed = hash.substring(3);
                
                try {
                    let jsonString = null;
                    
                    const base64 = compressed
                        .replace(/-/g, '+')
                        .replace(/_/g, '/');
                    
                    jsonString = LZString.decompressFromBase64(base64);
                    
                    if (!jsonString) {
                        jsonString = LZString.decompressFromEncodedURIComponent(compressed);
                    }
                    
                    if (!jsonString) {
                        throw new Error('Nie udało się zdekompresować danych');
                    }
                    
                    const quizData = JSON.parse(jsonString);

                    if (!validateQuizFormat(quizData)) {
                        throw new Error('Nieprawidłowy format udostępnionego quizu');
                    }

                    const decoded = decodeFromNewFormat(quizData);
                    
                    const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                    const exists = quizzes.find(q => q.data === decoded.data);
                    
                    if (exists) {
                        showToast('Quiz już istnieje w Twojej bibliotece!', 'info');
                        
                        if (decoded.type === 'flashcard') {
                            showFlashcardScreen(exists.id);
                        } else {
                            showPreQuizScreen(exists.id);
                        }
                    } else {
                        const newQuiz = {
                            title: decoded.title,
                            tags: decoded.tags,
                            type: decoded.type,
                            data: decoded.data,
                            answerCount: decoded.answerCount || 4,
                            id: Date.now().toString(),
                            createdAt: new Date().toISOString()
                        };

                        if (decoded.type === 'flashcard') {
                            newQuiz.cards = decoded.cards;
                        } else {
                            newQuiz.questions = decoded.questions;
                        }
                        
                        quizzes.push(newQuiz);
                        if (!safeLocalStorageSet('quizzes', JSON.stringify(quizzes))) {
                            showHomeScreen();
                            return;
                        }
                        
                        showToast('Quiz został dodany! 🎉', 'success');
                        
                        if (decoded.type === 'flashcard') {
                            showFlashcardScreen(newQuiz.id);
                        } else {
                            showPreQuizScreen(newQuiz.id);
                        }
                    }
                    
                    history.replaceState(null, null, window.location.pathname);
                    
                } catch (error) {
                    showToast('Błąd wczytywania udostępnionego quizu: ' + error.message, 'error');
                    showHomeScreen();
                }
            } else {
                showHomeScreen();
            }
        }

                async function shareQuiz(quizId) {

                    const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');

                    const quiz = quizzes.find(q => q.id === quizId);

                    

                    if (!quiz) {

                        showToast('Quiz nie znaleziony', 'error');

                        return;

                    }

                    

                    const shareData = encodeToNewFormat(quiz);

        

                    try {

                        const jsonString = JSON.stringify(shareData);

                        const compressed = LZString.compressToBase64(jsonString)

                            .replace(/\+/g, '-')

                            .replace(/\//g, '_')

                            .replace(/=/g, '');

                        

                        const baseUrl = 'https://tymoeks.github.io/quizapp/';

                        const fullUrl = `${baseUrl}#q=${compressed}`;

                        

                        const itemCount = quiz.type === 'flashcard' ? quiz.cards.length : quiz.questions.length;

                        const itemType = quiz.type === 'flashcard' ? 'fiszek' : 'pytań';

                        

                        let contentHtml = `

                            <div style="margin-bottom: 24px;">

                                <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">

                                    <strong>${quiz.title}</strong><br>

                                    ${itemCount} ${itemType}

                                </p>

                            </div>

                            <div style="background: var(--surface-alt); padding: 16px; border-radius: 8px; margin-bottom: 16px;">

                                <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">

                                    Link do udostępnienia:

                                </p>

                                <input type="text" value="${fullUrl}" readonly 

                                    style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; font-family: monospace; background: var(--surface); word-break: break-all;"

                                    onclick="this.select()" id="fullUrlInput">

                                <button class="btn btn-primary" onclick="copyToClipboard('${fullUrl.replace(/'/g, "\\'")}', 'Link skopiowany! 🔗')" 

                                    style="width: 100%; margin-top: 12px;">

                                    📋 Kopiuj link

                                </button>

                            </div>

                        `;

                        

                        if (fullUrl.length < 1000) {

                            contentHtml += `

                                <div style="background: var(--surface-alt); padding: 16px; border-radius: 8px; text-align: center;">

                                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">

                                        Kod QR:

                                    </p>

                                    <div id="qrcode" style="display: inline-block; padding: 12px; background: #ffffff; border-radius: 8px; box-sizing: border-box; line-height: 0;"></div>

                                </div>

                            `;

                        }

                        

                        document.getElementById('shareModal').classList.remove('hidden');

                        document.getElementById('shareContent').innerHTML = contentHtml;

                        

                        if (fullUrl.length < 1000) {

                            setTimeout(() => {

                                const qrDiv = document.getElementById('qrcode');

                                if (qrDiv) {

                                    qrDiv.innerHTML = '';

                                    new QRCode(qrDiv, {

                                        text: fullUrl,

                                        width: 160,

                                        height: 160,

                                        colorDark: '#2C3E50',

                                        colorLight: '#ffffff',

                                        correctLevel: QRCode.CorrectLevel.M

                                    });

                                }

                            }, 100);

                        }

                        

                    } catch (error) {

                        document.getElementById('shareModal').classList.remove('hidden');

                        document.getElementById('shareContent').innerHTML = `

                            <p style="color: var(--danger); text-align: center;">

                                ❌ Błąd: ${error.message}

                            </p>

                        `;

                    }

                }
        
        function copyToClipboard(text, message) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(message, 'success');
                closeModal('shareModal');
            }).catch(() => {
                showToast('Nie udało się skopiować', 'error');
            });
        }
        // ==================== IMPORT/EXPORT ====================
        function copyPrompt() {
            const prompt = document.getElementById('aiPrompt').textContent;
            navigator.clipboard.writeText(prompt).then(() => {
                showToast('Prompt skopiowany do schowka!', 'success');
            });
        }

        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('importJson').value = e.target.result;
            };
            reader.readAsText(file);
        }

        function importQuiz() {
            const jsonText = document.getElementById('importJson').value;
            
            try {
                const data = JSON.parse(jsonText);
                
                if (Array.isArray(data)) {
                    const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                    let addedCount = 0;
                    let skippedCount = 0;
                    let invalidCount = 0;
                    
                    data.forEach(quiz => {
                        if (!validateQuizFormat(quiz)) {
                            invalidCount++;
                            return;
                        }

                        const decoded = decodeFromNewFormat(quiz);
                        const exists = quizzes.find(q => q.data === decoded.data);
                        
                        if (exists) {
                            skippedCount++;
                            return;
                        }
                        
                        const newQuiz = {
                            title: decoded.title,
                            tags: decoded.tags,
                            type: decoded.type,
                            data: decoded.data,
                            answerCount: decoded.answerCount || 4,
                            id: Date.now().toString() + Math.random(),
                            createdAt: new Date().toISOString()
                        };

                        if (decoded.type === 'flashcard') {
                            newQuiz.cards = decoded.cards;
                        } else {
                            newQuiz.questions = decoded.questions;
                        }

                        quizzes.push(newQuiz);
                        addedCount++;
                    });
                    
                    if (!safeLocalStorageSet('quizzes', JSON.stringify(quizzes))) {
                        closeModal('importModal');
                        document.getElementById('importJson').value = '';
                        document.getElementById('importFile').value = '';
                        return;
                    }
                    
                    let message = `Zaimportowano ${addedCount} quizów`;
                    if (skippedCount > 0) message += `, pominięto ${skippedCount} duplikatów`;
                    if (invalidCount > 0) message += `, odrzucono ${invalidCount} nieprawidłowych`;
                    showToast(message, 'success');
                } else {
                    if (!validateQuizFormat(data)) {
                        throw new Error('Nieprawidłowy format JSON');
                    }

                    const decoded = decodeFromNewFormat(data);
                    const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                    const exists = quizzes.find(q => q.data === decoded.data);
                    
                    if (exists) {
                        showToast('Quiz już istnieje w bibliotece', 'info');
                        closeModal('importModal');
                        document.getElementById('importJson').value = '';
                        document.getElementById('importFile').value = '';
                        return;
                    }
                    
                    const quiz = {
                        title: decoded.title,
                        tags: decoded.tags,
                        type: decoded.type,
                        data: decoded.data,
                        answerCount: decoded.answerCount || 4,
                        id: Date.now().toString(),
                        createdAt: new Date().toISOString()
                    };

                    if (decoded.type === 'flashcard') {
                        quiz.cards = decoded.cards;
                    } else {
                        quiz.questions = decoded.questions;
                    }
                    
                    quizzes.push(quiz);
                    if (!safeLocalStorageSet('quizzes', JSON.stringify(quizzes))) {
                        closeModal('importModal');
                        document.getElementById('importJson').value = '';
                        document.getElementById('importFile').value = '';
                        return;
                    }
                    showToast('Quiz zaimportowany!', 'success');
                }
                
                closeModal('importModal');
                document.getElementById('importJson').value = '';
                document.getElementById('importFile').value = '';
                loadQuizzes();
            } catch (error) {
                showToast('Błąd importu: ' + error.message, 'error');
            }
        }

        function exportQuiz(quizId) {
            const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            const quiz = quizzes.find(q => q.id === quizId);
            
            if (!quiz) {
                showToast('Quiz nie znaleziony', 'error');
                return;
            }
            
            const exportData = encodeToNewFormat(quiz);
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${quiz.title.replace(/[^a-z0-9]/gi, '_')}.json`;
            
            setTimeout(() => {
                a.click();
                URL.revokeObjectURL(url);
                showToast('Quiz wyeksportowany!', 'success');
            }, 100);
        }

        function exportAllData() {
            const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            const history = JSON.parse(localStorage.getItem('quizHistory') || '{}');
            const flashcardHistory = JSON.parse(localStorage.getItem('flashcardHistory') || '{}');
            
            const exportQuizzes = quizzes.map(q => encodeToNewFormat(q));
            
            const backup = {
                version: '2.5',
                exportDate: new Date().toISOString(),
                quizzes: exportQuizzes,
                history: history,
                flashcardHistory: flashcardHistory
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quizapp_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Backup utworzony!', 'success');
        }

        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('Czy na pewno chcesz przywrócić dane? Obecne dane zostaną nadpisane!')) {
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (backup.quizzes) {
                        const validQuizzes = [];
                        let invalidCount = 0;

                        backup.quizzes.forEach(quiz => {
                            if (validateQuizFormat(quiz)) {
                                try {
                                    const decoded = decodeFromNewFormat(quiz);
                                    const restoredQuiz = {
                                        title: decoded.title,
                                        tags: decoded.tags,
                                        type: decoded.type,
                                        data: decoded.data,
                                        answerCount: decoded.answerCount || 4,
                                        id: Date.now().toString() + Math.random(),
                                        createdAt: new Date().toISOString()
                                    };

                                    if (decoded.type === 'flashcard') {
                                        restoredQuiz.cards = decoded.cards;
                                    } else {
                                        restoredQuiz.questions = decoded.questions;
                                    }

                                    validQuizzes.push(restoredQuiz);
                                } catch (err) {
                                    invalidCount++;
                                }
                            } else {
                                invalidCount++;
                            }
                        });

                        if (!safeLocalStorageSet('quizzes', JSON.stringify(validQuizzes))) {
                            event.target.value = '';
                            return;
                        }

                        if (invalidCount > 0) {
                            showToast(`Przywrócono dane (odrzucono ${invalidCount} nieprawidłowych quizów)`, 'success');
                        } else {
                            showToast('Dane przywrócone!', 'success');
                        }
                    }
                    if (backup.history) {
                        localStorage.setItem('quizHistory', JSON.stringify(backup.history));
                    }
                    if (backup.flashcardHistory) {
                        localStorage.setItem('flashcardHistory', JSON.stringify(backup.flashcardHistory));
                    }
                    
                    closeModal('backupModal');
                    loadQuizzes();
                } catch (error) {
                    showToast('Błąd przywracania: ' + error.message, 'error');
                }
                
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function showBackupModal() {
            const modal = document.getElementById('backupModal');
            modal.classList.remove('hidden');
            
            const quizzes = localStorage.getItem('quizzes') || '[]';
            const history = localStorage.getItem('quizHistory') || '{}';
            const flashcardHistory = localStorage.getItem('flashcardHistory') || '{}';
            const totalSize = (quizzes.length + history.length + flashcardHistory.length) / 1024;
            
            document.getElementById('dataSize').textContent = `${totalSize.toFixed(2)} KB`;
            document.getElementById('quizCount').textContent = JSON.parse(quizzes).length;
        }

        // ==================== KEYBOARD SHORTCUTS ====================
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                const activeScreen = document.querySelector('.screen:not(.hidden)');
                if (!activeScreen) return;
                
                if (activeScreen.id === 'quizScreen') {
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        endQuizEarly();
                    } else if (['1', '2', '3', '4'].includes(e.key)) {
                        const index = parseInt(e.key) - 1;
                        const buttons = document.querySelectorAll('.answer-btn:not(:disabled)');
                        if (buttons[index]) {
                            buttons[index].click();
                        }
                    }
                }
                
                if (activeScreen.id === 'flashcardScreen') {
                    if (e.key === ' ' || e.key === 'Spacebar') {
                        e.preventDefault();
                        flipCard();
                    } else if (e.key === '1') {
                        const btn = document.querySelector('.btn-hard:not(:disabled)');
                        if (btn && !isTransitioning) btn.click();
                    } else if (e.key === '2') {
                        const btn = document.querySelector('.btn-medium:not(:disabled)');
                        if (btn && !isTransitioning) btn.click();
                    } else if (e.key === '3') {
                        const btn = document.querySelector('.btn-easy:not(:disabled)');
                        if (btn && !isTransitioning) btn.click();
                    }
                }
            });
            
            const themeToggle = document.querySelector('.theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleTheme();
                    }
                });
            }
        }

        // ==================== TOAST SYSTEM ====================
        function showToast(message, type = 'info') {
            const newToast = { message, type };
            
            if (activeToast) {
                queuedToast = newToast;
                
                if (toastTimeout) clearTimeout(toastTimeout);
                hideActiveToast(500, 500);
            } else {
                displayToast(newToast);
            }
        }

        function displayToast(toastData) {
            const toast = document.createElement('div');
            toast.className = `toast ${toastData.type}`;
            toast.textContent = toastData.message;
            document.body.appendChild(toast);
            
            activeToast = toast;
            
            setTimeout(() => toast.classList.add('toast-show'), 10);
            
            const delay = queuedToast ? 500 : 3000;
            toastTimeout = setTimeout(() => hideActiveToast(300, delay), delay);
        }

        function hideActiveToast(animDelay, totalDelay) {
            if (!activeToast) return;
            
            const toast = activeToast;
            const waitTime = totalDelay ? totalDelay - animDelay : 0;
            
            setTimeout(() => {
                toast.classList.remove('toast-show');
                toast.classList.add('toast-hide');
                
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                    
                    if (activeToast === toast) {
                        activeToast = null;
                        
                        if (queuedToast) {
                            const next = queuedToast;
                            queuedToast = null;
                            displayToast(next);
                        }
                    }
                }, animDelay);
            }, waitTime);
        }

        // ==================== UTILITIES ====================
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            return `${day}.${month}.${year} ${hours}:${minutes}`;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function startTimer(elementId) {
            stopTimer();
            const startTime = Date.now();
            
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = formatTime(elapsed);
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function decodeHtml(html) {
            const txt = document.createElement('textarea');
            txt.innerHTML = html;
            return txt.value;
        }
    </script>
</body>
</html>
