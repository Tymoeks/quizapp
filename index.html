<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>QuizApp 2.5 - Twórz i rozwiązuj quizy oraz fiszki</title>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="" />
    <meta property="og:title" content="QuizApp 2.5 - Twórz i rozwiązuj quizy oraz fiszki" />
    <meta property="og:description" content="Profesjonalna platforma do tworzenia i rozwiązywania quizów i fiszek." />
    <meta property="og:locale" content="pl_PL" />
    <meta property="og:site_name" content="QuizApp 2.5" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="" />
    <meta name="twitter:title" content="QuizApp 2.5 - Twórz i rozwiązuj quizy oraz fiszki" />
    <meta name="twitter:description" content="Profesjonalna platforma do tworzenia i rozwiązywania quizów i fiszek." />

    <!-- Additional Meta Tags -->
    <meta name="description" content="Profesjonalna platforma do tworzenia i rozwiązywania quizów i fiszek." />
    <meta name="author" content="QuizApp 2.5" />
    <meta name="theme-color" content="#6366f1" />

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        /* ==================== CSS RESET ==================== */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ==================== CSS VARIABLES ==================== */
        :root {
            /* Primary Colors */
            --primary-50: #eef2ff;
            --primary-100: #e0e7ff;
            --primary-200: #c7d2fe;
            --primary-300: #a5b4fc;
            --primary-400: #818cf8;
            --primary-500: #6366f1;
            --primary-600: #4f46e5;
            --primary-700: #4338ca;
            --primary-800: #3730a3;
            --primary-900: #312e81;

            /* Neutral Colors */
            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;

            /* Semantic Colors */
            --success-50: #ecfdf5;
            --success-500: #10b981;
            --success-600: #059669;
            --danger-50: #fef2f2;
            --danger-500: #ef4444;
            --danger-600: #dc2626;
            --warning-50: #fffbeb;
            --warning-500: #f59e0b;
            --warning-600: #d97706;

            /* Theme Variables - Light Mode */
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-elevated: #ffffff;
            --bg-overlay: rgba(15, 23, 42, 0.5);
            
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --text-inverse: #ffffff;
            
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            --border-focus: #6366f1;
            
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.15);
            --shadow-card: 0 1px 3px rgba(0, 0, 0, 0.08), 0 8px 24px rgba(0, 0, 0, 0.04);
            
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-secondary: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --gradient-hero: radial-gradient(ellipse at top, #e0e7ff 0%, transparent 50%);
            --gradient-card: linear-gradient(180deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.4) 100%);
            
            /* Spacing Scale */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;
            --space-16: 64px;
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 20px;
            --radius-2xl: 28px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 500ms cubic-bezier(0.34, 1.56, 0.64, 1);
            
            /* Typography */
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-mono: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, monospace;
            
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
            --text-4xl: 2.25rem;
            --text-5xl: 3rem;
            
            --leading-tight: 1.25;
            --leading-normal: 1.5;
            --leading-relaxed: 1.625;
            
            --tracking-tight: -0.025em;
            --tracking-normal: 0;
            --tracking-wide: 0.025em;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-elevated: #1e293b;
            --bg-overlay: rgba(0, 0, 0, 0.7);
            
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-tertiary: #64748b;
            --text-inverse: #0f172a;
            
            --border-light: #334155;
            --border-medium: #475569;
            --border-focus: #818cf8;
            
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.4), 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
            --shadow-glow: 0 0 30px rgba(99, 102, 241, 0.2);
            --shadow-card: 0 1px 3px rgba(0, 0, 0, 0.2), 0 8px 24px rgba(0, 0, 0, 0.15);
            
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-secondary: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            --gradient-hero: radial-gradient(ellipse at top, rgba(99, 102, 241, 0.15) 0%, transparent 50%);
            --gradient-card: linear-gradient(180deg, rgba(30,41,59,0.9) 0%, rgba(30,41,59,0.7) 100%);
        }

        /* ==================== BASE STYLES ==================== */
        html {
            overflow-x: hidden;
            width: 100%;
            height: 100%;
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: var(--font-sans);
            font-size: var(--text-base);
            line-height: var(--leading-normal);
            color: var(--text-primary);
            background: var(--bg-primary);
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color var(--transition-slow), color var(--transition-slow);
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Background Decoration */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 100vh;
            background: var(--gradient-hero);
            pointer-events: none;
            z-index: -1;
        }

        /* ==================== TYPOGRAPHY ==================== */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: var(--leading-tight);
            letter-spacing: var(--tracking-tight);
            color: var(--text-primary);
        }

        h1 {
            font-size: var(--text-4xl);
            font-weight: 700;
        }

        h2 {
            font-size: var(--text-2xl);
            margin-bottom: var(--space-6);
        }

        h3 {
            font-size: var(--text-lg);
            margin-bottom: var(--space-3);
        }

        p {
            color: var(--text-secondary);
            line-height: var(--leading-relaxed);
        }

        /* ==================== LAYOUT ==================== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-10) var(--space-5);
            position: relative;
            z-index: 1;
        }

        .hidden {
            display: none !important;
        }

        /* ==================== HEADER ==================== */
        .header {
            text-align: center;
            margin-bottom: var(--space-12);
            padding: var(--space-10) 0;
            position: relative;
        }

        .header-logo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .header-logo h1 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-logo .logo-emoji {
            font-size: var(--text-4xl);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .header p {
            font-size: var(--text-lg);
            color: var(--text-secondary);
            max-width: 500px;
            margin: 0 auto;
        }

        .header-actions {
            display: flex;
            justify-content: center;
            gap: var(--space-3);
            margin-top: var(--space-6);
            flex-wrap: wrap;
        }

        /* ==================== THEME TOGGLE ==================== */
        .theme-toggle {
            position: fixed;
            top: var(--space-5);
            right: var(--space-5);
            z-index: 1000;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: var(--text-xl);
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-base);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .theme-toggle:hover {
            transform: scale(1.08);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-medium);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        /* ==================== SCREEN READER ==================== */
        .sr-only {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
    </style>
    <style>
        /* ==================== BUTTONS ==================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-5);
            min-height: 44px;
            font-family: inherit;
            font-size: var(--text-sm);
            font-weight: 500;
            line-height: 1.2;
            color: var(--text-primary);
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            text-decoration: none;
            -webkit-tap-highlight-color: transparent;
            box-shadow: var(--shadow-xs);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        @media (hover: hover) and (pointer: fine) {
            .btn:hover:not(:disabled) {
                background: var(--bg-tertiary);
                border-color: var(--border-medium);
                transform: translateY(-1px);
                box-shadow: var(--shadow-sm);
            }
        }

        .btn:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
        }

        /* Primary Button */
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            border: none;
            box-shadow: var(--shadow-sm), 0 2px 8px rgba(99, 102, 241, 0.25);
        }
        
        @media (hover: hover) and (pointer: fine) {
            .btn-primary:hover:not(:disabled) {
                background: linear-gradient(135deg, #5558e8 0%, #7c5ed4 100%);
                box-shadow: var(--shadow-md), 0 4px 12px rgba(99, 102, 241, 0.3);
                transform: translateY(-1px);
            }
        }
        
        [data-theme="dark"] .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #7578f5 0%, #9d7fea 100%);
        }
        
        /* Accent Button */
        .btn-accent {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            color: white;
            border: none;
            box-shadow: var(--shadow-sm), 0 2px 8px rgba(99, 102, 241, 0.25);
        }
        
        @media (hover: hover) and (pointer: fine) {
            .btn-accent:hover:not(:disabled) {
                background: linear-gradient(135deg, #5558e8 0%, #4338ca 100%);
                box-shadow: var(--shadow-md), 0 4px 12px rgba(99, 102, 241, 0.3);
                transform: translateY(-1px);
            }
        }
        
        [data-theme="dark"] .btn-accent:hover:not(:disabled) {
            background: linear-gradient(135deg, #7578f5 0%, #5e51e0 100%);
        }
        
        /* Success Button */
        .btn-success {
            background: linear-gradient(135deg, var(--success-500) 0%, var(--success-600) 100%);
            color: white;
            border: none;
            box-shadow: var(--shadow-sm), 0 2px 8px rgba(16, 185, 129, 0.25);
        }
        
        @media (hover: hover) and (pointer: fine) {
            .btn-success:hover:not(:disabled) {
                background: linear-gradient(135deg, #0ea271 0%, #047a57 100%);
                box-shadow: var(--shadow-md), 0 4px 12px rgba(16, 185, 129, 0.3);
                transform: translateY(-1px);
            }
        }
        
        [data-theme="dark"] .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, #22d39a 0%, #10b981 100%);
        }
        
        /* Danger Button */
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-500) 0%, var(--danger-600) 100%);
            color: white;
            border: none;
            box-shadow: var(--shadow-sm), 0 2px 8px rgba(239, 68, 68, 0.25);
        }
        
        @media (hover: hover) and (pointer: fine) {
            .btn-danger:hover:not(:disabled) {
                background: linear-gradient(135deg, #e03131 0%, #c41e1e 100%);
                box-shadow: var(--shadow-md), 0 4px 12px rgba(239, 68, 68, 0.3);
                transform: translateY(-1px);
            }
        }
        
        [data-theme="dark"] .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #f56565 0%, #ef4444 100%);
        }        /* Small Button */
        .btn-small {
            padding: var(--space-2) var(--space-4);
            min-height: 36px;
            font-size: var(--text-xs);
            border-radius: var(--radius-md);
        }

        /* Button Group */
        .button-group {
            display: flex;
            gap: var(--space-3);
            margin-top: var(--space-8);
            flex-wrap: wrap;
        }

        .button-group.center {
            justify-content: center;
        }

        /* ==================== CARDS ==================== */
        .card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-card);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity var(--transition-base);
            z-index: 10;
        }
        
        @media (hover: hover) and (pointer: fine) {
            .card:hover::before {
                opacity: 1;
            }
        }
        
        .card-white {
            background: var(--bg-elevated);
            box-shadow: var(--shadow-lg);
        }
        
        /* Disable hover effect on results screens */
        .results-screen.card::before {
            display: none;
        }
        /* ==================== FORM ELEMENTS ==================== */
        .form-group {
            margin-bottom: var(--space-6);
        }

        .form-group label {
            display: block;
            font-weight: 500;
            font-size: var(--text-sm);
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }

        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            font-family: inherit;
            font-size: var(--text-base);
            color: var(--text-primary);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            transition: all var(--transition-base);
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        .form-group textarea {
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            resize: vertical;
            min-height: 200px;
            line-height: var(--leading-relaxed);
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--border-focus);
            background: var(--bg-elevated);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-tertiary);
        }

        /* Select */
        select {
            padding: var(--space-2) var(--space-3);
            padding-right: var(--space-8);
            font-family: inherit;
            font-size: var(--text-sm);
            color: var(--text-primary);
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            cursor: pointer;
            min-width: 120px;
            transition: all var(--transition-base);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        select:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        /* Checkbox */
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-500);
            border-radius: var(--radius-sm);
        }

        /* Toggle Switch */
        .toggle {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border-medium);
            border-radius: var(--radius-full);
            transition: all var(--transition-base);
        }

        .slider::before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: var(--radius-full);
            transition: all var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        input:checked + .slider {
            background: var(--gradient-primary);
        }

        input:checked + .slider::before {
            transform: translateX(22px);
        }

        input:focus + .slider {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        /* Tag Input */
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            min-height: 44px;
            align-items: center;
            transition: all var(--transition-base);
        }

        .tag-input-container:focus-within {
            border-color: var(--border-focus);
            background: var(--bg-elevated);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .tag-input-container input {
            border: none;
            background: transparent;
            flex: 1;
            min-width: 120px;
            padding: var(--space-1);
            font-size: var(--text-sm);
            color: var(--text-primary);
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        .tag-input-container input:focus {
            outline: none;
        }

        .tag-removable {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            background: var(--gradient-primary);
            color: white;
            font-size: var(--text-xs);
            font-weight: 500;
            border-radius: var(--radius-full);
        }

        .tag-removable button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            padding: 0;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: var(--radius-full);
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .tag-removable button:hover {
            background: rgba(255, 255, 255, 0.35);
        }

        /* ==================== SEARCH BAR ==================== */
        .search-bar {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--space-4) var(--space-5);
            margin-bottom: var(--space-6);
            display: flex;
            gap: var(--space-3);
            flex-wrap: wrap;
            align-items: center;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
        }

        .search-bar:focus-within {
            box-shadow: var(--shadow-md), var(--shadow-glow);
            border-color: var(--border-focus);
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: var(--space-3) var(--space-4);
            font-family: inherit;
            font-size: var(--text-sm);
            color: var(--text-primary);
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            transition: all var(--transition-base);
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        .search-input:focus {
            outline: none;
            background: var(--bg-elevated);
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-tertiary);
        }

        .filter-group {
            display: flex;
            gap: var(--space-2);
            align-items: center;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .search-bar .filter-group {
                width: 100%;
                flex-wrap: nowrap;
            }
            
            .search-bar .filter-btn {
                flex: 1;
                min-width: 0;
                padding: var(--space-2) var(--space-2);
                font-size: var(--text-xs);
            }
        }
        .filter-btn {
            padding: var(--space-2) var(--space-4);
            font-family: inherit;
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-base);
            min-height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filter-btn:hover {
            background: var(--primary-100);
            color: var(--primary-600);
        }

        [data-theme="dark"] .filter-btn:hover {
            background: var(--primary-900);
            color: var(--primary-300);
        }

        .filter-btn.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
        }

        /* ==================== QUIZ LIST ==================== */
        .quiz-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: var(--space-5);
            margin-bottom: var(--space-10);
        }

        .quiz-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            padding: var(--space-6);
            padding-left: calc(var(--space-6) + 40px);
            padding-bottom: calc(var(--space-6) + 36px);
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-card);
            -webkit-tap-highlight-color: transparent;
        }

        @media (hover: hover) and (pointer: fine) {
            .quiz-item:hover {
                transform: translateY(-4px);
                box-shadow: var(--shadow-xl);
                border-color: var(--primary-200);
            }
        
            [data-theme="dark"] .quiz-item:hover {
                border-color: var(--primary-800);
            }
        }
        @media (hover: none) and (pointer: coarse) {
            .quiz-item:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
        }

        .quiz-item.selected {
            border-color: var(--primary-500);
            background: var(--primary-50);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        [data-theme="dark"] .quiz-item.selected {
            background: var(--primary-900);
        }

        .quiz-checkbox {
            position: absolute;
            top: var(--space-3);
            right: var(--space-3);
            width: 20px;
            height: 20px;
            z-index: 10;
            margin: 0;
            cursor: pointer;
        }

        .quiz-item h3 {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-1);
            line-height: var(--leading-tight);
        }

        .quiz-item p {
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        .quiz-type-icon {
            position: absolute;
            top: var(--space-4);
            left: var(--space-4);
            font-size: var(--text-2xl);
            opacity: 0.85;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        .quiz-stats-badge {
            position: absolute;
            bottom: var(--space-4);
            left: var(--space-4);
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
        }

        .quiz-date {
            position: absolute;
            bottom: var(--space-4);
            right: var(--space-4);
            font-size: var(--text-xs);
            color: var(--text-tertiary);
        }

        .quiz-tags {
            display: flex;
            gap: var(--space-1);
            flex-wrap: wrap;
            margin-top: var(--space-2);
        }

        .tag {
            font-size: 10px;
            font-weight: 500;
            padding: 2px var(--space-2);
            background: var(--primary-100);
            color: var(--primary-700);
            border-radius: var(--radius-full);
        }

        [data-theme="dark"] .tag {
            background: var(--primary-900);
            color: var(--primary-300);
        }

        /* Batch Actions Bar */
        #batchActions {
            background: var(--primary-50);
            border-color: var(--primary-200);
        }
        
        [data-theme="dark"] #batchActions {
            background: var(--primary-900);
            border-color: var(--primary-800);
        }
        
        @media (max-width: 768px) {
            #batchActions {
                justify-content: center;
                text-align: center;
            }
            
            #batchActions > span {
                width: 100%;
                margin-bottom: var(--space-2);
            }
            
            #batchActions .filter-group {
                width: 100%;
                justify-content: center;
            }
        }
        /* Top Buttons Container */
        #topButtons {
            text-align: center;
            display: flex;
            gap: var(--space-3);
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: var(--space-6);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-16) var(--space-5);
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: var(--space-4);
            opacity: 0.4;
            filter: grayscale(50%);
        }

        .empty-state h3 {
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }

        /* ==================== AI PROMPT BOX ==================== */
        .ai-prompt {
            background: var(--gradient-secondary);
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }

        .ai-prompt::after {
            content: "✨";
            position: absolute;
            bottom: -15px;
            right: -15px;
            font-size: 80px;
            opacity: 0.06;
            transform: rotate(-15deg);
            pointer-events: none;
        }

        .ai-prompt h3 {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-4);
        }

        .ai-prompt pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            font-family: var(--font-mono);
            font-size: var(--text-xs);
            line-height: var(--leading-relaxed);
            color: var(--text-secondary);
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        /* ==================== QUIZ SETTINGS ==================== */
        .quiz-settings {
            background: var(--bg-tertiary);
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-8);
            border: 1px solid var(--border-light);
        }

        .quiz-settings h3 {
            font-size: var(--text-base);
            margin-bottom: var(--space-4);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) 0;
            border-bottom: 1px solid var(--border-light);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-row label {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-primary);
        }
    </style>
    <style>
        /* ==================== QUIZ SCREEN ==================== */
        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-bottom: var(--space-10);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            transition: width var(--transition-slow);
            position: relative;
        }

        .progress-fill {
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.35) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Stats Bar */
        .stats {
            display: flex;
            justify-content: center;
            gap: var(--space-6);
            margin-bottom: var(--space-8);
            font-size: var(--text-sm);
            color: var(--text-secondary);
            background: var(--bg-elevated);
            padding: var(--space-4) var(--space-6);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            flex-wrap: wrap;
            box-shadow: var(--shadow-sm);
        }

        .stats span {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .stats span::before {
            content: "";
            width: 6px;
            height: 6px;
            background: var(--primary-500);
            border-radius: var(--radius-full);
        }

        /* Question Card */
        .question-card {
            background: var(--bg-elevated);
            padding: var(--space-12) var(--space-8);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            margin-bottom: var(--space-8);
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-light);
        }

        .question-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .question-card h2 {
            font-weight: 500;
            font-size: var(--text-xl);
            line-height: var(--leading-relaxed);
            margin-bottom: var(--space-10);
            margin-top: var(--space-4);
            color: var(--text-primary);
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        .question-category {
            position: absolute;
            top: var(--space-5);
            left: var(--space-5);
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
        }

        .retry-badge {
            position: absolute;
            top: var(--space-5);
            right: var(--space-5);
            font-size: var(--text-xs);
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--warning-500) 0%, var(--warning-600) 100%);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            z-index: 10;
        }

        /* Answers Grid */
        .answers-grid {
            display: grid;
            gap: var(--space-3);
            max-width: 550px;
            margin: 0 auto;
        }

        .answers-grid.two-answers {
            grid-template-columns: repeat(2, 1fr);
        }

        .answers-grid.four-answers {
            grid-template-columns: repeat(2, 1fr);
        }

        .answer-btn {
            padding: var(--space-5) var(--space-6);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            font-family: inherit;
            font-size: var(--text-base);
            font-weight: 500;
            color: var(--text-primary);
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: all var(--transition-base);
            text-align: center;
            min-height: 72px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
            -webkit-tap-highlight-color: transparent;
        }

        @media (hover: hover) and (pointer: fine) {
            .answer-btn:hover:not(:disabled) {
                border-color: var(--primary-400);
                background: var(--bg-elevated);
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .answer-btn:active:not(:disabled) {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
        }

        .answer-btn:disabled {
            cursor: not-allowed;
        }

        .answer-btn.correct {
            background: linear-gradient(135deg, var(--success-500) 0%, var(--success-600) 100%);
            border-color: var(--success-500);
            color: white;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.35);
        }

        .answer-btn.incorrect {
            background: linear-gradient(135deg, var(--danger-500) 0%, var(--danger-600) 100%);
            border-color: var(--danger-500);
            color: white;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.35);
        }

        .answer-letter {
            position: absolute;
            top: var(--space-2);
            left: var(--space-2);
            width: 24px;
            height: 24px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-xs);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .answer-btn.correct .answer-letter,
        .answer-btn.incorrect .answer-letter {
            background: rgba(255, 255, 255, 0.2);
            border-color: transparent;
            color: white;
        }

        /* ==================== TYPE SELECTION ==================== */
        .type-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: var(--space-6);
            margin: var(--space-8) 0;
        }

        .type-option {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-base);
            width: 100%;
            font-family: inherit;
            display: block;
            position: relative;
            overflow: hidden;
        }
        
        .type-option:hover {
            border-color: var(--primary-400);
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        .type-icon {
            font-size: 56px;
            margin-bottom: var(--space-4);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .type-option h3 {
            font-size: var(--text-lg);
            margin-bottom: var(--space-2);
            color: var(--text-primary);
        }

        .type-option p {
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        /* ==================== FLASHCARDS ==================== */
        .flashcard-container {
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: var(--space-10);
        }

        .flashcard-wrapper {
            perspective: 1200px;
            margin-bottom: var(--space-6);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .flashcard {
            width: 100%;
            height: 380px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            touch-action: manipulation;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-side {
            width: 100%;
            height: 380px;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 0;
            text-align: center;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            position: absolute;
            top: 0;
            left: 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .flashcard-side::-webkit-scrollbar {
            display: none;
        }

        .flashcard-front {
            z-index: 2;
            transform: rotateY(0deg);
        }

        .flashcard-front::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .flashcard-back {
            transform: rotateY(-180deg);
            background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-tertiary) 100%);
        }

        .flashcard-back::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--success-500) 0%, var(--success-600) 100%);
        }

        .flashcard-content {
            font-size: var(--text-xl);
            font-weight: 500;
            color: var(--text-primary);
            word-wrap: break-word;
            overflow-wrap: break-word;
            width: 100%;
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--space-12) var(--space-8);
            line-height: var(--leading-relaxed);
            -webkit-touch-callout: none;
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
            touch-action: pan-y;
        }

        .flashcard-hint {
            text-align: center;
            margin-top: var(--space-4);
            color: var(--text-tertiary);
            font-size: var(--text-sm);
        }

        .flashcard-actions {
            display: flex;
            gap: var(--space-3);
            justify-content: center;
            margin-top: var(--space-6);
            flex-shrink: 0;
            width: 100%;
            max-width: 500px;
        }

        .flashcard-btn {
            padding: var(--space-3) var(--space-5);
            min-height: 48px;
            border: none;
            border-radius: var(--radius-lg);
            font-family: inherit;
            font-size: var(--text-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            flex: 1;
            min-width: 0;
            -webkit-tap-highlight-color: transparent;
            color: white;
        }

        @media (hover: hover) and (pointer: fine) {
            .flashcard-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .flashcard-btn:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
        }

        .btn-hard {
            background: linear-gradient(135deg, var(--danger-500) 0%, var(--danger-600) 100%);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-medium {
            background: linear-gradient(135deg, var(--warning-500) 0%, var(--warning-600) 100%);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .btn-easy {
            background: linear-gradient(135deg, var(--success-500) 0%, var(--success-600) 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        /* ==================== RESULTS SCREEN ==================== */
        .results-screen {
            text-align: center;
            padding: var(--space-12);
            position: relative;
        }
        
        .results-screen::after {
            content: "🏆";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 180px;
            opacity: 0.04;
            pointer-events: none;
            z-index: 0;
            user-select: none;
        }
        
        .results-screen > * {
            position: relative;
            z-index: 1;
        }
        .score-display {
            font-size: var(--text-5xl);
            font-weight: 700;
            margin-bottom: var(--space-4);
            letter-spacing: var(--tracking-tight);
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .points-display {
            font-size: var(--text-xl);
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        .time-display {
            font-size: var(--text-base);
            color: var(--text-tertiary);
            margin-bottom: var(--space-8);
        }

        /* Flashcard Results Stats */
        .flashcard-results-stats {
            display: flex;
            justify-content: center;
            gap: var(--space-8);
            margin: var(--space-8) 0;
            flex-wrap: wrap;
        }

        .flashcard-stat-item {
            text-align: center;
            min-width: 100px;
        }

        .flashcard-stat-value {
            font-size: var(--text-4xl);
            font-weight: 700;
            line-height: 1;
            margin-bottom: var(--space-2);
        }

        .flashcard-stat-value.easy {
            color: var(--success-500);
        }

        .flashcard-stat-value.medium {
            color: var(--warning-500);
        }

        .flashcard-stat-value.hard {
            color: var(--danger-500);
        }

        .flashcard-stat-label {
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        /* ==================== MODALS ==================== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-overlay);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: var(--space-5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            animation: modalFadeIn var(--transition-base) ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: var(--bg-elevated);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            max-width: 550px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            border: 1px solid var(--border-light);
            animation: modalSlideIn var(--transition-slow) cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
        }

        .modal-header h2 {
            margin-bottom: 0;
            font-size: var(--text-xl);
        }

        .modal-close {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: var(--radius-full);
            font-size: var(--text-xl);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .modal-close:hover {
            background: var(--danger-50);
            color: var(--danger-500);
            transform: rotate(90deg);
        }

        [data-theme="dark"] .modal-close:hover {
            background: rgba(239, 68, 68, 0.15);
        }

        /* Share Modal Specific */
        #shareContent {
            animation: fadeInContent var(--transition-slow) ease-out;
        }

        @keyframes fadeInContent {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ==================== TOASTS ==================== */
        .toast {
            position: fixed;
            bottom: var(--space-5);
            right: var(--space-5);
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 3000;
            max-width: 360px;
            min-width: 280px;
            overflow: hidden;
        }
        
        .toast-content {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4) var(--space-5);
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-sm);
            font-weight: 700;
            flex-shrink: 0;
            color: white;
        }
        
        .toast.success .toast-icon {
            background: var(--success-500);
        }
        
        .toast.error .toast-icon {
            background: var(--danger-500);
        }
        
        .toast.info .toast-icon {
            background: var(--primary-500);
        }
        
        .toast-message {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
            line-height: var(--leading-normal);
        }
        
        .toast-progress {
            height: 3px;
            width: 100%;
            background: var(--border-light);
        }
        
        .toast-progress-bar {
            height: 100%;
            width: 100%;
            transform-origin: right;
        }
        
        .toast.success .toast-progress-bar {
            background: var(--success-500);
        }
        
        .toast.error .toast-progress-bar {
            background: var(--danger-500);
        }
        
        .toast.info .toast-progress-bar {
            background: var(--primary-500);
        }
        
        @keyframes toastSlideIn {
            from {
                transform: translateX(120%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes toastSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(120%);
                opacity: 0;
            }
        }
        
        @keyframes toastProgressShrink {
            from {
                transform: scaleX(1);
            }
            to {
                transform: scaleX(0);
            }
        }        /* ==================== ANIMATIONS ==================== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(12px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-16px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: translateX(-6px); }
            80% { transform: translateX(6px); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .animate-fadeIn {
            animation: fadeIn var(--transition-slow) ease-out;
        }

        .animate-slideIn {
            animation: slideIn var(--transition-slow) ease-out;
        }

        .animate-shake {
            animation: shake 0.5s ease;
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        /* ==================== UTILITY CLASSES ==================== */
        .mobile-only {
            display: none;
        }

        .desktop-only {
            display: inline;
        }

        /* ==================== RESPONSIVE STYLES ==================== */
        @media (max-width: 768px) {
            .mobile-only {
                display: inline;
            }

            .desktop-only {
                display: none;
            }

            :root {
                --space-10: 32px;
                --space-12: 40px;
            }

            .container {
                padding: var(--space-6) var(--space-4);
            }

            h1 {
                font-size: var(--text-2xl);
            }

            h2 {
                font-size: var(--text-xl);
            }

            .header {
                margin-bottom: var(--space-8);
                padding: var(--space-6) 0;
            }

            .header p {
                font-size: var(--text-base);
            }

            .header-actions {
                gap: var(--space-2);
            }

            .header-logo .logo-emoji {
                font-size: var(--text-2xl);
            }

            /* Theme Toggle Mobile */
            .theme-toggle {
                top: var(--space-3);
                right: var(--space-3);
                width: 42px;
                height: 42px;
                font-size: var(--text-lg);
            }

            /* Buttons Mobile */
            .btn {
                padding: var(--space-3) var(--space-5);
                min-height: 48px;
                font-size: var(--text-base);
            }

            .btn-small {
                padding: var(--space-2) var(--space-4);
                min-height: 40px;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group .btn {
                width: 100%;
            }

            /* Cards Mobile */
            .card {
                padding: var(--space-6);
                border-radius: var(--radius-lg);
            }

            /* Search Bar Mobile */
            .search-bar {
                flex-direction: column;
                padding: var(--space-4);
                border-radius: var(--radius-lg);
            }

            .search-input {
                width: 100%;
            }

            /* Removed - handled in main filter-group styles */
            /* Quiz List Mobile */
            .quiz-list {
                grid-template-columns: 1fr;
                gap: var(--space-4);
            }

            .quiz-item {
                padding: var(--space-5);
                padding-left: calc(var(--space-5) + 36px);
                padding-bottom: calc(var(--space-5) + 32px);
                border-radius: var(--radius-lg);
            }

            .quiz-type-icon {
                font-size: var(--text-xl);
            }

            /* Question Card Mobile */
            .question-card {
                padding: var(--space-6) var(--space-4);
                border-radius: var(--radius-xl);
            }

            .question-card h2 {
                font-size: var(--text-lg);
                padding-top: var(--space-6);
                margin-bottom: var(--space-8);
            }

            .answers-grid {
                grid-template-columns: 1fr !important;
            }

            .answer-btn {
                min-height: 64px;
                padding: var(--space-4) var(--space-5);
                font-size: var(--text-base);
            }

            /* Stats Mobile */
            .stats {
                flex-direction: column;
                gap: var(--space-2);
                padding: var(--space-3);
            }

            .results-screen .stats {
                flex-direction: row !important;
                flex-wrap: wrap;
                justify-content: center;
            }

            /* Flashcards Mobile */
            .flashcard {
                height: 320px;
            }

            .flashcard-side {
                height: 320px;
            }

            .flashcard-content {
                font-size: var(--text-lg);
                padding: var(--space-10) var(--space-5);
            }

            .flashcard-btn {
                padding: var(--space-3) var(--space-4);
                font-size: var(--text-sm);
                min-height: 48px;
            }

            /* Results Mobile */
            .results-screen {
                padding: var(--space-8) var(--space-4);
            }

            .score-display {
                font-size: var(--text-4xl);
            }

            .flashcard-results-stats {
                gap: var(--space-4);
            }

            .flashcard-stat-value {
                font-size: var(--text-3xl);
            }

            /* Type Selection Mobile */
            .type-selection {
                grid-template-columns: 1fr;
            }

            .type-option {
                padding: var(--space-6);
            }

            .type-icon {
                font-size: 48px;
            }

            /* Modal Mobile */
            .modal {
                padding: var(--space-4);
            }

            .modal-content {
                padding: var(--space-6) var(--space-4);
                border-radius: var(--radius-xl);
                max-height: 90vh;
            }

            /* Toast Mobile */
            @media (max-width: 768px) {
                .toast {
                    left: var(--space-4);
                    right: var(--space-4);
                    bottom: var(--space-4);
                    max-width: none;
                    min-width: unset;
                }
            }            /* Form Elements Mobile */
            input[type="text"],
            textarea,
            select {
                font-size: 16px; /* Prevents iOS zoom */
            }

            /* AI Prompt Mobile */
            .ai-prompt {
                padding: var(--space-4);
            }

            .ai-prompt pre {
                font-size: 11px;
            }

            /* Quiz Settings Mobile */
            .quiz-settings {
                padding: var(--space-4);
            }
        }

        @media (max-width: 480px) {
            .header-logo h1 {
                font-size: var(--text-xl);
            }

            .flashcard {
                height: 280px;
            }

            .flashcard-side {
                height: 280px;
            }

            .flashcard-actions {
                flex-direction: column;
            }

            .flashcard-btn {
                width: 100%;
            }

            .filter-group {
                flex-wrap: wrap;
            }

            .filter-btn {
                min-width: calc(50% - var(--space-1));
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            .progress-fill::after {
                animation: none;
            }
        }
    </style>
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <button
        class="theme-toggle"
        onclick="toggleTheme()"
        title="Przełącz motyw"
        aria-label="Przełącz motyw ciemny/jasny"
    >
        <span id="themeIcon" aria-hidden="true">🌙</span>
    </button>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-logo">
                <h1>QuizApp 2.5</h1>
            </div>
            <p>Profesjonalna platforma do tworzenia i rozwiązywania quizów i fiszek</p>
            <div class="header-actions">
                <button class="btn btn-accent btn-small" onclick="showImportModal()">
                    📥 Import
                </button>
                <button class="btn btn-small" onclick="showBackupModal()">
                    💾 Backup
                </button>
            </div>
        </header>

        <!-- ==================== HOME SCREEN ==================== -->
        <section id="homeScreen" class="screen animate-fadeIn">
            <!-- Search Bar -->
            <div class="search-bar">
                <input
                    type="text"
                    class="search-input"
                    id="searchInput"
                    placeholder="🔍 Szukaj quizów..."
                    oninput="filterQuizzes()"
                    aria-label="Wyszukaj quizy"
                />
                <div class="filter-group" role="group" aria-label="Filtry">
                    <button
                        class="filter-btn active"
                        data-filter="all"
                        onclick="setFilter('all')"
                        aria-pressed="true"
                    >
                        Wszystkie
                    </button>
                    <button
                        class="filter-btn"
                        data-filter="quiz"
                        onclick="setFilter('quiz')"
                        aria-pressed="false"
                    >
                        📊 Quizy
                    </button>
                    <button
                        class="filter-btn"
                        data-filter="flashcard"
                        onclick="setFilter('flashcard')"
                        aria-pressed="false"
                    >
                        🎴 Fiszki
                    </button>
                </div>
            </div>

            <!-- Top Action Buttons -->
            <div id="topButtons">
                <button class="btn btn-primary" onclick="showChooseTypeScreen()">
                    ➕ Utwórz nowy
                </button>
                <button class="btn" onclick="toggleSelectionMode()" id="selectionModeBtn">
                    ☑️ Zaznacz wiele
                </button>
            </div>

            <!-- Batch Actions (hidden by default) -->
            <div id="batchActions" class="search-bar hidden">
                <span id="selectedCount" style="font-weight: 600;">0 zaznaczonych</span>
                <div class="filter-group">
                    <button class="btn btn-small btn-danger" onclick="batchDelete()">
                        🗑️ Usuń
                    </button>
                    <button class="btn btn-small" onclick="batchExport()">
                        📤 Eksportuj
                    </button>
                    <button class="btn btn-small" onclick="clearSelection()">
                        ✕ Anuluj
                    </button>
                </div>
            </div>

            <!-- Quiz List -->
            <div class="quiz-list" id="quizList" role="list" aria-label="Lista quizów"></div>
        </section>

        <!-- ==================== CHOOSE TYPE SCREEN ==================== -->
        <section id="chooseTypeScreen" class="screen hidden">
            <div class="card card-white animate-fadeIn">
                <h2>Co chcesz utworzyć?</h2>
                <div class="type-selection">
                    <button class="type-option" onclick="showCreateScreen('quiz')">
                        <div class="type-icon" aria-hidden="true">📊</div>
                        <h3>Quiz</h3>
                        <p>Klasyczny test z pytaniami wielokrotnego wyboru</p>
                    </button>
                    <button class="type-option" onclick="showCreateScreen('flashcard')">
                        <div class="type-icon" aria-hidden="true">🎴</div>
                        <h3>Fiszki</h3>
                        <p>Karty do nauki z pytaniem i odpowiedzią</p>
                    </button>
                </div>
                <div class="button-group center">
                    <button class="btn" onclick="showHomeScreen()">Anuluj</button>
                </div>
            </div>
        </section>

        <!-- ==================== CREATE SCREEN ==================== -->
        <section id="createScreen" class="screen hidden">
            <div class="card card-white animate-fadeIn">
                <h2 id="createTitle">Tworzenie nowego quizu</h2>

                <!-- AI Prompt Box -->
                <div class="ai-prompt">
                    <h3 id="aiPromptTitle">✨ Prompt AI do generowania:</h3>
                    <pre id="aiPrompt"></pre>
                    <button class="btn btn-small" onclick="copyPrompt()" style="margin-top: var(--space-4);">
                        📋 Kopiuj prompt
                    </button>
                </div>

                <!-- Form -->
                <div class="form-group">
                    <label for="quizTitle">Tytuł (opcjonalnie, jeśli już jest w JSON):</label>
                    <input
                        type="text"
                        id="quizTitle"
                        placeholder="Np. Quiz o historii Polski"
                        maxlength="200"
                    />
                </div>

                <div class="form-group">
                    <label>Tagi (naciśnij Enter aby dodać, opcjonalnie):</label>
                    <div class="tag-input-container" id="tagContainer">
                        <input
                            type="text"
                            id="tagInput"
                            placeholder="Dodaj tag..."
                            onkeypress="handleTagInput(event)"
                            maxlength="50"
                        />
                    </div>
                </div>

                <div class="form-group">
                    <label for="quizJson" id="jsonLabel">Wklej JSON:</label>
                    <textarea
                        id="quizJson"
                        placeholder="Wklej tutaj wygenerowany JSON..."
                    ></textarea>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveQuiz()">
                        💾 Zapisz
                    </button>
                    <button class="btn" onclick="showHomeScreen()">Anuluj</button>
                </div>
            </div>
        </section>

        <!-- ==================== EDIT SCREEN ==================== -->
        <section id="editScreen" class="screen hidden">
            <div class="card card-white animate-fadeIn">
                <h2>✏️ Edycja</h2>

                <div class="form-group">
                    <label for="editQuizTitle">Tytuł:</label>
                    <input type="text" id="editQuizTitle" maxlength="200" />
                </div>

                <div class="form-group">
                    <label>Tagi:</label>
                    <div class="tag-input-container" id="editTagContainer">
                        <input
                            type="text"
                            id="editTagInput"
                            placeholder="Dodaj tag..."
                            onkeypress="handleEditTagInput(event)"
                            maxlength="50"
                        />
                    </div>
                </div>

                <div class="form-group">
                    <label for="editQuizJson">JSON:</label>
                    <textarea id="editQuizJson"></textarea>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="updateQuiz()">
                        💾 Zapisz zmiany
                    </button>
                    <button class="btn btn-danger" onclick="deleteCurrentQuiz()">
                        🗑️ Usuń
                    </button>
                    <button class="btn" onclick="cancelEdit()">Anuluj</button>
                </div>
            </div>
        </section>

        <!-- ==================== PRE-QUIZ SCREEN ==================== -->
        <section id="preQuizScreen" class="screen hidden">
            <div class="card card-white animate-fadeIn">
                <h2 id="preQuizTitle"></h2>
                <p id="preQuizDescription" style="margin-bottom: var(--space-8);"></p>

                <div class="quiz-settings">
                    <h3>⚙️ Ustawienia</h3>
                    <div class="setting-row">
                        <label for="randomOrder">Losowa kolejność pytań</label>
                        <label class="toggle">
                            <input type="checkbox" id="randomOrder" checked />
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-row">
                        <label for="showLetters">Pokazuj litery odpowiedzi</label>
                        <label class="toggle">
                            <input type="checkbox" id="showLetters" checked />
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="button-group center">
                    <button class="btn btn-accent" onclick="startQuiz()">
                        ▶️ Rozpocznij quiz
                    </button>
                    <button class="btn" onclick="shareQuiz(State.quiz.current.id)">
                        🔗 Udostępnij
                    </button>
                    <button class="btn" onclick="showEditScreen(State.quiz.current.id)">
                        ✏️ Edytuj
                    </button>
                    <button class="btn" onclick="exportQuiz(State.quiz.current.id)">
                        📤 Eksportuj
                    </button>
                    <button class="btn" onclick="showHomeScreen()">Powrót</button>
                </div>
            </div>
        </section>

        <!-- ==================== QUIZ SCREEN ==================== -->
        <section id="quizScreen" class="screen hidden">
            <div class="quiz-container">
                <!-- Progress Bar -->
                <div class="progress-bar" role="progressbar" aria-label="Postęp quizu">
                    <div class="progress-fill" id="progressBar"></div>
                </div>

                <!-- Stats -->
                <div class="stats animate-slideIn">
                    <span id="questionNumber">Pytanie 1/10</span>
                    <span id="accuracy">Poprawność: 0%</span>
                    <span id="score">Punkty: 0</span>
                    <span id="quizTimer">00:00</span>
                </div>

                <!-- Question Card -->
                <div class="question-card animate-fadeIn">
                    <div class="question-category" id="questionCategory"></div>
                    <div class="retry-badge hidden" id="retryBadge">🔄 Powtórka</div>
                    <h2 id="questionText"></h2>
                    <div class="answers-grid" id="answersGrid" role="group" aria-label="Odpowiedzi"></div>
                </div>

                <!-- Exit Button -->
                <div class="button-group center">
                    <button class="btn" onclick="endQuizEarly()">
                        Zakończ quiz
                    </button>
                </div>
            </div>
        </section>

        <!-- ==================== RESULTS SCREEN ==================== -->
        <section id="resultsScreen" class="screen hidden">
            <div class="card card-white results-screen animate-fadeIn">
                <h2>Quiz zakończony!</h2>
                <div class="score-display" id="finalScore"></div>
                <div class="points-display" id="finalPoints"></div>
                <div class="time-display" id="finalTime"></div>

                <div class="button-group center">
                    <button class="btn btn-primary" onclick="retakeQuiz()">
                        🔄 Powtórz quiz
                    </button>
                    <button class="btn" onclick="showHomeScreen()">
                        🏠 Ekran główny
                    </button>
                </div>
            </div>
        </section>

        <!-- ==================== PRE-FLASHCARD SCREEN ==================== -->
        <section id="preFlashcardScreen" class="screen hidden">
            <div class="card card-white animate-fadeIn">
                <h2 id="preFlashcardTitle"></h2>
                <p id="preFlashcardDescription" style="margin-bottom: var(--space-8);"></p>

                <div class="quiz-settings">
                    <h3>⚙️ Ustawienia</h3>
                    <div class="setting-row">
                        <label for="flashcardRandomOrder">Losowa kolejność fiszek</label>
                        <label class="toggle">
                            <input type="checkbox" id="flashcardRandomOrder" checked />
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="button-group center">
                    <button class="btn btn-accent" onclick="startFlashcards()">
                        ▶️ Rozpocznij naukę
                    </button>
                    <button class="btn" onclick="shareQuiz(State.flashcard.current.id)">
                        🔗 Udostępnij
                    </button>
                    <button class="btn" onclick="showEditScreen(State.flashcard.current.id)">
                        ✏️ Edytuj
                    </button>
                    <button class="btn" onclick="exportQuiz(State.flashcard.current.id)">
                        📤 Eksportuj
                    </button>
                    <button class="btn" onclick="showHomeScreen()">Powrót</button>
                </div>
            </div>
        </section>

        <!-- ==================== FLASHCARD SCREEN ==================== -->
        <section id="flashcardScreen" class="screen hidden">
            <div class="flashcard-container">
                <!-- Progress Bar -->
                <div class="progress-bar" role="progressbar" aria-label="Postęp fiszek">
                    <div class="progress-fill" id="flashcardProgress"></div>
                </div>

                <!-- Stats -->
                <div class="stats animate-slideIn">
                    <span id="flashcardNumber">Fiszka 1/10</span>
                    <span id="flashcardStats">Poznane: 0 | Trudne: 0</span>
                    <span id="flashcardTimer">00:00</span>
                </div>

                <!-- Flashcard -->
                <div class="flashcard-wrapper">
                    <div
                        class="flashcard animate-fadeIn"
                        id="flashcard"
                        onclick="flipCard()"
                        role="button"
                        tabindex="0"
                        aria-label="Kliknij aby obrócić fiszkę"
                    >
                        <div class="flashcard-side flashcard-front">
                            <div class="retry-badge hidden" id="flashcardRetryBadgeFront">
                                🔄 Powtórka
                            </div>
                            <div class="flashcard-content" id="flashcardFront"></div>
                        </div>
                        <div class="flashcard-side flashcard-back">
                            <div class="retry-badge hidden" id="flashcardRetryBadgeBack">
                                🔄 Powtórka
                            </div>
                            <div class="flashcard-content" id="flashcardBack"></div>
                        </div>
                    </div>

                    <p class="flashcard-hint">
                        <span class="desktop-only">Kliknij kartę aby ją obrócić</span>
                        <span class="mobile-only">Dotknij karty aby ją obrócić</span>
                    </p>

                    <!-- Rating Buttons -->
                    <div class="flashcard-actions" id="flashcardActions" style="display: none;">
                        <button class="flashcard-btn btn-hard" onclick="rateCard('hard')">
                            ❌ Nie znam
                        </button>
                        <button class="flashcard-btn btn-medium" onclick="rateCard('medium')">
                            🤔 Trudne
                        </button>
                        <button class="flashcard-btn btn-easy" onclick="rateCard('easy')">
                            ✅ Znam
                        </button>
                    </div>
                </div>

                <!-- Exit Button -->
                <div class="button-group center" style="margin-top: var(--space-8);">
                    <button class="btn" onclick="endFlashcardsEarly()">
                        Zakończ naukę
                    </button>
                </div>
            </div>
        </section>

        <!-- ==================== FLASHCARD RESULTS SCREEN ==================== -->
        <section id="flashcardResultsScreen" class="screen hidden">
            <div class="card card-white results-screen animate-fadeIn">
                <h2>Sesja nauki zakończona!</h2>
                <div class="time-display" id="flashcardFinalTime"></div>

                <div class="flashcard-results-stats">
                    <div class="flashcard-stat-item">
                        <div class="flashcard-stat-value easy" id="flashcardEasyCount">0</div>
                        <div class="flashcard-stat-label">Znane</div>
                    </div>
                    <div class="flashcard-stat-item">
                        <div class="flashcard-stat-value medium" id="flashcardMediumCount">0</div>
                        <div class="flashcard-stat-label">Trudne</div>
                    </div>
                    <div class="flashcard-stat-item">
                        <div class="flashcard-stat-value hard" id="flashcardHardCount">0</div>
                        <div class="flashcard-stat-label">Nieznane</div>
                    </div>
                </div>

                <div class="button-group center">
                    <button class="btn btn-primary" onclick="retakeFlashcards()">
                        🔄 Powtórz naukę
                    </button>
                    <button class="btn" onclick="showHomeScreen()">
                        🏠 Ekran główny
                    </button>
                </div>
            </div>
        </section>
    </div>

    <!-- ==================== MODALS ==================== -->

    <!-- Import Modal -->
    <div id="importModal" class="modal hidden" onclick="closeModal('importModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>📥 Importuj quiz</h2>
                <button class="modal-close" onclick="closeModal('importModal')" aria-label="Zamknij">
                    ×
                </button>
            </div>
            <div class="form-group">
                <label>Wybierz plik JSON lub wklej dane:</label>
                <input
                    type="file"
                    id="importFile"
                    accept=".json"
                    onchange="handleFileImport(event)"
                    style="margin-top: var(--space-2);"
                />
            </div>
            <div class="form-group">
                <textarea
                    id="importJson"
                    placeholder="Lub wklej JSON tutaj..."
                    style="min-height: 180px;"
                ></textarea>
            </div>
            <p style="margin-bottom: var(--space-4); font-size: var(--text-sm); color: var(--text-tertiary);">
                ℹ️ Istniejące quizy nie zostaną nadpisane, dodane zostaną tylko nowe.
            </p>
            <div class="button-group">
                <button class="btn btn-primary" onclick="importQuiz()">
                    📥 Importuj
                </button>
                <button class="btn" onclick="closeModal('importModal')">
                    Anuluj
                </button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal" class="modal hidden" onclick="closeModal('backupModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>💾 Zarządzanie danymi</h2>
                <button class="modal-close" onclick="closeModal('backupModal')" aria-label="Zamknij">
                    ×
                </button>
            </div>
            <p style="margin-bottom: var(--space-6); color: var(--text-secondary);">
                Wykonaj kopię zapasową wszystkich quizów i danych lub przywróć z pliku.
            </p>
            <div class="button-group">
                <button class="btn btn-primary" onclick="exportAllData()">
                    💾 Eksportuj wszystko
                </button>
                <button class="btn btn-accent" onclick="document.getElementById('restoreFile').click()">
                    📂 Przywróć z pliku
                </button>
                <input
                    type="file"
                    id="restoreFile"
                    accept=".json"
                    style="display: none;"
                    onchange="restoreData(event)"
                />
            </div>
            <div style="margin-top: var(--space-6); padding: var(--space-4); background: var(--bg-tertiary); border-radius: var(--radius-md);">
                <p style="font-size: var(--text-sm); color: var(--text-secondary);">
                    <strong>Liczba quizów:</strong> <span id="quizCount">0</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal hidden" onclick="closeModal('shareModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>🔗 Udostępnij quiz</h2>
                <button class="modal-close" onclick="closeModal('shareModal')" aria-label="Zamknij">
                    ×
                </button>
            </div>
            <div id="shareContent">
                <div style="text-align: center; padding: var(--space-10) var(--space-5);">
                    <div class="loading-spinner" style="font-size: 48px; margin-bottom: var(--space-4);">⏳</div>
                    <p style="color: var(--text-secondary); font-size: var(--text-sm);">
                        Generowanie linku...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Storage Cleanup Modal -->
    <div id="storageCleanupModal" class="modal hidden" onclick="closeModal('storageCleanupModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>⚠️ Brak miejsca</h2>
                <button class="modal-close" onclick="closeModal('storageCleanupModal')" aria-label="Zamknij">
                    ×
                </button>
            </div>
            <p style="margin-bottom: var(--space-6); color: var(--text-secondary);">
                Brak miejsca w pamięci przeglądarki. Usuń starą historię lub quizy, aby zwolnić miejsce.
            </p>
            <div style="background: var(--bg-tertiary); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-4);">
                <p style="font-size: var(--text-sm); margin-bottom: var(--space-2);">
                    <strong>Historia wyników:</strong> <span id="historySize">0 KB</span>
                </p>
                <p style="font-size: var(--text-sm);">
                    <strong>Liczba quizów:</strong> <span id="quizzesCount">0</span>
                </p>
            </div>
            <div class="button-group">
                <button class="btn btn-danger" onclick="clearAllHistory()">
                    🗑️ Usuń całą historię
                </button>
                <button class="btn" onclick="clearOldHistory()">
                    📅 Usuń starszą niż 30 dni
                </button>
                <button class="btn" onclick="closeModal('storageCleanupModal')">
                    Anuluj
                </button>
            </div>
        </div>
    </div>

    <!-- Screen Reader Announcements -->
    <div
        id="srAnnouncements"
        role="status"
        aria-live="polite"
        aria-atomic="true"
        class="sr-only"
    ></div>

    <script>
    // ============================================================================
    // QUIZAPP 2.5 - REFACTORED JAVASCRIPT
    // ============================================================================

    "use strict";

    // ==================== CONSTANTS ====================
    const CONSTANTS = Object.freeze({
        DELIMITER: "\u001F",
        MAX_TITLE_LENGTH: 200,
        MAX_TAG_LENGTH: 50,
        MAX_INPUT_LENGTH: 1000,
        SEARCH_DEBOUNCE_MS: 250,
        TOAST_DURATION_MS: 3000,
        TOAST_ANIMATION_MS: 300,
        MIN_LOADING_TIME_MS: 400,
        FLIP_ANIMATION_MS: 650,
        ANSWER_DELAY_MS: 1400,
        BUTTON_COOLDOWN_MS: 200,
        BASE_POINTS_MULTIPLIER: 250,
        TIME_PENALTY_MULTIPLIER: 10,
        MAX_TIME_PENALTY_DIVISOR: 125,
        STORAGE_KEYS: Object.freeze({
            QUIZZES: "quizzes",
            QUIZ_HISTORY: "quizHistory",
            FLASHCARD_HISTORY: "flashcardHistory",
            THEME: "theme"
        }),
        SHARE_BASE_URL: "https://tymoeks.github.io/quizapp/"
    });
    // ==================== STATE MANAGEMENT ====================
    const State = {
        // Quiz state
        quiz: {
            current: null,
            currentIndex: 0,
            answeredCount: 0,
            score: 0,
            totalPoints: 0,
            correctAnswers: 0,
            questions: [],
            queue: [],
            startTime: null,
            questionStartTime: null,
            firstAttemptCorrect: new Set(),
            firstAttemptAnswered: 0,
            retriedQuestions: new Set(),
            settings: {
                randomOrder: true,
                showLetters: true
            }
        },

        // Flashcard state
        flashcard: {
            current: null,
            currentIndex: 0,
            answeredCount: 0,
            stats: { easy: 0, medium: 0, hard: 0 },
            cards: [],
            queue: [],
            isFlipped: false,
            isTransitioning: false,
            completedCards: new Set(),
            retriedCards: new Set(),
            startTime: null
        },

        // UI state
        ui: {
            currentFilter: "all",
            currentTags: [],
            editTags: [],
            selectionMode: false,
            selectedQuizzes: new Set(),
            currentEditingId: null,
            currentCreateType: null,
            modalFocusTrap: null
        },

        // System state
        system: {
            timerInterval: null,
            activeToast: null,
            queuedToast: null,
            toastTimeout: null,
            searchDebounceTimer: null
        },

        // Reset quiz state
        resetQuiz() {
            this.quiz.current = null;
            this.quiz.currentIndex = 0;
            this.quiz.answeredCount = 0;
            this.quiz.score = 0;
            this.quiz.totalPoints = 0;
            this.quiz.correctAnswers = 0;
            this.quiz.questions = [];
            this.quiz.queue = [];
            this.quiz.startTime = null;
            this.quiz.questionStartTime = null;
            this.quiz.firstAttemptCorrect = new Set();
            this.quiz.firstAttemptAnswered = 0;
            this.quiz.retriedQuestions = new Set();
        },

        // Reset flashcard state
        resetFlashcard() {
            this.flashcard.current = null;
            this.flashcard.currentIndex = 0;
            this.flashcard.answeredCount = 0;
            this.flashcard.stats = { easy: 0, medium: 0, hard: 0 };
            this.flashcard.cards = [];
            this.flashcard.queue = [];
            this.flashcard.isFlipped = false;
            this.flashcard.isTransitioning = false;
            this.flashcard.completedCards = new Set();
            this.flashcard.retriedCards = new Set();
            this.flashcard.startTime = null;
        },

        // Reset UI state for forms
        resetFormState() {
            this.ui.currentTags = [];
            this.ui.editTags = [];
        }
    };

    // ==================== RENDER CACHE ====================
    const RenderCache = {
        quizzes: null,
        lastQuery: "",
        lastFilter: null,
        itemCache: new Map(),

        shouldUpdate(query, filter) {
            return this.lastQuery !== query || this.lastFilter !== filter;
        },

        update(query, filter, quizzes) {
            this.lastQuery = query;
            this.lastFilter = filter;
            this.quizzes = quizzes;
        },

        clear() {
            this.quizzes = null;
            this.lastQuery = "";
            this.lastFilter = null;
            this.itemCache.clear();
        },

        getCacheKey(quiz) {
            return `${quiz.id}_${State.ui.selectionMode}_${State.ui.selectedQuizzes.has(quiz.id)}`;
        },

        getQuizHTML(quiz) {
            const key = this.getCacheKey(quiz);
            return this.itemCache.get(key) || null;
        },

        setQuizHTML(quiz, html) {
            const key = this.getCacheKey(quiz);
            this.itemCache.set(key, html);
        }
    };

    // ==================== RESOURCE CLEANUP ====================
    const Cleanup = {
        eventListeners: [],
        timers: new Set(),

        registerEvent(element, event, handler, options) {
            element.addEventListener(event, handler, options);
            this.eventListeners.push({ element, event, handler, options });
        },

        registerTimer(timerId) {
            this.timers.add(timerId);
            return timerId;
        },

        clearEvents() {
            this.eventListeners.forEach(({ element, event, handler, options }) => {
                element.removeEventListener(event, handler, options);
            });
            this.eventListeners = [];
        },

        clearTimers() {
            this.timers.forEach(id => {
                clearTimeout(id);
                clearInterval(id);
            });
            this.timers.clear();
        },

        clearAll() {
            this.clearEvents();
            this.clearTimers();
            Timer.stop();
        }
    };
    // ==================== BUTTON COOLDOWN ====================
    const ButtonCooldown = {
        lastClickTime: 0,
        
        canClick() {
            const now = Date.now();
            if (now - this.lastClickTime < CONSTANTS.BUTTON_COOLDOWN_MS) {
                return false;
            }
            this.lastClickTime = now;
            return true;
        },
        
        wrap(fn) {
            return function(...args) {
                if (ButtonCooldown.canClick()) {
                    return fn.apply(this, args);
                }
            };
        }
    };
    
    // ==================== TIMER UTILITY ====================
    const Timer = {        interval: null,
        elementId: null,
        startTime: null,

        start(elementId) {
            this.stop();
            this.elementId = elementId;
            this.startTime = Date.now();

            this.interval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                const element = document.getElementById(this.elementId);
                if (element) {
                    element.textContent = Utils.formatTime(elapsed);
                }
            }, 1000);

            Cleanup.registerTimer(this.interval);
        },

        stop() {
            if (this.interval) {
                clearInterval(this.interval);
                Cleanup.timers.delete(this.interval);
                this.interval = null;
            }
        },

        getElapsed() {
            return this.startTime ? (Date.now() - this.startTime) / 1000 : 0;
        }
    };

    // ==================== UTILITY FUNCTIONS ====================
    const Utils = {
        // Shuffle array using Fisher-Yates algorithm
        shuffleArray(array) {
            const result = [...array];
            for (let i = result.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [result[i], result[j]] = [result[j], result[i]];
            }
            return result;
        },

        // Format time as MM:SS
        formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
        },

        // Format date
        formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, "0");
            const month = (date.getMonth() + 1).toString().padStart(2, "0");
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, "0");
            const minutes = date.getMinutes().toString().padStart(2, "0");
            return `${day}.${month}.${year} ${hours}:${minutes}`;
        },

        // Format bytes to human readable
        formatBytes(bytes) {
            if (bytes < 1024) return bytes + " B";
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + " KB";
            return (bytes / (1024 * 1024)).toFixed(2) + " MB";
        },

        // Escape HTML entities
        escapeHtml(text) {
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
        },

        // Decode HTML entities
        decodeHtml(html) {
            const txt = document.createElement("textarea");
            txt.innerHTML = html;
            return txt.value;
        },

        // Sanitize input
        sanitizeInput(input, maxLength = CONSTANTS.MAX_INPUT_LENGTH) {
            if (typeof input !== "string") return "";
            let result = input.trim();
            if (result.length > maxLength) {
                result = result.substring(0, maxLength);
            }
            // Remove control characters except newlines and tabs
            return result.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, "");
        },

        // Sanitize quiz data object
        sanitizeQuizData(quiz) {
            return {
                ...quiz,
                title: this.sanitizeInput(quiz.title, CONSTANTS.MAX_TITLE_LENGTH),
                tags: Array.isArray(quiz.tags)
                    ? quiz.tags.map(tag => this.sanitizeInput(tag, CONSTANTS.MAX_TAG_LENGTH)).filter(Boolean)
                    : [],
                questions: quiz.questions
                    ? quiz.questions.map(q => ({
                        ...q,
                        question: this.sanitizeInput(q.question),
                        correct: this.sanitizeInput(q.correct, 500),
                        wrong: Array.isArray(q.wrong)
                            ? q.wrong.map(w => this.sanitizeInput(w, 500))
                            : [],
                        group: q.group ? this.sanitizeInput(q.group, 100) : undefined
                    }))
                    : undefined,
                cards: quiz.cards
                    ? quiz.cards.map(c => ({
                        front: this.sanitizeInput(c.front),
                        back: this.sanitizeInput(c.back),
                        category: c.category ? this.sanitizeInput(c.category, 100) : undefined
                    }))
                    : undefined
            };
        },

        // Generate unique ID
        generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        },

        // Debounce function
        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        },

        // Announce to screen reader
        announceToScreenReader(message, priority = "polite") {
            const announcer = document.getElementById("srAnnouncements");
            if (announcer) {
                announcer.setAttribute("aria-live", priority);
                announcer.textContent = "";
                setTimeout(() => {
                    announcer.textContent = message;
                }, 100);
            }
        }
    };

    // ==================== TOAST SYSTEM ====================
    const Toast = {
        icons: {
            success: "✓",
            error: "✕",
            info: "i"
        },
    
        show(message, type = "info") {
            const newToast = { message, type };
    
            if (State.system.activeToast) {
                State.system.queuedToast = newToast;
                this.hide(true);
            } else {
                this.display(newToast);
            }
        },
    
        display(toastData) {
            const duration = State.system.queuedToast 
                ? CONSTANTS.TOAST_ANIMATION_MS * 2 
                : CONSTANTS.TOAST_DURATION_MS;
    
            // Create toast element
            const toast = document.createElement("div");
            toast.className = `toast ${toastData.type}`;
            toast.setAttribute("role", "alert");
            toast.setAttribute("aria-live", "polite");
    
            // Create content container
            const content = document.createElement("div");
            content.className = "toast-content";
    
            // Create icon
            const icon = document.createElement("span");
            icon.className = "toast-icon";
            icon.textContent = this.icons[toastData.type] || this.icons.info;
    
            // Create message
            const message = document.createElement("span");
            message.className = "toast-message";
            message.textContent = toastData.message;
    
            // Create progress container
            const progress = document.createElement("div");
            progress.className = "toast-progress";
    
            // Create progress bar
            const progressBar = document.createElement("div");
            progressBar.className = "toast-progress-bar";
    
            // Assemble toast
            content.appendChild(icon);
            content.appendChild(message);
            progress.appendChild(progressBar);
            toast.appendChild(content);
            toast.appendChild(progress);
    
            // Add to DOM
            document.body.appendChild(toast);
            State.system.activeToast = toast;
    
            // Trigger animations after a frame
            requestAnimationFrame(() => {
                // Slide in animation
                toast.style.animation = `toastSlideIn ${CONSTANTS.TOAST_ANIMATION_MS}ms cubic-bezier(0.34, 1.56, 0.64, 1) forwards`;
                
                // Progress bar animation
                progressBar.style.animation = `toastProgressShrink ${duration}ms linear forwards`;
            });
    
            // Set timeout to hide
            State.system.toastTimeout = setTimeout(() => {
                this.hide();
            }, duration);
        },
    
        hide(immediate = false) {
            const toast = State.system.activeToast;
            if (!toast) return;
    
            // Clear existing timeout
            if (State.system.toastTimeout) {
                clearTimeout(State.system.toastTimeout);
                State.system.toastTimeout = null;
            }
    
            // Slide out animation
            toast.style.animation = `toastSlideOut ${CONSTANTS.TOAST_ANIMATION_MS}ms ease-in forwards`;
    
            // Remove after animation
            const removeDelay = immediate ? 100 : CONSTANTS.TOAST_ANIMATION_MS;
            
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
    
                if (State.system.activeToast === toast) {
                    State.system.activeToast = null;
    
                    // Show queued toast if any
                    if (State.system.queuedToast) {
                        const next = State.system.queuedToast;
                        State.system.queuedToast = null;
                        
                        // Small delay before showing next toast
                        setTimeout(() => {
                            this.display(next);
                        }, 50);
                    }
                }
            }, removeDelay);
        }
    };    // Shorthand
    function showToast(message, type) {
        Toast.show(message, type);
    }

    // ==================== STORAGE OPERATIONS ====================
    const Storage = {
        get(key, defaultValue = null) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (error) {
                console.error(`Storage.get error for ${key}:`, error);
                return defaultValue;
            }
        },

        set(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (error) {
                if (error.name === "QuotaExceededError") {
                    this.handleQuotaExceeded();
                    return false;
                }
                showToast("Błąd zapisu: " + error.message, "error");
                return false;
            }
        },

        setRaw(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (error) {
                if (error.name === "QuotaExceededError") {
                    this.handleQuotaExceeded();
                    return false;
                }
                showToast("Błąd zapisu: " + error.message, "error");
                return false;
            }
        },

        handleQuotaExceeded() {
            const historySize = this.calculateHistorySize();
            const quizzesCount = this.get(CONSTANTS.STORAGE_KEYS.QUIZZES, []).length;

            document.getElementById("historySize").textContent = Utils.formatBytes(historySize);
            document.getElementById("quizzesCount").textContent = quizzesCount;

            document.getElementById("storageCleanupModal").classList.remove("hidden");
        },

        calculateHistorySize() {
            const quizHistory = localStorage.getItem(CONSTANTS.STORAGE_KEYS.QUIZ_HISTORY) || "{}";
            const flashcardHistory = localStorage.getItem(CONSTANTS.STORAGE_KEYS.FLASHCARD_HISTORY) || "{}";
            return new Blob([quizHistory, flashcardHistory]).size;
        },

        getQuizzes() {
            return this.get(CONSTANTS.STORAGE_KEYS.QUIZZES, []);
        },

        saveQuizzes(quizzes) {
            return this.set(CONSTANTS.STORAGE_KEYS.QUIZZES, quizzes);
        },

        getQuizHistory() {
            return this.get(CONSTANTS.STORAGE_KEYS.QUIZ_HISTORY, {});
        },

        saveQuizHistory(history) {
            return this.set(CONSTANTS.STORAGE_KEYS.QUIZ_HISTORY, history);
        }
    };

    // ==================== DATA FORMAT CONVERSION ====================
    const DataFormat = {
        escapeText(text) {
            return text.replace(/\|/g, CONSTANTS.DELIMITER);
        },

        unescapeText(text) {
            return text.replace(new RegExp(CONSTANTS.DELIMITER, "g"), "|");
        },

        // Validate quiz format
        validate(quiz) {
            try {
                if (!quiz.title || typeof quiz.title !== "string") return false;

                // New format: data is array
                if (quiz.data && Array.isArray(quiz.data)) {
                    return typeof quiz.type === "number";
                }

                // Old format: data is string
                if (!quiz.data || typeof quiz.data !== "string") return false;

                const data = quiz.data;
                if (!data.startsWith("{0") && !data.startsWith("{1")) return false;
                if (!data.endsWith("}")) return false;
                if (data.length < 5) return false;

                return true;
            } catch (error) {
                return false;
            }
        },

        // Decode from storage format
        decode(data) {
            // New format - data is object/array
            if (data.data && typeof data.data === "object" && Array.isArray(data.data)) {
                return this.decodeNewFormat(data);
            }

            // Old format - data is string
            if (!data.data || typeof data.data !== "string") {
                throw new Error("Nieprawidłowy format danych");
            }

            return this.decodeStringFormat(data);
        },

        decodeNewFormat(data) {
            if (data.type === 0) {
                // Quiz format
                let encoded = "{0";
                data.data.forEach(item => {
                    if (item.type === 1) {
                        encoded += "1" + this.escapeText(item.question) + "|";
                        encoded += this.escapeText(item.category || "") + "|";
                        encoded += this.escapeText(item.answers[0]) + "|";
                        encoded += this.escapeText(item.answers[1] || "Fałsz") + "|";
                    } else {
                        encoded += "0" + this.escapeText(item.question) + "|";
                        encoded += this.escapeText(item.category || "") + "|";
                        encoded += item.answers.map(a => this.escapeText(a)).join("|") + "|";
                    }
                });
                encoded += "}";

                return this.decode({
                    title: data.title,
                    tags: data.tags,
                    type: "quiz",
                    data: encoded
                });
            } else if (data.type === 1) {
                // Flashcard format
                let encoded = "{1";
                data.data.forEach(card => {
                    encoded += this.escapeText(card.front) + "|";
                    encoded += this.escapeText(card.category || "") + "|";
                    encoded += this.escapeText(card.back) + "|";
                });
                encoded += "}";

                return this.decode({
                    title: data.title,
                    tags: data.tags,
                    type: "flashcard",
                    data: encoded
                });
            }

            throw new Error("Nieznany typ danych");
        },

        decodeStringFormat(data) {
            const content = data.data;

            if (content.startsWith("{1")) {
                return this.decodeFlashcards(data, content);
            } else if (content.startsWith("{0")) {
                return this.decodeQuiz(data, content);
            }

            throw new Error("Nieznany format danych");
        },

        decodeFlashcards(data, content) {
            const cardsData = content.substring(2, content.length - 1);
            const parts = cardsData.split("|");
            const cards = [];

            for (let i = 0; i < parts.length; i += 3) {
                if (parts[i]) {
                    const card = {
                        front: this.unescapeText(parts[i]),
                        back: this.unescapeText(parts[i + 2] || "")
                    };
                    if (parts[i + 1]) {
                        card.category = this.unescapeText(parts[i + 1]);
                    }
                    cards.push(card);
                }
            }

            return {
                title: data.title,
                tags: data.tags || [],
                type: "flashcard",
                data: content,
                cards: cards
            };
        },

        decodeQuiz(data, content) {
            const questionsData = content.substring(2, content.length - 1);
            const questions = [];
            let i = 0;

            while (i < questionsData.length) {
                const qType = questionsData[i];
                if (qType !== "0" && qType !== "1") {
                    i++;
                    continue;
                }
                i++;

                const expectedFields = qType === "1" ? 4 : 6;
                const parts = [];
                let current = "";
                let fieldCount = 0;

                while (i < questionsData.length && fieldCount < expectedFields) {
                    if (questionsData[i] === "|") {
                        parts.push(current);
                        current = "";
                        fieldCount++;
                    } else {
                        current += questionsData[i];
                    }
                    i++;
                }

                if (current.length > 0) {
                    parts.push(current);
                }

                if (parts.length >= 3) {
                    const question = {
                        question: this.unescapeText(parts[0] || ""),
                        group: parts[1] ? this.unescapeText(parts[1]) : undefined,
                        correct: this.unescapeText(parts[2] || "")
                    };

                    if (qType === "1") {
                        question.type = "tf";
                        question.wrong = [this.unescapeText(parts[3] || "Fałsz")];
                    } else {
                        question.wrong = parts.slice(3).filter(p => p).map(p => this.unescapeText(p));
                    }

                    if (question.question && question.correct) {
                        questions.push(question);
                    }
                }
            }

            return {
                title: data.title,
                tags: data.tags || [],
                type: "quiz",
                data: content,
                questions: questions
            };
        },

        // Encode to storage format
        encode(quiz) {
            if (quiz.data && typeof quiz.data === "string") {
                return {
                    title: quiz.title,
                    tags: quiz.tags || [],
                    type: quiz.type,
                    data: quiz.data
                };
            }

            let data = "";

            if (quiz.type === "flashcard") {
                data = "{1";
                quiz.cards.forEach(card => {
                    data += this.escapeText(card.front) + "|";
                    data += this.escapeText(card.category || "") + "|";
                    data += this.escapeText(card.back) + "|";
                });
                data += "}";
            } else {
                data = "{0";
                quiz.questions.forEach(q => {
                    if (q.type === "tf") {
                        data += "1" + this.escapeText(q.question) + "|";
                        data += this.escapeText(q.group || "") + "|";
                        data += this.escapeText(q.correct) + "|";
                        data += this.escapeText(q.wrong[0]) + "|";
                    } else {
                        data += "0" + this.escapeText(q.question) + "|";
                        data += this.escapeText(q.group || "") + "|";
                        data += this.escapeText(q.correct) + "|";
                        data += q.wrong.map(w => this.escapeText(w)).join("|") + "|";
                    }
                });
                data += "}";
            }

            return {
                title: quiz.title,
                tags: quiz.tags || [],
                type: quiz.type,
                data: data
            };
        }
    };

    // ==================== THEME MANAGEMENT ====================
    const Theme = {
        init() {
            let savedTheme = localStorage.getItem(CONSTANTS.STORAGE_KEYS.THEME);

            if (!savedTheme) {
                savedTheme = window.matchMedia?.("(prefers-color-scheme: dark)").matches 
                    ? "dark" 
                    : "light";
            }

            document.documentElement.setAttribute("data-theme", savedTheme);
            this.updateIcon(savedTheme);

            // Listen for system theme changes
            window.matchMedia?.("(prefers-color-scheme: dark)")
                .addEventListener("change", (e) => {
                    if (!localStorage.getItem(CONSTANTS.STORAGE_KEYS.THEME)) {
                        const newTheme = e.matches ? "dark" : "light";
                        document.documentElement.setAttribute("data-theme", newTheme);
                        this.updateIcon(newTheme);
                    }
                });
        },

        toggle() {
            const current = document.documentElement.getAttribute("data-theme");
            const newTheme = current === "dark" ? "light" : "dark";
            
            document.documentElement.setAttribute("data-theme", newTheme);
            localStorage.setItem(CONSTANTS.STORAGE_KEYS.THEME, newTheme);
            this.updateIcon(newTheme);
            
            showToast(`Motyw: ${newTheme === "dark" ? "ciemny" : "jasny"}`, "success");
        },

        updateIcon(theme) {
            const icon = document.getElementById("themeIcon");
            if (icon) {
                icon.textContent = theme === "dark" ? "☀️" : "🌙";
            }
        }
    };

    // Global function for onclick
    function toggleTheme() {
        Theme.toggle();
    }

    // ==================== NAVIGATION ====================
    const Navigation = {
        hideAllScreens() {
            Cleanup.clearAll();
            document.querySelectorAll(".screen").forEach(screen => {
                screen.classList.add("hidden");
            });
        },

        showScreen(screenId) {
            this.hideAllScreens();
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.classList.remove("hidden");
            }
        },

        showHome() {
            this.showScreen("homeScreen");
            QuizList.load();
        },

        showChooseType() {
            this.showScreen("chooseTypeScreen");
        },

        showCreate(type) {
            this.showScreen("createScreen");
            State.ui.currentCreateType = type;
            State.resetFormState();

            // Clear form
            document.getElementById("quizJson").value = "";
            document.getElementById("quizTitle").value = "";
            Tags.render("tagContainer", "tagInput", State.ui.currentTags);

            // Update UI text
            const isFlashcard = type === "flashcard";
            document.getElementById("createTitle").textContent = 
                isFlashcard ? "Tworzenie nowych fiszek" : "Tworzenie nowego quizu";
            document.getElementById("aiPromptTitle").textContent = 
                isFlashcard ? "✨ Prompt AI do generowania fiszek:" : "✨ Prompt AI do generowania quizu:";
            document.getElementById("jsonLabel").textContent = 
                isFlashcard ? "Wklej JSON z fiszkami:" : "Wklej JSON z quizem:";
            document.getElementById("aiPrompt").textContent = this.getPrompt(type);
        },

        showEdit(quizId) {
            this.showScreen("editScreen");
            State.ui.currentEditingId = quizId;

            const quizzes = Storage.getQuizzes();
            const quiz = quizzes.find(q => q.id === quizId);

            if (quiz) {
                document.getElementById("editQuizTitle").value = quiz.title || "";
                State.ui.editTags = quiz.tags || [];
                Tags.render("editTagContainer", "editTagInput", State.ui.editTags);

                const jsonData = {
                    title: quiz.title,
                    tags: quiz.tags,
                    type: quiz.type,
                    data: quiz.data
                };
                document.getElementById("editQuizJson").value = JSON.stringify(jsonData, null, 2);
            }
        },

        showPreQuiz(quizId) {
            this.showScreen("preQuizScreen");

            const quizzes = Storage.getQuizzes();
            State.quiz.current = quizzes.find(q => q.id === quizId);

            if (State.quiz.current) {
                document.getElementById("preQuizTitle").textContent = State.quiz.current.title;
                
                const tfCount = State.quiz.current.questions.filter(q => q.type === "tf").length;
                const mcCount = State.quiz.current.questions.length - tfCount;
                
                document.getElementById("preQuizDescription").textContent = 
                    `${State.quiz.current.questions.length} pytań (${mcCount} wielokrotnego wyboru, ${tfCount} prawda/fałsz)`;
            }
        },

        showPreFlashcard(flashcardId) {
            this.showScreen("preFlashcardScreen");

            const quizzes = Storage.getQuizzes();
            State.flashcard.current = quizzes.find(q => q.id === flashcardId);

            if (State.flashcard.current) {
                document.getElementById("preFlashcardTitle").textContent = State.flashcard.current.title;
                document.getElementById("preFlashcardDescription").textContent = 
                    `${State.flashcard.current.cards.length} fiszek do nauki`;
            }
        },

        getPrompt(type) {
            const prompts = {
                quiz: `Wygeneruj quiz w formacie JSON.

Parametry:
- Temat: [TWÓJ TEMAT]
- Liczba pytań: [np. 10]
- Liczba pytań prawda/fałsz: [np. 3]

Format JSON:
{
  "title": "Tytuł quizu",
  "tags": ["tag1", "tag2", "tag3"],
  "type": 0,
  "data": [
    {
      "type": 0,
      "category": "kategoria",
      "question": "Pytanie ABCD",
      "answers": ["poprawna", "błędna1", "błędna2", "błędna3"]
    },
    {
      "type": 1,
      "question": "Pytanie PF",
      "answers": ["poprawna", "błędna"]
    }
  ]
}

Zasady:
- "type" : 0 = quiz
- W pytaniach: type: 0 = ABCD, type: 1 = Prawda/Fałsz
- Pierwsza odpowiedź w "answers" to zawsze ta poprawna
- category jest opcjonalne
- Dla PF używaj "Prawda" oraz "Fałsz"
- W pytaniach i odpowiedziach nie może się znaleźć '|'`,

                flashcard: `Wygeneruj fiszki w formacie JSON.

Parametry:
- Temat: [TWÓJ TEMAT]
- Liczba fiszek: [np. 20]

Format JSON:
{
  "title": "Tytuł zestawu",
  "tags": ["tag1", "tag2", "tag3"],
  "type": 1,
  "data": [
    {
      "category": "kategoria",
      "front": "przód",
      "back": "tył"
    }
  ]
}

Zasady:
- "type" : 1 = fiszki
- "category" jest opcjonalne
- "front" = pytanie/termin, "back" = odpowiedź/definicja
- W treści nie może się znaleźć '|'`
            };

            return prompts[type] || prompts.quiz;
        }
    };

    // Global navigation functions (with cooldown)
    function showHomeScreen() { if (ButtonCooldown.canClick()) Navigation.showHome(); }
    function showChooseTypeScreen() { if (ButtonCooldown.canClick()) Navigation.showChooseType(); }
    function showCreateScreen(type) { if (ButtonCooldown.canClick()) Navigation.showCreate(type); }
    function showEditScreen(quizId) { if (ButtonCooldown.canClick()) Navigation.showEdit(quizId); }
    function showPreQuizScreen(quizId) { if (ButtonCooldown.canClick()) Navigation.showPreQuiz(quizId); }
    function showFlashcardScreen(flashcardId) { if (ButtonCooldown.canClick()) Navigation.showPreFlashcard(flashcardId); }
    function cancelEdit() {
        if (!State.ui.currentEditingId) {
            Navigation.showHome();
            return;
        }

        const quizzes = Storage.getQuizzes();
        const quiz = quizzes.find(q => q.id === State.ui.currentEditingId);

        if (!quiz) {
            Navigation.showHome();
            return;
        }

        if (quiz.type === "flashcard") {
            Navigation.showPreFlashcard(State.ui.currentEditingId);
        } else {
            Navigation.showPreQuiz(State.ui.currentEditingId);
        }
    }

    // ==================== TAGS MANAGEMENT ====================
    const Tags = {
        render(containerId, inputId, tagsArray) {
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);

            const tagsHtml = tagsArray.map((tag, index) => `
                <span class="tag-removable">
                    ${Utils.escapeHtml(tag)}
                    <button onclick="Tags.remove('${containerId}', '${inputId}', ${index})" aria-label="Usuń tag ${Utils.escapeHtml(tag)}">×</button>
                </span>
            `).join("");

            container.innerHTML = tagsHtml;
            container.appendChild(input);
        },

        add(containerId, inputId, tagsArray, tag) {
            const sanitized = Utils.sanitizeInput(tag, CONSTANTS.MAX_TAG_LENGTH);
            if (sanitized && !tagsArray.includes(sanitized)) {
                tagsArray.push(sanitized);
                this.render(containerId, inputId, tagsArray);
            }
        },

        remove(containerId, inputId, index) {
            const isEdit = containerId === "editTagContainer";
            const tagsArray = isEdit ? State.ui.editTags : State.ui.currentTags;
            
            tagsArray.splice(index, 1);
            this.render(containerId, inputId, tagsArray);
        }
    };

    // Global tag functions
    function handleTagInput(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            const input = document.getElementById("tagInput");
            Tags.add("tagContainer", "tagInput", State.ui.currentTags, input.value.trim());
            input.value = "";
        }
    }

    function handleEditTagInput(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            const input = document.getElementById("editTagInput");
            Tags.add("editTagContainer", "editTagInput", State.ui.editTags, input.value.trim());
            input.value = "";
        }
    }

    // ==================== MODAL MANAGEMENT ====================
    const Modal = {
        open(modalId) {
            State.ui.modalFocusTrap = document.activeElement;
            const modal = document.getElementById(modalId);
            modal.classList.remove("hidden");

            // Focus first interactive element
            setTimeout(() => {
                const focusable = modal.querySelector("input, button, textarea");
                if (focusable) focusable.focus();
            }, 100);
        },

        close(modalId) {
            document.getElementById(modalId).classList.add("hidden");

            // Restore focus
            if (State.ui.modalFocusTrap) {
                State.ui.modalFocusTrap.focus();
                State.ui.modalFocusTrap = null;
            }
        }
    };

    // Global modal functions (with cooldown)
    function showImportModal() { if (ButtonCooldown.canClick()) Modal.open("importModal"); }
    function showBackupModal() {
        if (ButtonCooldown.canClick()) {
            Modal.open("backupModal");
            document.getElementById("quizCount").textContent = Storage.getQuizzes().length;
        }
    }
    function closeModal(modalId) { if (ButtonCooldown.canClick()) Modal.close(modalId); }    // ==================== QUIZ LIST ====================
    const QuizList = {
        load() {
            const quizzes = Storage.getQuizzes();
            const quizList = document.getElementById("quizList");
            const searchQuery = document.getElementById("searchInput").value.toLowerCase();
            const filter = State.ui.currentFilter;

            // Filter quizzes
            let filtered = quizzes.filter(quiz => {
                const matchesSearch = quiz.title.toLowerCase().includes(searchQuery) ||
                    (quiz.tags && quiz.tags.some(tag => tag.toLowerCase().includes(searchQuery)));
                const matchesFilter = filter === "all" ||
                    (filter === "quiz" && quiz.type !== "flashcard") ||
                    (filter === "flashcard" && quiz.type === "flashcard");
                return matchesSearch && matchesFilter;
            });

            // Update cache
            RenderCache.update(searchQuery, filter, filtered);

            // Clear previous listeners
            Cleanup.clearEvents();

            // Empty state
            if (filtered.length === 0) {
                quizList.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state-icon">📭</div>
                        <h3>Brak wyników</h3>
                        <p>Nie znaleziono quizów spełniających kryteria</p>
                    </div>
                `;
                return;
            }

            // Sort by date (newest first)
            filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            // Render using DocumentFragment for performance
            const fragment = document.createDocumentFragment();

            filtered.forEach(quiz => {
                const itemHtml = this.generateItemHTML(quiz);
                const temp = document.createElement("div");
                temp.innerHTML = itemHtml;
                fragment.appendChild(temp.firstElementChild);
            });

            quizList.innerHTML = "";
            quizList.appendChild(fragment);

            // Attach event listeners
            this.attachListeners(quizList, filtered);
        },

        generateItemHTML(quiz) {
            const isFlashcard = quiz.type === "flashcard";
            const icon = isFlashcard ? "🎴" : "📊";
            const count = isFlashcard
                ? `${quiz.cards.length} fiszek`
                : `${quiz.questions.length} pytań`;

            const history = History.get(quiz.id);

            const tagsHtml = quiz.tags?.length > 0
                ? `<div class="quiz-tags">${quiz.tags.map(tag => 
                    `<span class="tag">${Utils.escapeHtml(tag)}</span>`
                ).join("")}</div>`
                : "";

            const isSelected = State.ui.selectedQuizzes.has(quiz.id);
            const selectedClass = isSelected ? "selected" : "";
            
            const checkboxHtml = State.ui.selectionMode
                ? `<input type="checkbox" class="quiz-checkbox" ${isSelected ? "checked" : ""} 
                    data-quiz-id="${quiz.id}" aria-label="Zaznacz ${Utils.escapeHtml(quiz.title)}">`
                : "";

            const statsHtml = history
                ? `<div class="quiz-stats-badge">Najlepszy: ${history.percentage}% (${history.points} pkt)</div>`
                : "";

            return `
                <article class="quiz-item animate-fadeIn ${selectedClass}" 
                    data-quiz-id="${quiz.id}" role="listitem" tabindex="0">
                    ${checkboxHtml}
                    <div class="quiz-type-icon" aria-hidden="true">${icon}</div>
                    <h3>${Utils.escapeHtml(quiz.title)}</h3>
                    <p>${count}</p>
                    ${tagsHtml}
                    ${statsHtml}
                    <div class="quiz-date">${Utils.formatDate(quiz.createdAt)}</div>
                </article>
            `;
        },

        attachListeners(container, quizzes) {
            container.querySelectorAll(".quiz-item").forEach(item => {
                const quizId = item.dataset.quizId;
                const quiz = quizzes.find(q => q.id === quizId);
                if (!quiz) return;

                const clickHandler = (e) => {
                    if (e.target.classList.contains("quiz-checkbox")) return;

                    if (State.ui.selectionMode) {
                        Selection.toggle(quizId);
                    } else {
                        if (quiz.type === "flashcard") {
                            Navigation.showPreFlashcard(quizId);
                        } else {
                            Navigation.showPreQuiz(quizId);
                        }
                    }
                };

                Cleanup.registerEvent(item, "click", clickHandler);
                Cleanup.registerEvent(item, "keydown", (e) => {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        clickHandler(e);
                    }
                });

                // Checkbox handler
                const checkbox = item.querySelector(".quiz-checkbox");
                if (checkbox) {
                    Cleanup.registerEvent(checkbox, "click", (e) => {
                        e.stopPropagation();
                        Selection.toggle(quizId);
                    });
                }
            });
        }
    };

    // Global filter functions
    function filterQuizzes() {
        clearTimeout(State.system.searchDebounceTimer);
        State.system.searchDebounceTimer = setTimeout(() => {
            QuizList.load();
        }, CONSTANTS.SEARCH_DEBOUNCE_MS);
    }

    function setFilter(filter) {
        State.ui.currentFilter = filter;
        document.querySelectorAll(".filter-btn").forEach(btn => {
            const isActive = btn.dataset.filter === filter;
            btn.classList.toggle("active", isActive);
            btn.setAttribute("aria-pressed", isActive);
        });
        QuizList.load();
    }

    // ==================== SELECTION MODE ====================
    const Selection = {
        toggle(quizId) {
            if (State.ui.selectedQuizzes.has(quizId)) {
                State.ui.selectedQuizzes.delete(quizId);
            } else {
                State.ui.selectedQuizzes.add(quizId);
            }
            document.getElementById("selectedCount").textContent = 
                `${State.ui.selectedQuizzes.size} zaznaczonych`;
            QuizList.load();
        },

        toggleMode() {
            State.ui.selectionMode = !State.ui.selectionMode;
            State.ui.selectedQuizzes.clear();

            const btn = document.getElementById("selectionModeBtn");
            const batchActions = document.getElementById("batchActions");
            const topButtons = document.getElementById("topButtons");

            if (State.ui.selectionMode) {
                btn.textContent = "✕ Anuluj zaznaczanie";
                btn.classList.add("btn-danger");
                batchActions.classList.remove("hidden");
                topButtons.classList.add("hidden");
                document.getElementById("selectedCount").textContent = "0 zaznaczonych";
            } else {
                btn.textContent = "☑️ Zaznacz wiele";
                btn.classList.remove("btn-danger");
                batchActions.classList.add("hidden");
                topButtons.classList.remove("hidden");
            }

            RenderCache.clear();
            QuizList.load();
        },

        clear() {
            this.toggleMode();
        },

        batchDelete() {
            if (State.ui.selectedQuizzes.size === 0) {
                showToast("Nie zaznaczono żadnych quizów", "info");
                return;
            }

            if (confirm(`Czy na pewno chcesz usunąć ${State.ui.selectedQuizzes.size} quizów?`)) {
                const quizzes = Storage.getQuizzes();
                const filtered = quizzes.filter(q => !State.ui.selectedQuizzes.has(q.id));
                Storage.saveQuizzes(filtered);

                // Clean up history
                const history = Storage.getQuizHistory();
                State.ui.selectedQuizzes.forEach(id => delete history[id]);
                Storage.saveQuizHistory(history);

                showToast(`Usunięto ${State.ui.selectedQuizzes.size} quizów`, "success");
                State.ui.selectedQuizzes.clear();
                this.toggleMode();
            }
        },

        batchExport() {
            if (State.ui.selectedQuizzes.size === 0) {
                showToast("Nie zaznaczono żadnych quizów", "info");
                return;
            }

            const quizzes = Storage.getQuizzes();
            const selected = quizzes.filter(q => State.ui.selectedQuizzes.has(q.id));
            ImportExport.exportQuizData(selected, `quizapp_${State.ui.selectedQuizzes.size}_quizow`);
        }
    };

    // Global selection functions (with cooldown)
    function toggleSelectionMode() { if (ButtonCooldown.canClick()) Selection.toggleMode(); }
    function clearSelection() { if (ButtonCooldown.canClick()) Selection.clear(); }
    function batchDelete() { if (ButtonCooldown.canClick()) Selection.batchDelete(); }
    function batchExport() { if (ButtonCooldown.canClick()) Selection.batchExport(); }
    function toggleQuizSelection(quizId) { if (ButtonCooldown.canClick()) Selection.toggle(quizId); }
    // ==================== QUIZ CRUD ====================
    const QuizCRUD = {
        save() {
            const jsonText = document.getElementById("quizJson").value.trim();
            const titleInput = Utils.sanitizeInput(
                document.getElementById("quizTitle").value.trim(),
                CONSTANTS.MAX_TITLE_LENGTH
            );

            if (!jsonText) {
                showToast("Wklej JSON quizu", "error");
                return;
            }

            try {
                const quizData = JSON.parse(jsonText);

                if (!DataFormat.validate(quizData)) {
                    throw new Error("Nieprawidłowy format JSON");
                }

                const decoded = DataFormat.decode(quizData);
                const sanitized = Utils.sanitizeQuizData(decoded);

                const finalTitle = titleInput || sanitized.title;
                if (!finalTitle) {
                    throw new Error("Brak tytułu quizu");
                }

                const allTags = [...new Set([
                    ...State.ui.currentTags,
                    ...(sanitized.tags || [])
                ])].filter(Boolean);

                const quizzes = Storage.getQuizzes();

                // Check for duplicates
                if (quizzes.find(q => q.data === sanitized.data)) {
                    showToast("Ten quiz już istnieje!", "info");
                    return;
                }

                const quiz = {
                    title: finalTitle,
                    tags: allTags,
                    type: sanitized.type,
                    data: sanitized.data,
                    id: Utils.generateId(),
                    createdAt: new Date().toISOString()
                };

                if (sanitized.type === "flashcard") {
                    quiz.cards = sanitized.cards;
                } else {
                    quiz.questions = sanitized.questions;
                }

                quizzes.push(quiz);

                if (Storage.saveQuizzes(quizzes)) {
                    RenderCache.clear();
                    showToast("Quiz zapisany!", "success");
                    Navigation.showHome();
                }
            } catch (error) {
                showToast("Błąd: " + error.message, "error");
            }
        },

        update() {
            const jsonText = document.getElementById("editQuizJson").value.trim();
            const title = Utils.sanitizeInput(
                document.getElementById("editQuizTitle").value.trim(),
                CONSTANTS.MAX_TITLE_LENGTH
            );

            if (!jsonText || !title) {
                showToast("Wypełnij wszystkie pola", "error");
                return;
            }

            try {
                const updatedData = JSON.parse(jsonText);

                if (!DataFormat.validate(updatedData)) {
                    throw new Error("Nieprawidłowy format JSON");
                }

                const decoded = DataFormat.decode(updatedData);
                const sanitized = Utils.sanitizeQuizData(decoded);

                const quizzes = Storage.getQuizzes();
                const index = quizzes.findIndex(q => q.id === State.ui.currentEditingId);

                if (index !== -1) {
                    const allTags = [...new Set([
                        ...State.ui.editTags,
                        ...(sanitized.tags || [])
                    ])].filter(Boolean);

                    quizzes[index] = {
                        ...quizzes[index],
                        title: title,
                        tags: allTags,
                        type: sanitized.type,
                        data: sanitized.data,
                        updatedAt: new Date().toISOString()
                    };

                    if (sanitized.type === "flashcard") {
                        quizzes[index].cards = sanitized.cards;
                    } else {
                        quizzes[index].questions = sanitized.questions;
                    }

                    if (Storage.saveQuizzes(quizzes)) {
                        RenderCache.clear();
                        showToast("Quiz zaktualizowany!", "success");
                        Navigation.showHome();
                    }
                }
            } catch (error) {
                showToast("Błąd: " + error.message, "error");
            }
        },

        delete(quizId) {
            const quizzes = Storage.getQuizzes();
            const filtered = quizzes.filter(q => q.id !== quizId);
            Storage.saveQuizzes(filtered);

            // Clean up history
            const history = Storage.getQuizHistory();
            delete history[quizId];
            Storage.saveQuizHistory(history);

            RenderCache.clear();
            showToast("Quiz usunięty", "success");
        },

        deleteCurrent() {
            if (confirm("Czy na pewno chcesz usunąć ten quiz?")) {
                this.delete(State.ui.currentEditingId);
                Navigation.showHome();
            }
        }
    };

    // Global CRUD functions (with cooldown)
    function saveQuiz() { if (ButtonCooldown.canClick()) QuizCRUD.save(); }
    function updateQuiz() { if (ButtonCooldown.canClick()) QuizCRUD.update(); }
    function deleteCurrentQuiz() { if (ButtonCooldown.canClick()) QuizCRUD.deleteCurrent(); }
    // ==================== QUIZ GAMEPLAY ====================
    const QuizGame = {
        start() {
            State.quiz.settings.randomOrder = document.getElementById("randomOrder").checked;
            State.quiz.settings.showLetters = document.getElementById("showLetters").checked;

            State.quiz.questions = [...State.quiz.current.questions];

            if (State.quiz.settings.randomOrder) {
                State.quiz.questions = Utils.shuffleArray(State.quiz.questions);
            }

            State.quiz.queue = State.quiz.questions.map((q, index) => ({
                question: q,
                originalIndex: index,
                isRetry: false
            }));

            State.quiz.currentIndex = 0;
            State.quiz.answeredCount = 0;
            State.quiz.score = 0;
            State.quiz.totalPoints = 0;
            State.quiz.correctAnswers = 0;
            State.quiz.startTime = Date.now();
            State.quiz.firstAttemptCorrect = new Set();
            State.quiz.firstAttemptAnswered = 0;
            State.quiz.retriedQuestions = new Set();

                Navigation.showScreen("quizScreen");
                
                // Initialize stats display immediately
                document.getElementById("questionNumber").textContent = `Pytanie 0/${State.quiz.questions.length} (1/${State.quiz.queue.length})`;
                document.getElementById("accuracy").textContent = "Poprawność: 0%";
                document.getElementById("score").textContent = "Punkty: 0";
                document.getElementById("progressBar").style.width = "0%";
                
                this.displayQuestion();
                Timer.start("quizTimer");        },

        displayQuestion() {
            if (State.quiz.currentIndex >= State.quiz.queue.length) {
                this.end();
                return;
            }

            const currentItem = State.quiz.queue[State.quiz.currentIndex];
            const question = currentItem.question;
            const isRetry = currentItem.isRetry;

            // Update question text
            document.getElementById("questionText").textContent = question.question;

            // Retry badge
            const retryBadge = document.getElementById("retryBadge");
            retryBadge.classList.toggle("hidden", !isRetry);

            // Category
            const categoryEl = document.getElementById("questionCategory");
            if (question.group) {
                categoryEl.textContent = question.group;
                categoryEl.style.display = "block";
            } else {
                categoryEl.style.display = "none";
            }

            // Prepare answers
            const isTrueFalse = question.type === "tf";
            const answers = isTrueFalse
                ? Utils.shuffleArray(["Prawda", "Fałsz"])
                : this.prepareAnswers(question);

            // Render answers
            const answersGrid = document.getElementById("answersGrid");
            answersGrid.className = `answers-grid ${isTrueFalse ? "two-answers" : "four-answers"}`;

            const letters = ["A", "B", "C", "D"];
            answersGrid.innerHTML = answers.map((answer, index) => `
                <button class="answer-btn" 
                    onclick="QuizGame.selectAnswer('${Utils.escapeHtml(answer)}', '${Utils.escapeHtml(question.correct)}', ${currentItem.originalIndex}, ${isRetry})" 
                    data-answer="${Utils.escapeHtml(answer)}">
                    ${State.quiz.settings.showLetters ? `<span class="answer-letter">${letters[index]}</span>` : ""}
                    ${Utils.escapeHtml(answer)}
                </button>
            `).join("");

            this.updateProgress();
            this.updateStats();
            State.quiz.questionStartTime = Date.now();
        },

        prepareAnswers(question) {
            let answers = [question.correct];
            let wrongAnswers = [...question.wrong];

            const needed = 3; // Need 3 wrong answers for 4 total

            if (wrongAnswers.length < needed) {
                const additional = this.getAdditionalWrongAnswers(question, needed - wrongAnswers.length);
                wrongAnswers = [...wrongAnswers, ...additional];
            }

            wrongAnswers = Utils.shuffleArray(wrongAnswers).slice(0, needed);
            answers = [...answers, ...wrongAnswers];

            return Utils.shuffleArray(answers);
        },

        getAdditionalWrongAnswers(currentQuestion, needed) {
            const additional = [];
            const questions = State.quiz.questions;

            // First try same group
            const sameGroup = questions.filter(q =>
                q !== currentQuestion &&
                q.group === currentQuestion.group &&
                q.correct !== currentQuestion.correct &&
                q.type !== "tf"
            );

            for (let i = 0; i < Math.min(needed, sameGroup.length); i++) {
                additional.push(sameGroup[i].correct);
            }

            // Then try other questions
            if (additional.length < needed) {
                const others = questions.filter(q =>
                    q !== currentQuestion &&
                    q.correct !== currentQuestion.correct &&
                    !additional.includes(q.correct) &&
                    q.type !== "tf"
                );

                for (let i = 0; i < Math.min(needed - additional.length, others.length); i++) {
                    additional.push(others[i].correct);
                }
            }

            return additional;
        },

        selectAnswer(selected, correct, originalIndex, isRetry) {
            selected = Utils.decodeHtml(selected);
            correct = Utils.decodeHtml(correct);

            const buttons = document.querySelectorAll(".answer-btn");
            const timeElapsed = (Date.now() - State.quiz.questionStartTime) / 1000;
            const basePoints = buttons.length * CONSTANTS.BASE_POINTS_MULTIPLIER;
            let earnedPoints = 0;

            // Disable all buttons and show correct answer
            buttons.forEach(btn => {
                btn.disabled = true;
                if (Utils.decodeHtml(btn.dataset.answer) === correct) {
                    btn.classList.add("correct");
                }
            });

            const selectedBtn = Array.from(buttons).find(
                btn => Utils.decodeHtml(btn.dataset.answer) === selected
            );

            if (selected === correct) {
                if (!isRetry) {
                    State.quiz.firstAttemptAnswered++;
                }

                if (!isRetry && !State.quiz.firstAttemptCorrect.has(originalIndex)) {
                    State.quiz.firstAttemptCorrect.add(originalIndex);
                    State.quiz.correctAnswers++;
                    State.quiz.score++;
                    State.quiz.answeredCount++;

                    const timePenalty = Math.min(
                        buttons.length * CONSTANTS.MAX_TIME_PENALTY_DIVISOR,
                        Math.round(timeElapsed * CONSTANTS.TIME_PENALTY_MULTIPLIER)
                    );
                    earnedPoints = basePoints - timePenalty;
                    State.quiz.totalPoints += earnedPoints;
                }

                Utils.announceToScreenReader(`Poprawna odpowiedź! +${earnedPoints} punktów.`);
            } else {
                if (!isRetry) {
                    State.quiz.firstAttemptAnswered++;
                }

                selectedBtn.classList.add("incorrect");
                selectedBtn.classList.add("animate-shake");

                // Add to retry queue
                const currentItem = State.quiz.queue[State.quiz.currentIndex];
                if (!State.quiz.retriedQuestions.has(currentItem.originalIndex)) {
                    State.quiz.queue.push({
                        question: currentItem.question,
                        originalIndex: currentItem.originalIndex,
                        isRetry: true
                    });
                    State.quiz.retriedQuestions.add(currentItem.originalIndex);
                }

                Utils.announceToScreenReader("Niepoprawna odpowiedź. Pytanie zostanie powtórzone.");
            }

            this.updateStats();

            setTimeout(() => {
                State.quiz.currentIndex++;
                this.displayQuestion();
            }, CONSTANTS.ANSWER_DELAY_MS);
        },

        updateProgress() {
            const total = State.quiz.questions.length;
            const progress = (State.quiz.currentIndex / State.quiz.queue.length) * 100;
            
            document.getElementById("progressBar").style.width = `${progress}%`;
            document.getElementById("questionNumber").textContent = 
                `Pytanie ${State.quiz.answeredCount}/${total} (${State.quiz.currentIndex + 1}/${State.quiz.queue.length})`;
        },

        updateStats() {
            const accuracy = State.quiz.firstAttemptAnswered > 0
                ? Math.round((State.quiz.firstAttemptCorrect.size / State.quiz.firstAttemptAnswered) * 100)
                : 0;
            
            document.getElementById("accuracy").textContent = `Poprawność: ${accuracy}%`;
            document.getElementById("score").textContent = `Punkty: ${State.quiz.totalPoints}`;
        },

        end() {
            Timer.stop();
            const totalTime = Timer.getElapsed();
            const percentage = Math.round((State.quiz.score / State.quiz.questions.length) * 100);

            // Skip if no score
            if (State.quiz.score === 0 || State.quiz.totalPoints === 0) {
                showToast("Quiz zakończony bez wyniku", "info");
                Navigation.showHome();
                return;
            }

            document.getElementById("finalScore").textContent = 
                `${State.quiz.score}/${State.quiz.questions.length} (${percentage}%)`;
            document.getElementById("finalPoints").textContent = `${State.quiz.totalPoints} punktów`;
            document.getElementById("finalTime").textContent = `Czas: ${Utils.formatTime(totalTime)}`;

            // Save result
            History.save(State.quiz.current.id, {
                score: State.quiz.score,
                total: State.quiz.questions.length,
                percentage: percentage,
                points: State.quiz.totalPoints,
                time: totalTime,
                date: new Date().toISOString()
            });

            Utils.announceToScreenReader(
                `Quiz zakończony. Wynik: ${State.quiz.score} na ${State.quiz.questions.length}, ${percentage}%.`
            );

            Navigation.showScreen("resultsScreen");
        },

        endEarly() {
            if (State.quiz.currentIndex < State.quiz.questions.length || State.quiz.score === 0) {
                if (confirm("Zakończyć quiz? Postęp nie zostanie zapisany.")) {
                    Timer.stop();
                    Navigation.showHome();
                }
            } else {
                if (confirm("Zakończyć quiz? Postęp zostanie zapisany.")) {
                    this.end();
                }
            }
        },

        retake() {
            Navigation.showPreQuiz(State.quiz.current.id);
        }
    };

    // Global quiz functions (with cooldown)
    function startQuiz() { if (ButtonCooldown.canClick()) QuizGame.start(); }
    function endQuizEarly() { if (ButtonCooldown.canClick()) QuizGame.endEarly(); }
    function retakeQuiz() { if (ButtonCooldown.canClick()) QuizGame.retake(); }
    // ==================== FLASHCARD GAMEPLAY ====================
    const FlashcardGame = {
        start() {
            Navigation.showScreen("flashcardScreen");

            const randomOrder = document.getElementById("flashcardRandomOrder").checked;

            State.flashcard.cards = [...State.flashcard.current.cards];
            if (randomOrder) {
                State.flashcard.cards = Utils.shuffleArray(State.flashcard.cards);
            }

            State.flashcard.queue = State.flashcard.cards.map((c, index) => ({
                card: c,
                originalIndex: index,
                isRetry: false
            }));

            State.flashcard.currentIndex = 0;
            State.flashcard.answeredCount = 0;
            State.flashcard.stats = { easy: 0, medium: 0, hard: 0 };
            State.flashcard.isFlipped = false;
            State.flashcard.isTransitioning = false;
            State.flashcard.completedCards = new Set();
            State.flashcard.retriedCards = new Set();
            State.flashcard.startTime = Date.now();

                // Initialize stats display immediately
                document.getElementById("flashcardNumber").textContent = `Fiszka 0/${State.flashcard.cards.length} (1/${State.flashcard.queue.length})`;
                document.getElementById("flashcardStats").textContent = "Poznane: 0 | Trudne: 0";
                document.getElementById("flashcardProgress").style.width = "0%";
            
                this.displayCard();
                Timer.start("flashcardTimer");        },

        displayCard() {
            if (State.flashcard.currentIndex >= State.flashcard.queue.length) {
                this.end();
                return;
            }

            const currentItem = State.flashcard.queue[State.flashcard.currentIndex];
            const card = currentItem.card;
            const isRetry = currentItem.isRetry;

            const flashcardEl = document.getElementById("flashcard");
            flashcardEl.classList.remove("flipped");
            document.getElementById("flashcardActions").style.display = "none";
            State.flashcard.isFlipped = false;

            // Reset scroll positions
            const frontSide = document.querySelector(".flashcard-front");
            const backSide = document.querySelector(".flashcard-back");
            if (frontSide) frontSide.scrollTop = 0;
            if (backSide) backSide.scrollTop = 0;

            // Update retry badges
            const retryFront = document.getElementById("flashcardRetryBadgeFront");
            const retryBack = document.getElementById("flashcardRetryBadgeBack");

            // Update content with slight delay for animation
            setTimeout(() => {
                document.getElementById("flashcardFront").textContent = card.front;
                retryFront.classList.toggle("hidden", !isRetry);
            }, 0);

            setTimeout(() => {
                document.getElementById("flashcardBack").textContent = card.back;
                retryBack.classList.toggle("hidden", !isRetry);
            }, 300);

            this.updateProgress();
        },

        flip() {
            if (State.flashcard.isTransitioning) return;

            State.flashcard.isTransitioning = true;
            const flashcardEl = document.getElementById("flashcard");
            const actionsEl = document.getElementById("flashcardActions");

            if (!State.flashcard.isFlipped) {
                flashcardEl.classList.add("flipped");
                State.flashcard.isFlipped = true;

                const timer = setTimeout(() => {
                    actionsEl.style.display = "flex";
                    const backSide = document.querySelector(".flashcard-back");
                    if (backSide) backSide.scrollTop = 0;
                    State.flashcard.isTransitioning = false;
                    Cleanup.timers.delete(timer);
                }, CONSTANTS.FLIP_ANIMATION_MS);

                Cleanup.registerTimer(timer);
            } else {
                flashcardEl.classList.remove("flipped");
                State.flashcard.isFlipped = false;
                actionsEl.style.display = "none";

                const timer = setTimeout(() => {
                    const frontSide = document.querySelector(".flashcard-front");
                    if (frontSide) frontSide.scrollTop = 0;
                    State.flashcard.isTransitioning = false;
                    Cleanup.timers.delete(timer);
                }, CONSTANTS.FLIP_ANIMATION_MS);

                Cleanup.registerTimer(timer);
            }
        },

        rate(difficulty) {
            if (State.flashcard.isTransitioning) return;

            State.flashcard.isTransitioning = true;
            const currentItem = State.flashcard.queue[State.flashcard.currentIndex];
            const isRetry = currentItem.isRetry;

            if (difficulty === "easy") {
                if (!isRetry) {
                    State.flashcard.stats.easy++;
                }
                State.flashcard.completedCards.add(currentItem.originalIndex);
                State.flashcard.answeredCount++;
            } else {
                if (!isRetry) {
                    State.flashcard.stats[difficulty]++;
                }

                // Add to retry queue
                if (!State.flashcard.retriedCards.has(currentItem.originalIndex)) {
                    State.flashcard.queue.push({
                        card: currentItem.card,
                        originalIndex: currentItem.originalIndex,
                        isRetry: true
                    });
                    State.flashcard.retriedCards.add(currentItem.originalIndex);
                }
            }

            this.updateStats();

            const flashcardEl = document.getElementById("flashcard");
            const actionsEl = document.getElementById("flashcardActions");
            actionsEl.style.display = "none";

            State.flashcard.currentIndex++;

            // Flip back animation
            if (State.flashcard.isFlipped) {
                flashcardEl.classList.remove("flipped");
                State.flashcard.isFlipped = false;
                this.displayCard();

                const timer = setTimeout(() => {
                    State.flashcard.isTransitioning = false;
                    Cleanup.timers.delete(timer);
                }, CONSTANTS.FLIP_ANIMATION_MS);

                Cleanup.registerTimer(timer);
            } else {
                this.displayCard();

                const timer = setTimeout(() => {
                    State.flashcard.isTransitioning = false;
                    Cleanup.timers.delete(timer);
                }, 100);

                Cleanup.registerTimer(timer);
            }
        },

        updateProgress() {
            const total = State.flashcard.cards.length;
            const progress = (State.flashcard.currentIndex / State.flashcard.queue.length) * 100;
            
            document.getElementById("flashcardProgress").style.width = `${progress}%`;
            document.getElementById("flashcardNumber").textContent = 
                `Fiszka ${State.flashcard.answeredCount}/${total} (${State.flashcard.currentIndex + 1}/${State.flashcard.queue.length})`;
        },

        updateStats() {
            const { easy, medium, hard } = State.flashcard.stats;
            document.getElementById("flashcardStats").textContent = 
                `Poznane: ${easy} | Trudne: ${medium + hard}`;
        },

        end() {
            Timer.stop();
            const totalTime = Timer.getElapsed();
            const knownPercent = State.flashcard.cards.length > 0
                ? Math.round((State.flashcard.stats.easy / State.flashcard.cards.length) * 100)
                : 0;

            document.getElementById("flashcardEasyCount").textContent = State.flashcard.stats.easy;
            document.getElementById("flashcardMediumCount").textContent = State.flashcard.stats.medium;
            document.getElementById("flashcardHardCount").textContent = State.flashcard.stats.hard;
            document.getElementById("flashcardFinalTime").textContent = 
                `Czas: ${Utils.formatTime(totalTime)} · Znane: ${knownPercent}%`;

            Navigation.showScreen("flashcardResultsScreen");
        },

        endEarly() {
            if (confirm("Zakończyć naukę? Postęp nie zostanie zapisany.")) {
                Timer.stop();
                Navigation.showHome();
            }
        },

        retake() {
            Navigation.showPreFlashcard(State.flashcard.current.id);
        }
    };

    // Global flashcard functions (with cooldown)
    function startFlashcards() { if (ButtonCooldown.canClick()) FlashcardGame.start(); }
    function flipCard() { if (ButtonCooldown.canClick()) FlashcardGame.flip(); }
    function rateCard(difficulty) { if (ButtonCooldown.canClick()) FlashcardGame.rate(difficulty); }
    function endFlashcardsEarly() { if (ButtonCooldown.canClick()) FlashcardGame.endEarly(); }
    function retakeFlashcards() { if (ButtonCooldown.canClick()) FlashcardGame.retake(); }
    // ==================== HISTORY ====================
    const History = {
        get(quizId) {
            const history = Storage.getQuizHistory();
            return history[quizId] || null;
        },

        save(quizId, result) {
            if (result.score === 0 || result.percentage === 0) return;

            const history = Storage.getQuizHistory();

            // Only save if better than previous
            if (!history[quizId] || result.points > history[quizId].points) {
                history[quizId] = result;
                Storage.saveQuizHistory(history);
                RenderCache.clear();
            }
        },

        clearAll() {
            if (confirm("Usunąć całą historię wyników?")) {
                Storage.set(CONSTANTS.STORAGE_KEYS.QUIZ_HISTORY, {});
                Storage.set(CONSTANTS.STORAGE_KEYS.FLASHCARD_HISTORY, {});
                showToast("Historia wyczyszczona", "success");
                Modal.close("storageCleanupModal");
            }
        },

        clearOld() {
            const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;
            let removedCount = 0;

            const quizHistory = Storage.getQuizHistory();
            Object.keys(quizHistory).forEach(quizId => {
                if (new Date(quizHistory[quizId].date).getTime() < thirtyDaysAgo) {
                    delete quizHistory[quizId];
                    removedCount++;
                }
            });
            Storage.saveQuizHistory(quizHistory);

            showToast(`Usunięto ${removedCount} starych wpisów`, "success");
            Modal.close("storageCleanupModal");
        }
    };

    // Global history functions
    function clearAllHistory() { History.clearAll(); }
    function clearOldHistory() { History.clearOld(); }

    // ==================== IMPORT/EXPORT ====================
    const ImportExport = {
        copyPrompt() {
            const prompt = document.getElementById("aiPrompt").textContent;
            navigator.clipboard.writeText(prompt).then(() => {
                showToast("Prompt skopiowany!", "success");
            });
        },

        handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById("importJson").value = e.target.result;
            };
            reader.readAsText(file);
        },

        importQuiz() {
            const jsonText = document.getElementById("importJson").value;

            try {
                const data = JSON.parse(jsonText);
                const quizzes = Storage.getQuizzes();

                if (Array.isArray(data)) {
                    let addedCount = 0, skippedCount = 0, invalidCount = 0;

                    data.forEach(quiz => {
                        if (!DataFormat.validate(quiz)) {
                            invalidCount++;
                            return;
                        }

                        const decoded = DataFormat.decode(quiz);
                        if (quizzes.find(q => q.data === decoded.data)) {
                            skippedCount++;
                            return;
                        }

                        const newQuiz = {
                            title: decoded.title,
                            tags: decoded.tags,
                            type: decoded.type,
                            data: decoded.data,
                            id: Utils.generateId(),
                            createdAt: new Date().toISOString()
                        };

                        if (decoded.type === "flashcard") {
                            newQuiz.cards = decoded.cards;
                        } else {
                            newQuiz.questions = decoded.questions;
                        }

                        quizzes.push(newQuiz);
                        addedCount++;
                    });

                    if (Storage.saveQuizzes(quizzes)) {
                        RenderCache.clear();
                        let msg = `Zaimportowano ${addedCount} quizów`;
                        if (skippedCount) msg += `, pominięto ${skippedCount} duplikatów`;
                        if (invalidCount) msg += `, odrzucono ${invalidCount} nieprawidłowych`;
                        showToast(msg, "success");
                    }
                } else {
                    if (!DataFormat.validate(data)) {
                        throw new Error("Nieprawidłowy format JSON");
                    }

                    const decoded = DataFormat.decode(data);
                    
                    if (quizzes.find(q => q.data === decoded.data)) {
                        showToast("Quiz już istnieje", "info");
                        Modal.close("importModal");
                        return;
                    }

                    const quiz = {
                        title: decoded.title,
                        tags: decoded.tags,
                        type: decoded.type,
                        data: decoded.data,
                        id: Utils.generateId(),
                        createdAt: new Date().toISOString()
                    };

                    if (decoded.type === "flashcard") {
                        quiz.cards = decoded.cards;
                    } else {
                        quiz.questions = decoded.questions;
                    }

                    quizzes.push(quiz);
                    
                    if (Storage.saveQuizzes(quizzes)) {
                        RenderCache.clear();
                        showToast("Quiz zaimportowany!", "success");
                    }
                }

                Modal.close("importModal");
                document.getElementById("importJson").value = "";
                document.getElementById("importFile").value = "";
                QuizList.load();
            } catch (error) {
                showToast("Błąd importu: " + error.message, "error");
            }
        },

        exportQuiz(quizId) {
            const quizzes = Storage.getQuizzes();
            const quiz = quizzes.find(q => q.id === quizId);

            if (!quiz) {
                showToast("Quiz nie znaleziony", "error");
                return;
            }

            this.exportQuizData([quiz], quiz.title);
        },

        exportQuizData(quizzes, filename = "export") {
            const exportData = quizzes.map(q => DataFormat.encode(q));
            const data = exportData.length === 1 ? exportData[0] : exportData;

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${filename.replace(/[^a-z0-9]/gi, "_")}.json`;

            setTimeout(() => {
                a.click();
                URL.revokeObjectURL(url);
                showToast(quizzes.length === 1 ? "Quiz wyeksportowany!" : `Wyeksportowano ${quizzes.length} quizów`, "success");
            }, 100);
        },

        exportAllData() {
            const quizzes = Storage.getQuizzes();
            const history = Storage.getQuizHistory();
            const flashcardHistory = Storage.get(CONSTANTS.STORAGE_KEYS.FLASHCARD_HISTORY, {});

            const backup = {
                version: "2.5",
                exportDate: new Date().toISOString(),
                quizzes: quizzes.map(q => DataFormat.encode(q)),
                history: history,
                flashcardHistory: flashcardHistory
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `quizapp_backup_${new Date().toISOString().split("T")[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showToast("Backup utworzony!", "success");
        },

        restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm("Przywrócić dane? Obecne dane zostaną nadpisane!")) {
                event.target.value = "";
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    let invalidCount = 0;

                    if (backup.quizzes) {
                        const validQuizzes = [];

                        backup.quizzes.forEach(quiz => {
                            if (DataFormat.validate(quiz)) {
                                try {
                                    const decoded = DataFormat.decode(quiz);
                                    const restored = {
                                        title: decoded.title,
                                        tags: decoded.tags,
                                        type: decoded.type,
                                        data: decoded.data,
                                        id: Utils.generateId(),
                                        createdAt: new Date().toISOString()
                                    };

                                    if (decoded.type === "flashcard") {
                                        restored.cards = decoded.cards;
                                    } else {
                                        restored.questions = decoded.questions;
                                    }

                                    validQuizzes.push(restored);
                                } catch {
                                    invalidCount++;
                                }
                            } else {
                                invalidCount++;
                            }
                        });

                        Storage.saveQuizzes(validQuizzes);
                    }

                    if (backup.history) {
                        Storage.saveQuizHistory(backup.history);
                    }

                    if (backup.flashcardHistory) {
                        Storage.set(CONSTANTS.STORAGE_KEYS.FLASHCARD_HISTORY, backup.flashcardHistory);
                    }

                    RenderCache.clear();
                    Modal.close("backupModal");
                    QuizList.load();

                    const msg = invalidCount > 0
                        ? `Dane przywrócone (odrzucono ${invalidCount} nieprawidłowych)`
                        : "Dane przywrócone!";
                    showToast(msg, "success");
                } catch (error) {
                    showToast("Błąd przywracania: " + error.message, "error");
                }

                event.target.value = "";
            };
            reader.readAsText(file);
        }
    };

    // Global import/export functions (with cooldown)
    function copyPrompt() { if (ButtonCooldown.canClick()) ImportExport.copyPrompt(); }
    function handleFileImport(event) { ImportExport.handleFileImport(event); } // No cooldown for file input
    function importQuiz() { if (ButtonCooldown.canClick()) ImportExport.importQuiz(); }
    function exportQuiz(quizId) { if (ButtonCooldown.canClick()) ImportExport.exportQuiz(quizId); }
    function exportAllData() { if (ButtonCooldown.canClick()) ImportExport.exportAllData(); }
    function restoreData(event) { ImportExport.restoreData(event); } // No cooldown for file input
    // ==================== SHARING ====================
    const Sharing = {
        async share(quizId) {
            const quizzes = Storage.getQuizzes();
            const quiz = quizzes.find(q => q.id === quizId);
        
            if (!quiz) {
                showToast("Quiz nie znaleziony", "error");
                return;
            }
        
            Modal.open("shareModal");
            document.getElementById("shareContent").innerHTML = `
                <div style="text-align: center; padding: var(--space-10) var(--space-5);">
                    <div class="loading-spinner" style="font-size: 48px; margin-bottom: var(--space-4);">⏳</div>
                    <p style="color: var(--text-secondary); font-size: var(--text-sm);">Generowanie linku...</p>
                </div>
            `;
        
            const startTime = Date.now();
        
            try {
                const shareData = DataFormat.encode(quiz);
                const jsonString = JSON.stringify(shareData);
                const encoder = new TextEncoder();
                const uint8 = encoder.encode(jsonString);
                const deflated = pako.deflate(uint8, { level: 9 });
        
                let binary = "";
                for (let i = 0; i < deflated.length; i++) {
                    binary += String.fromCharCode(deflated[i]);
                }
                const compressed = btoa(binary)
                    .replace(/\+/g, "-")
                    .replace(/\//g, "_")
                    .replace(/=/g, "");
        
                const fullUrl = `${CONSTANTS.SHARE_BASE_URL}#q=${compressed}`;
        
                const itemCount = quiz.type === "flashcard" ? quiz.cards.length : quiz.questions.length;
                const itemType = quiz.type === "flashcard" ? "fiszek" : "pytań";
        
                // Ensure minimum loading time
                const elapsed = Date.now() - startTime;
                await new Promise(resolve => setTimeout(resolve, Math.max(0, CONSTANTS.MIN_LOADING_TIME_MS - elapsed)));
        
                const contentHtml = `
                    <div style="margin-bottom: var(--space-6);">
                        <p style="color: var(--text-secondary); font-size: var(--text-sm);">
                            <strong>${Utils.escapeHtml(quiz.title)}</strong><br>
                            ${itemCount} ${itemType}
                        </p>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: var(--space-4); border-radius: var(--radius-md);">
                        <p style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-2);">
                            Link do udostępnienia:
                        </p>
                        <input type="text" value="${fullUrl}" readonly 
                            style="width: 100%; padding: var(--space-2) var(--space-3); border: 1px solid var(--border-light); border-radius: var(--radius-sm); font-size: var(--text-xs); font-family: var(--font-mono); background: var(--bg-elevated); color: var(--text-primary);"
                            onclick="this.select()" id="fullUrlInput">
                        <button class="btn btn-primary" id="copyLinkBtn" style="width: 100%; margin-top: var(--space-3);">
                            📋 Kopiuj link
                        </button>
                    </div>
                `;
        
                document.getElementById("shareContent").innerHTML = contentHtml;
        
                // Attach copy handler
                document.getElementById("copyLinkBtn").addEventListener("click", () => {
                    navigator.clipboard.writeText(fullUrl).then(() => {
                        showToast("Link skopiowany! 🔗", "success");
                        Modal.close("shareModal");
                    }).catch(() => {
                        showToast("Nie udało się skopiować", "error");
                    });
                });
            } catch (error) {
                const elapsed = Date.now() - startTime;
                await new Promise(resolve => setTimeout(resolve, Math.max(0, CONSTANTS.MIN_LOADING_TIME_MS - elapsed)));
        
                document.getElementById("shareContent").innerHTML = `
                    <div style="text-align: center; padding: var(--space-10) var(--space-5);">
                        <div style="font-size: 48px; margin-bottom: var(--space-4);">❌</div>
                        <p style="color: var(--danger-500);">Błąd: ${Utils.escapeHtml(error.message)}</p>
                    </div>
                `;
            }
        },
        checkSharedQuiz() {
            const hash = window.location.hash;
            
            if (!hash.startsWith("#q=")) {
                Navigation.showHome();
                return;
            }

            const compressed = hash.substring(3);
            
            try {
                // Decode base64url
                let base64 = compressed.replace(/-/g, "+").replace(/_/g, "/");
                while (base64.length % 4) base64 += "=";

                const binaryString = atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                // Decompress
                const decompressed = pako.inflate(bytes);
                const decoder = new TextDecoder();
                const jsonString = decoder.decode(decompressed);

                if (!jsonString) {
                    throw new Error("Nie udało się zdekompresować danych");
                }

                const quizData = JSON.parse(jsonString);

                if (!DataFormat.validate(quizData)) {
                    throw new Error("Nieprawidłowy format quizu");
                }

                const decoded = DataFormat.decode(quizData);
                const quizzes = Storage.getQuizzes();
                const exists = quizzes.find(q => q.data === decoded.data);

                if (exists) {
                    showToast("Quiz już istnieje w bibliotece!", "info");
                    if (decoded.type === "flashcard") {
                        Navigation.showPreFlashcard(exists.id);
                    } else {
                        Navigation.showPreQuiz(exists.id);
                    }
                } else {
                    const newQuiz = {
                        title: decoded.title,
                        tags: decoded.tags,
                        type: decoded.type,
                        data: decoded.data,
                        id: Utils.generateId(),
                        createdAt: new Date().toISOString()
                    };

                    if (decoded.type === "flashcard") {
                        newQuiz.cards = decoded.cards;
                    } else {
                        newQuiz.questions = decoded.questions;
                    }

                    quizzes.push(newQuiz);
                    
                    if (Storage.saveQuizzes(quizzes)) {
                        showToast("Quiz dodany! 🎉", "success");
                        if (decoded.type === "flashcard") {
                            Navigation.showPreFlashcard(newQuiz.id);
                        } else {
                            Navigation.showPreQuiz(newQuiz.id);
                        }
                    } else {
                        Navigation.showHome();
                    }
                }

                // Clean URL
                history.replaceState(null, null, window.location.pathname);
            } catch (error) {
                showToast("Błąd wczytywania quizu: " + error.message, "error");
                Navigation.showHome();
            }
        }
    };

    // Global sharing function (with cooldown)
    function shareQuiz(quizId) { if (ButtonCooldown.canClick()) Sharing.share(quizId); }
    // ==================== DATA VALIDATION ====================
    function validateAndCleanData() {
        try {
            const quizzes = Storage.getQuizzes();
            const validQuizzes = [];
            let removedCount = 0;

            quizzes.forEach(quiz => {
                if (DataFormat.validate(quiz)) {
                    validQuizzes.push(quiz);
                } else {
                    removedCount++;
                    console.warn("Usunięto nieprawidłowy quiz:", quiz.title || "Bez tytułu");
                }
            });

            if (removedCount > 0) {
                Storage.saveQuizzes(validQuizzes);
                showToast(`Usunięto ${removedCount} nieprawidłowych quizów`, "info");
            }
        } catch (error) {
            console.error("Błąd walidacji danych:", error);
        }
    }

    // ==================== KEYBOARD SUPPORT ====================
    function initKeyboardSupport() {
        document.addEventListener("keydown", (e) => {
            // Escape to close modals
            if (e.key === "Escape") {
                const openModal = document.querySelector(".modal:not(.hidden)");
                if (openModal) {
                    Modal.close(openModal.id);
                }
            }

            // Spacebar to flip flashcard
            if (e.key === " " && !e.target.matches("input, textarea, button")) {
                const flashcardScreen = document.getElementById("flashcardScreen");
                if (!flashcardScreen.classList.contains("hidden")) {
                    e.preventDefault();
                    FlashcardGame.flip();
                }
            }

            // Number keys for flashcard rating
            const flashcardScreen = document.getElementById("flashcardScreen");
            if (!flashcardScreen.classList.contains("hidden") && State.flashcard.isFlipped) {
                if (e.key === "1") FlashcardGame.rate("hard");
                if (e.key === "2") FlashcardGame.rate("medium");
                if (e.key === "3") FlashcardGame.rate("easy");
            }
        });

        // Flashcard keyboard support
        const flashcard = document.getElementById("flashcard");
        if (flashcard) {
            flashcard.addEventListener("keydown", (e) => {
                if (e.key === "Enter" || e.key === " ") {
                    e.preventDefault();
                    FlashcardGame.flip();
                }
            });
        }
    }

    // ==================== INITIALIZATION ====================
    function init() {
        Theme.init();
        validateAndCleanData();
        initKeyboardSupport();
        Sharing.checkSharedQuiz();
    }

    // Start app when DOM is ready
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
    } else {
        init();
    }
    </script>
</body>
</html>
